# Task 09.03: Setup Files - Vitest Setup und MSW Server

## Ziel
Erstellung der zentralen Setup-Dateien für Vitest Tests, MSW Mock Server und Mock Handler.

## Voraussetzungen
- Task 09.01 abgeschlossen (Dependencies installiert)
- Task 09.02 abgeschlossen (Vitest konfiguriert)

## Implementierung

### Schritt 1: Vitest Setup File
Erstelle `vitest.setup.ts` im Root-Verzeichnis:

```typescript
import '@testing-library/jest-dom';
import { expect, afterEach, vi, beforeAll, afterAll } from 'vitest';
import { cleanup } from '@testing-library/react';
import * as matchers from '@testing-library/jest-dom/matchers';
import { server } from './test/mocks/server';

// Extend Vitest matchers mit jest-dom
expect.extend(matchers);

// Setup MSW Server
beforeAll(() => {
  server.listen({ onUnhandledRequest: 'error' });
});

afterEach(() => {
  cleanup();
  server.resetHandlers();
});

afterAll(() => {
  server.close();
});

// Mock Next.js Navigation
vi.mock('next/navigation', () => ({
  useRouter() {
    return {
      push: vi.fn(),
      replace: vi.fn(),
      prefetch: vi.fn(),
      back: vi.fn(),
      forward: vi.fn(),
      refresh: vi.fn(),
    };
  },
  usePathname() {
    return '/';
  },
  useSearchParams() {
    return new URLSearchParams();
  },
  useParams() {
    return {};
  },
}));

// Mock Clerk Authentication
vi.mock('@clerk/nextjs', () => ({
  auth: vi.fn(() => ({
    userId: 'test-user-id',
    sessionId: 'test-session-id',
  })),
  currentUser: vi.fn(() => ({
    id: 'test-user-id',
    emailAddresses: [{ emailAddress: 'test@example.com' }],
  })),
  useAuth: vi.fn(() => ({
    isLoaded: true,
    userId: 'test-user-id',
    sessionId: 'test-session-id',
    isSignedIn: true,
  })),
  useUser: vi.fn(() => ({
    isLoaded: true,
    isSignedIn: true,
    user: {
      id: 'test-user-id',
      emailAddresses: [{ emailAddress: 'test@example.com' }],
    },
  })),
  ClerkProvider: ({ children }: any) => children,
  SignIn: () => null,
  SignUp: () => null,
  UserButton: () => null,
  SignedIn: ({ children }: any) => children,
  SignedOut: ({ children }: any) => null,
}));

// Mock environment variables
process.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/test';
process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY = 'pk_test_123';
process.env.CLERK_SECRET_KEY = 'sk_test_123';

// Global test utilities
global.ResizeObserver = vi.fn().mockImplementation(() => ({
  observe: vi.fn(),
  unobserve: vi.fn(),
  disconnect: vi.fn(),
}));
```

### Schritt 2: MSW Server Setup
Erstelle `test/mocks/server.ts`:

```typescript
import { setupServer } from 'msw/node';
import { handlers } from './handlers';

// Setup Mock Service Worker server
export const server = setupServer(...handlers);

// Provide server instance for test usage
export { rest } from 'msw';
```

### Schritt 3: MSW Handlers
Erstelle `test/mocks/handlers.ts`:

```typescript
import { http, HttpResponse } from 'msw';

export const handlers = [
  // Health check endpoint
  http.get('/api/health', () => {
    return HttpResponse.json({ 
      status: 'ok',
      timestamp: new Date().toISOString()
    });
  }),

  // User endpoints
  http.get('/api/user/me', () => {
    return HttpResponse.json({
      success: true,
      data: {
        id: 'user-1',
        email: 'test@example.com',
        name: 'Test User',
        role: 'USER',
        clerkId: 'clerk_test_123',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
      },
    });
  }),

  http.post('/api/user/create', async ({ request }) => {
    const body = await request.json() as any;
    return HttpResponse.json({
      success: true,
      data: {
        id: 'user-2',
        email: body.email,
        name: body.name,
        role: 'USER',
        clerkId: `clerk_${Date.now()}`,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
      },
    });
  }),

  http.get('/api/user/list', () => {
    return HttpResponse.json({
      success: true,
      data: {
        users: [
          {
            id: 'user-1',
            email: 'test@example.com',
            name: 'Test User',
            role: 'USER',
          },
          {
            id: 'user-2',
            email: 'admin@example.com',
            name: 'Admin User',
            role: 'ADMIN',
          },
        ],
        total: 2,
        page: 1,
        totalPages: 1,
      },
    });
  }),

  // Post endpoints
  http.get('/api/post/list', ({ request }) => {
    const url = new URL(request.url);
    const page = url.searchParams.get('page') || '1';
    
    return HttpResponse.json({
      success: true,
      data: {
        posts: [
          {
            id: 'post-1',
            title: 'Test Post 1',
            slug: 'test-post-1',
            content: 'Test content 1',
            published: true,
            authorId: 'user-1',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
          },
          {
            id: 'post-2',
            title: 'Test Post 2',
            slug: 'test-post-2',
            content: 'Test content 2',
            published: false,
            authorId: 'user-1',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
          },
        ],
        total: 2,
        page: parseInt(page),
        totalPages: 1,
      },
    });
  }),

  http.post('/api/post/create', async ({ request }) => {
    const body = await request.json() as any;
    return HttpResponse.json({
      success: true,
      data: {
        id: `post-${Date.now()}`,
        title: body.title,
        slug: body.title.toLowerCase().replace(/\s+/g, '-'),
        content: body.content,
        published: body.published || false,
        authorId: 'user-1',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
      },
    });
  }),

  http.patch('/api/post/:id', async ({ params, request }) => {
    const { id } = params;
    const body = await request.json() as any;
    
    return HttpResponse.json({
      success: true,
      data: {
        id,
        ...body,
        updatedAt: new Date().toISOString(),
      },
    });
  }),

  http.delete('/api/post/:id', ({ params }) => {
    const { id } = params;
    
    return HttpResponse.json({
      success: true,
      data: {
        id,
        deleted: true,
      },
    });
  }),

  // Comment endpoints
  http.get('/api/comment/list', () => {
    return HttpResponse.json({
      success: true,
      data: {
        comments: [
          {
            id: 'comment-1',
            postId: 'post-1',
            authorId: 'user-2',
            content: 'Great post!',
            createdAt: new Date().toISOString(),
          },
        ],
        total: 1,
      },
    });
  }),

  // Auth endpoints
  http.post('/api/auth/signin', async ({ request }) => {
    const body = await request.json() as any;
    
    if (body.email === 'test@example.com' && body.password === 'password123') {
      return HttpResponse.json({
        success: true,
        data: {
          token: 'test-jwt-token',
          user: {
            id: 'user-1',
            email: 'test@example.com',
            name: 'Test User',
          },
        },
      });
    }
    
    return HttpResponse.json(
      { success: false, error: 'Invalid credentials' },
      { status: 401 }
    );
  }),

  // Catch-all for undefined endpoints
  http.all('*', ({ request }) => {
    console.warn(`Unhandled request: ${request.method} ${request.url}`);
    return HttpResponse.json(
      { error: 'Not found' },
      { status: 404 }
    );
  }),
];
```

### Schritt 4: Browser MSW Setup (Optional)
Für Browser-basierte Tests, generiere den Service Worker:

```bash
npx msw init public/ --save
```

Dann erstelle `test/mocks/browser.ts`:

```typescript
import { setupWorker } from 'msw/browser';
import { handlers } from './handlers';

// Setup Mock Service Worker for browser
export const worker = setupWorker(...handlers);
```

## Verifizierung

### Test 1: Setup File Syntax
```bash
npx tsc --noEmit vitest.setup.ts
# Sollte ohne TypeScript Fehler durchlaufen
```

### Test 2: MSW Server Import
```typescript
// Temporäre Test-Datei
import { server } from './test/mocks/server';
console.log(typeof server.listen); // sollte 'function' sein
```

### Test 3: Handler Test
```bash
# Erstelle simple test datei
echo "import { handlers } from './test/mocks/handlers';
console.log('Handlers:', handlers.length);" > test-handlers.mjs

node test-handlers.mjs
# Sollte Anzahl der Handler ausgeben
```

## Erfolgskriterien
- [ ] vitest.setup.ts erstellt mit allen Imports
- [ ] MSW Server konfiguriert und exportiert
- [ ] Alle API Handler definiert (health, user, post, comment, auth)
- [ ] Next.js Navigation Mocks implementiert
- [ ] Clerk Authentication Mocks implementiert
- [ ] Environment Variables gemockt
- [ ] Global Test Utilities (ResizeObserver) gemockt
- [ ] Jest-DOM Matchers extended
- [ ] Cleanup nach jedem Test konfiguriert

## Wichtige Hinweise

### MSW Version
- MSW v2 verwendet `http` und `HttpResponse` statt `rest` und `res`
- Import-Syntax hat sich geändert von v1 zu v2

### Mock Consistency
- Mock-Daten sollten konsistent mit echten API Responses sein
- IDs und Timestamps sollten realistisch aussehen

### Handler Organization
- Handler nach Features gruppieren
- Catch-all Handler am Ende für undefined Routes

## Potentielle Probleme

### Problem: "Cannot find module 'msw/node'"
**Lösung**: MSW korrekt installieren
```bash
npm install -D msw
```

### Problem: TypeScript Fehler bei Mocks
**Lösung**: Type Assertions verwenden
```typescript
const body = await request.json() as any;
```

### Problem: "ResizeObserver is not defined"
**Lösung**: Global Mock ist bereits im Setup enthalten

### Problem: Clerk Mock funktioniert nicht
**Lösung**: Mock vor Component Import laden
```typescript
// In Test-Datei
import './vitest.setup'; // First
import { Component } from './Component'; // Second
```

## Rollback Plan
Falls Setup Probleme macht:
```bash
# Deaktiviere MSW temporär
# Kommentiere server.listen() in vitest.setup.ts aus
```

## Zeitschätzung
- Setup File erstellen: 8 Minuten
- MSW Server Setup: 5 Minuten
- Handler implementieren: 10 Minuten
- Verifizierung: 3 Minuten
- **Total: 26 Minuten**

## Nächster Schritt
Nach erfolgreicher Setup-Erstellung → [09.04 Test Utilities](./09.04-test-utilities.md)