# 02.03 - Singleton Verifizierung

## Ziel
Sicherstellen dass nur eine einzige PrismaClient Instanz existiert.

## Voraussetzungen
- [ ] Schritt 02.02 abgeschlossen
- [ ] Singleton Pattern implementiert

## Test 1: Singleton Unit Test

### 1. Erstelle Test-Datei
Erstelle `packages/db/singleton.test.ts`:

```typescript
import { describe, it, expect } from 'vitest';

describe('PrismaClient Singleton', () => {
  it('should return the same instance when imported multiple times', async () => {
    // Importiere db mehrfach
    const { db: db1 } = await import('./index');
    const { db: db2 } = await import('./index');
    
    // Beide sollten die gleiche Instanz sein
    expect(db1).toBe(db2);
  });

  it('should have PrismaClient methods', async () => {
    const { db } = await import('./index');
    
    // Prüfe ob es ein PrismaClient ist
    expect(db).toHaveProperty('$connect');
    expect(db).toHaveProperty('$disconnect');
    expect(db).toHaveProperty('$queryRaw');
  });
});
```

### 2. Führe Test aus
```bash
cd packages/db
npm test singleton.test.ts
```

**Erwartung:** Beide Tests sollten grün sein ✅

## Test 2: Multiple Import Test

### 1. Erstelle Quick-Test Script
Erstelle `packages/db/test-singleton.js`:

```javascript
// Test ob mehrfache imports die gleiche Instanz zurückgeben
const { db: db1 } = require('./index');

// Clear require cache um "fresh" import zu simulieren
delete require.cache[require.resolve('./index')];
const { db: db2 } = require('./index');

// In Development sollten beide gleich sein (wegen globalThis)
if (process.env.NODE_ENV !== 'production') {
  console.log('Singleton Test:', db1 === db2 ? '✅ PASS' : '❌ FAIL');
  console.log('Instance 1:', db1.constructor.name);
  console.log('Instance 2:', db2.constructor.name);
} else {
  console.log('Production mode - neue Instanzen sind OK');
}
```

### 2. Führe Script aus
```bash
cd packages/db
NODE_ENV=development node test-singleton.js
```

**Erwartung:**
```
Singleton Test: ✅ PASS
Instance 1: PrismaClient
Instance 2: PrismaClient
```

## Test 3: TypeScript Type Export Test

### 1. Prüfe Type Exports
Erstelle `packages/db/test-types.ts`:

```typescript
import { db, Prisma } from './index';
import type { User, Post } from './index';

// Test: db ist PrismaClient
const testConnection = async () => {
  // Diese sollten ohne TypeScript Fehler funktionieren
  const result: Prisma.BatchPayload = { count: 0 };
  
  // Wenn User Model existiert (aus schema.prisma)
  // const users: User[] = [];
  
  console.log('✅ Type exports funktionieren');
};

testConnection();
```

### 2. Compile mit TypeScript
```bash
cd packages/db
npx tsc --noEmit test-types.ts
```

**Erwartung:** Keine TypeScript Fehler

## Test 4: Memory Test (Optional)

### 1. Erstelle Memory Test
Erstelle `packages/db/test-memory.js`:

```javascript
const { db } = require('./index');

// Zeige Memory Usage
console.log('Initial Memory:', process.memoryUsage().heapUsed / 1024 / 1024, 'MB');

// Importiere 100 mal
for (let i = 0; i < 100; i++) {
  delete require.cache[require.resolve('./index')];
  const { db: dbNew } = require('./index');
}

// Zeige Memory nach 100 imports
console.log('After 100 imports:', process.memoryUsage().heapUsed / 1024 / 1024, 'MB');

// In Development sollte Memory stabil bleiben
```

### 2. Führe Memory Test aus
```bash
NODE_ENV=development node test-memory.js
```

**Erwartung:** Memory sollte nicht signifikant ansteigen

## Debugging bei Fehlern

### Problem: Tests schlagen fehl
```bash
# Prüfe ob globalThis funktioniert
node -e "console.log(typeof globalThis)"
# Output sollte sein: object
```

### Problem: TypeScript Fehler
```bash
# Stelle sicher dass @types/node installiert ist
npm list @types/node
```

### Problem: PrismaClient nicht gefunden
```bash
# Regeneriere Prisma Client
npx prisma generate
```

## Checkliste
- [ ] Singleton Test erstellt und grün
- [ ] Multiple Import Test erfolgreich
- [ ] TypeScript Types werden korrekt exportiert
- [ ] Memory bleibt stabil (optional)

## Nächster Schritt
→ [02.04 - Connection Test](./02.04-connection-test.md)

## Cleanup
```bash
# Lösche Test-Dateien nach erfolgreichem Test
rm test-singleton.js test-types.ts test-memory.js singleton.test.ts
```