# Sub-Task 06.06: REST Bridge zu oRPC (Optional)

## Ziel
REST API Wrapper für externe Clients die kein oRPC nutzen können, mit OpenAPI Spec Generation.

## Kontext
- oRPC hat keine native OpenAPI/Swagger Support
- Externe Clients benötigen REST API
- Dual API Strategy: oRPC intern, REST extern

## Datei 1: REST API Route Handler
`app/api/v1/[...path]/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { router } from '@starter-kit/api';
import { handleAPIError } from '@starter-kit/api/error-handler';
import { z } from 'zod';

// Map REST methods to oRPC procedures
const methodMap = {
  GET: 'query',
  POST: 'mutate',
  PUT: 'mutate',
  PATCH: 'mutate',
  DELETE: 'mutate',
} as const;

// REST to oRPC route mapping
const routeMap: Record<string, { procedure: string; method: string }> = {
  // Users
  'GET /users': { procedure: 'user.list', method: 'query' },
  'GET /users/me': { procedure: 'user.me', method: 'query' },
  'GET /users/:id': { procedure: 'user.getById', method: 'query' },
  'POST /users': { procedure: 'user.create', method: 'mutate' },
  'PATCH /users/:id': { procedure: 'user.update', method: 'mutate' },
  'DELETE /users/:id': { procedure: 'user.delete', method: 'mutate' },
  
  // Health
  'GET /health': { procedure: 'health', method: 'query' },
};

function matchRoute(method: string, path: string[]) {
  const pathString = '/' + path.join('/');
  
  // Try exact match first
  const routeKey = `${method} ${pathString}`;
  if (routeMap[routeKey]) {
    return { ...routeMap[routeKey], params: {} };
  }
  
  // Try pattern matching with params
  for (const [pattern, config] of Object.entries(routeMap)) {
    const [routeMethod, routePath] = pattern.split(' ');
    if (routeMethod !== method) continue;
    
    const regex = routePath.replace(/:(\w+)/g, '(?<$1>[^/]+)');
    const match = pathString.match(new RegExp(`^${regex}$`));
    
    if (match && match.groups) {
      return { ...config, params: match.groups };
    }
  }
  
  return null;
}

async function handleRequest(
  req: NextRequest,
  { params }: { params: { path: string[] } }
) {
  try {
    const method = req.method;
    const route = matchRoute(method, params.path);
    
    if (!route) {
      return NextResponse.json(
        { error: 'Route not found' },
        { status: 404 }
      );
    }
    
    // Parse request body for POST/PUT/PATCH
    let input = { ...route.params };
    
    if (['POST', 'PUT', 'PATCH'].includes(method)) {
      const body = await req.json().catch(() => ({}));
      input = { ...input, ...body };
    }
    
    // Add query params for GET requests
    if (method === 'GET') {
      const searchParams = req.nextUrl.searchParams;
      searchParams.forEach((value, key) => {
        // Try to parse numbers
        const numValue = Number(value);
        input[key] = isNaN(numValue) ? value : numValue;
      });
    }
    
    // Execute oRPC procedure
    const procedurePath = route.procedure.split('.');
    let procedure: any = router;
    
    for (const segment of procedurePath) {
      procedure = procedure[segment];
      if (!procedure) {
        throw new Error(`Procedure ${route.procedure} not found`);
      }
    }
    
    // Call the procedure
    const result = await procedure({ input });
    
    // Return response
    return NextResponse.json(result, { status: 200 });
    
  } catch (error) {
    const apiError = handleAPIError(error);
    
    return NextResponse.json(
      {
        error: {
          code: apiError.code,
          message: apiError.message,
          details: apiError.data,
        },
      },
      { status: apiError.status || 500 }
    );
  }
}

export const GET = handleRequest;
export const POST = handleRequest;
export const PUT = handleRequest;
export const PATCH = handleRequest;
export const DELETE = handleRequest;
```

## Datei 2: OpenAPI Schema Generator
`tools/generate-openapi.ts`

```typescript
import { zodToJsonSchema } from 'zod-to-json-schema';
import { 
  userSchema, 
  createUserSchema, 
  updateUserSchema,
  userFiltersSchema 
} from '@starter-kit/api/schemas/user';
import { paginationSchema } from '@starter-kit/api/schemas/base';
import fs from 'fs';
import path from 'path';

const openApiSpec = {
  openapi: '3.0.0',
  info: {
    title: 'Starter Kit API',
    version: '1.0.0',
    description: 'REST API for Starter Kit Application',
  },
  servers: [
    {
      url: 'http://localhost:3004/api/v1',
      description: 'Development server',
    },
    {
      url: 'https://api.example.com/v1',
      description: 'Production server',
    },
  ],
  paths: {
    '/health': {
      get: {
        summary: 'Health check',
        tags: ['System'],
        responses: {
          200: {
            description: 'Service is healthy',
            content: {
              'application/json': {
                schema: {
                  type: 'object',
                  properties: {
                    success: { type: 'boolean', example: true },
                    data: {
                      type: 'object',
                      properties: {
                        status: { type: 'string', example: 'ok' },
                      },
                    },
                  },
                },
              },
            },
          },
        },
      },
    },
    '/users': {
      get: {
        summary: 'List users',
        tags: ['Users'],
        security: [{ bearerAuth: [] }],
        parameters: [
          {
            name: 'page',
            in: 'query',
            schema: { type: 'integer', minimum: 1, default: 1 },
            description: 'Page number',
          },
          {
            name: 'limit',
            in: 'query',
            schema: { type: 'integer', minimum: 1, maximum: 100, default: 10 },
            description: 'Items per page',
          },
          {
            name: 'search',
            in: 'query',
            schema: { type: 'string' },
            description: 'Search term',
          },
          {
            name: 'role',
            in: 'query',
            schema: { type: 'string', enum: ['user', 'admin'] },
            description: 'Filter by role',
          },
        ],
        responses: {
          200: {
            description: 'List of users',
            content: {
              'application/json': {
                schema: {
                  type: 'object',
                  properties: {
                    success: { type: 'boolean' },
                    data: {
                      type: 'object',
                      properties: {
                        users: {
                          type: 'array',
                          items: zodToJsonSchema(userSchema),
                        },
                        total: { type: 'integer' },
                        page: { type: 'integer' },
                        totalPages: { type: 'integer' },
                      },
                    },
                  },
                },
              },
            },
          },
          401: {
            $ref: '#/components/responses/Unauthorized',
          },
          403: {
            $ref: '#/components/responses/Forbidden',
          },
        },
      },
      post: {
        summary: 'Create user',
        tags: ['Users'],
        requestBody: {
          required: true,
          content: {
            'application/json': {
              schema: zodToJsonSchema(createUserSchema),
            },
          },
        },
        responses: {
          201: {
            description: 'User created',
            content: {
              'application/json': {
                schema: {
                  type: 'object',
                  properties: {
                    success: { type: 'boolean' },
                    data: zodToJsonSchema(userSchema),
                  },
                },
              },
            },
          },
          400: {
            $ref: '#/components/responses/BadRequest',
          },
          409: {
            $ref: '#/components/responses/Conflict',
          },
        },
      },
    },
    '/users/me': {
      get: {
        summary: 'Get current user',
        tags: ['Users'],
        security: [{ bearerAuth: [] }],
        responses: {
          200: {
            description: 'Current user',
            content: {
              'application/json': {
                schema: {
                  type: 'object',
                  properties: {
                    success: { type: 'boolean' },
                    data: zodToJsonSchema(userSchema),
                  },
                },
              },
            },
          },
          401: {
            $ref: '#/components/responses/Unauthorized',
          },
        },
      },
    },
    '/users/{id}': {
      get: {
        summary: 'Get user by ID',
        tags: ['Users'],
        security: [{ bearerAuth: [] }],
        parameters: [
          {
            name: 'id',
            in: 'path',
            required: true,
            schema: { type: 'string', format: 'uuid' },
            description: 'User ID',
          },
        ],
        responses: {
          200: {
            description: 'User details',
            content: {
              'application/json': {
                schema: {
                  type: 'object',
                  properties: {
                    success: { type: 'boolean' },
                    data: zodToJsonSchema(userSchema),
                  },
                },
              },
            },
          },
          404: {
            $ref: '#/components/responses/NotFound',
          },
        },
      },
      patch: {
        summary: 'Update user',
        tags: ['Users'],
        security: [{ bearerAuth: [] }],
        parameters: [
          {
            name: 'id',
            in: 'path',
            required: true,
            schema: { type: 'string', format: 'uuid' },
            description: 'User ID',
          },
        ],
        requestBody: {
          required: true,
          content: {
            'application/json': {
              schema: zodToJsonSchema(updateUserSchema),
            },
          },
        },
        responses: {
          200: {
            description: 'User updated',
            content: {
              'application/json': {
                schema: {
                  type: 'object',
                  properties: {
                    success: { type: 'boolean' },
                    data: zodToJsonSchema(userSchema),
                  },
                },
              },
            },
          },
          400: {
            $ref: '#/components/responses/BadRequest',
          },
          404: {
            $ref: '#/components/responses/NotFound',
          },
        },
      },
      delete: {
        summary: 'Delete user',
        tags: ['Users'],
        security: [{ bearerAuth: [] }],
        parameters: [
          {
            name: 'id',
            in: 'path',
            required: true,
            schema: { type: 'string', format: 'uuid' },
            description: 'User ID',
          },
        ],
        responses: {
          200: {
            description: 'User deleted',
            content: {
              'application/json': {
                schema: {
                  type: 'object',
                  properties: {
                    success: { type: 'boolean' },
                    data: {
                      type: 'object',
                      properties: {
                        deleted: { type: 'boolean' },
                      },
                    },
                  },
                },
              },
            },
          },
          404: {
            $ref: '#/components/responses/NotFound',
          },
        },
      },
    },
  },
  components: {
    securitySchemes: {
      bearerAuth: {
        type: 'http',
        scheme: 'bearer',
        bearerFormat: 'JWT',
      },
    },
    responses: {
      BadRequest: {
        description: 'Bad request',
        content: {
          'application/json': {
            schema: {
              $ref: '#/components/schemas/Error',
            },
          },
        },
      },
      Unauthorized: {
        description: 'Unauthorized',
        content: {
          'application/json': {
            schema: {
              $ref: '#/components/schemas/Error',
            },
          },
        },
      },
      Forbidden: {
        description: 'Forbidden',
        content: {
          'application/json': {
            schema: {
              $ref: '#/components/schemas/Error',
            },
          },
        },
      },
      NotFound: {
        description: 'Not found',
        content: {
          'application/json': {
            schema: {
              $ref: '#/components/schemas/Error',
            },
          },
        },
      },
      Conflict: {
        description: 'Conflict',
        content: {
          'application/json': {
            schema: {
              $ref: '#/components/schemas/Error',
            },
          },
        },
      },
    },
    schemas: {
      Error: {
        type: 'object',
        properties: {
          error: {
            type: 'object',
            properties: {
              code: { type: 'string' },
              message: { type: 'string' },
              details: { type: 'object' },
            },
          },
        },
      },
    },
  },
};

// Generate OpenAPI JSON
const outputPath = path.join(process.cwd(), 'public', 'openapi.json');
fs.writeFileSync(outputPath, JSON.stringify(openApiSpec, null, 2));
console.log(`OpenAPI spec generated at: ${outputPath}`);

// Generate TypeScript client (optional)
// npx openapi-typescript public/openapi.json --output src/types/api.ts
```

## Datei 3: Swagger UI Integration
`app/api-docs/page.tsx`

```tsx
'use client';

import SwaggerUI from 'swagger-ui-react';
import 'swagger-ui-react/swagger-ui.css';

export default function ApiDocsPage() {
  return (
    <div className="min-h-screen">
      <SwaggerUI url="/openapi.json" />
    </div>
  );
}
```

## Package.json Scripts

```json
{
  "scripts": {
    "generate:openapi": "tsx tools/generate-openapi.ts",
    "generate:api-client": "openapi-typescript public/openapi.json --output src/types/api.ts"
  }
}
```

## External Client Examples

### JavaScript/Fetch
```javascript
// External client using REST API
const API_URL = 'https://api.example.com/v1';

async function getUsers(token) {
  const response = await fetch(`${API_URL}/users`, {
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
    },
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error.message);
  }
  
  const result = await response.json();
  return result.data;
}
```

### Python Client
```python
import requests

class StarterKitAPI:
    def __init__(self, base_url, token=None):
        self.base_url = base_url
        self.headers = {
            'Content-Type': 'application/json'
        }
        if token:
            self.headers['Authorization'] = f'Bearer {token}'
    
    def get_users(self, page=1, limit=10):
        response = requests.get(
            f'{self.base_url}/users',
            params={'page': page, 'limit': limit},
            headers=self.headers
        )
        response.raise_for_status()
        return response.json()['data']
    
    def create_user(self, email, name, password):
        response = requests.post(
            f'{self.base_url}/users',
            json={'email': email, 'name': name, 'password': password},
            headers=self.headers
        )
        response.raise_for_status()
        return response.json()['data']

# Usage
api = StarterKitAPI('https://api.example.com/v1', token='...')
users = api.get_users()
```

### cURL Examples
```bash
# Get users
curl -H "Authorization: Bearer TOKEN" \
     https://api.example.com/v1/users

# Create user
curl -X POST \
     -H "Content-Type: application/json" \
     -d '{"email":"test@example.com","name":"Test","password":"Pass123!"}' \
     https://api.example.com/v1/users

# Update user
curl -X PATCH \
     -H "Authorization: Bearer TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"name":"Updated Name"}' \
     https://api.example.com/v1/users/USER_ID
```

## Vorteile
- REST API für externe Clients
- OpenAPI/Swagger Documentation
- Auto-generated TypeScript Types
- Multiple Client Language Support
- Swagger UI für Testing

## Erfolgskriterien
- [ ] REST Routes mapped zu oRPC
- [ ] OpenAPI Spec generiert
- [ ] Swagger UI verfügbar
- [ ] Error Handling konsistent
- [ ] Authentication funktioniert
- [ ] Client Examples bereitgestellt

## Geschätzte Zeit
30 Minuten (optional - nur wenn externe API benötigt)