# Teilaufgabe 05.01: Clerk Dashboard Konfiguration

## Ziel
Konfiguration von Session Token Claims und User Metadata im Clerk Dashboard für Role-Based Access Control (RBAC).

## Zeitschätzung
10 Minuten

## Vorbedingungen
- [ ] Zugang zum Clerk Dashboard
- [ ] Admin-Rechte im Clerk Account
- [ ] Mindestens ein Test-User vorhanden

## Implementierung

### Schritt 1: Session Token Setup

1. Navigiere zu [Clerk Dashboard > Sessions](https://dashboard.clerk.com/last-active?path=sessions)
2. Gehe zu **Customize session token** > **Claims**
3. Füge folgendes JSON hinzu:

```json
{
  "metadata": "{{user.public_metadata}}"
}
```

4. Klicke auf **Save**
5. Warte 1-2 Minuten bis die Änderungen aktiv sind

### Schritt 2: User Metadata Setup

1. Navigiere zu [Clerk Dashboard > Users](https://dashboard.clerk.com/last-active?path=users)
2. Wähle deinen Test-User Account
3. Klicke auf **User metadata** > **Public metadata** > **Edit**
4. Füge folgende Struktur hinzu:

```json
{
  "role": "admin",
  "permissions": []
}
```

5. Klicke auf **Save**

### Schritt 3: Zusätzliche User Roles erstellen (Optional)

Für weitere Test-User kannst du verschiedene Rollen vergeben:

**Regular User:**
```json
{
  "role": "user",
  "permissions": []
}
```

**Moderator:**
```json
{
  "role": "moderator",
  "permissions": ["comment:moderate", "post:view", "post:update"]
}
```

**Admin mit spezifischen Permissions:**
```json
{
  "role": "admin",
  "permissions": ["admin:access", "admin:settings", "admin:analytics"]
}
```

## Verifizierung

### Test 1: Session Token Verifizierung
1. Melde dich in der App neu an (wichtig für Token-Refresh)
2. Öffne Browser DevTools > Application > Cookies
3. Finde den `__session` Cookie
4. Dekodiere den JWT Token auf [jwt.io](https://jwt.io)
5. Verifiziere dass `metadata` im Token vorhanden ist

### Test 2: API Verifizierung
```bash
# Teste ob Metadata in der Session verfügbar ist
curl http://localhost:3004/api/auth/session
```

Erwartete Response sollte enthalten:
```json
{
  "sessionClaims": {
    "metadata": {
      "role": "admin",
      "permissions": []
    }
  }
}
```

## Erfolgskriterien
- [ ] Session Token Claims konfiguriert
- [ ] User Metadata für mindestens einen User gesetzt
- [ ] Token enthält Metadata nach Neu-Anmeldung
- [ ] Metadata ist in der App abrufbar

## Troubleshooting

### Problem: Metadata erscheint nicht im Token
**Lösung:**
1. Cache leeren und Cookies löschen
2. Komplett ausloggen und neu einloggen
3. Warte 2-3 Minuten nach Änderungen im Dashboard

### Problem: Session Claims sind undefined
**Lösung:**
1. Prüfe ob die Syntax im Clerk Dashboard korrekt ist
2. Stelle sicher dass `{{user.public_metadata}}` verwendet wird
3. Prüfe ob der User tatsächlich public_metadata hat

### Problem: Änderungen werden nicht übernommen
**Lösung:**
1. Hard Refresh im Browser (Cmd+Shift+R)
2. Clerk Dashboard Cache: Warte 5 Minuten
3. Notfalls: Erstelle einen neuen User zum Testen

## Nächster Schritt
Nach erfolgreicher Konfiguration → [05.02-typescript-definitions.md](./05.02-typescript-definitions.md)