# Task 09.09.3: E2E Tests - Dashboard und Navigation

## Ziel
Verifizieren, dass das Dashboard nach dem Login korrekt angezeigt wird und die Navigation funktioniert. Testen von Layout, User-Daten, Quick Actions und Sidebar-Navigation.

## Voraussetzungen
- Task 09.09.2 abgeschlossen (Authentication Tests)
- Authenticated State Setup verfügbar
- Dashboard Komponenten implementiert

## Implementierung

### Schritt 1: Dashboard Layout Tests
Erstelle `e2e/dashboard-layout.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { DashboardPage, TestHelpers } from './helpers/test-helpers';

test.describe('Dashboard Layout', () => {
  test.use({ storageState: 'playwright/.auth/user.json' });
  
  let dashboard: DashboardPage;
  let helpers: TestHelpers;

  test.beforeEach(async ({ page }) => {
    dashboard = new DashboardPage(page);
    helpers = new TestHelpers(page);
    await page.goto('/dashboard');
  });

  test('displays dashboard overview', async ({ page }) => {
    // Check main heading
    await expect(page.locator('h1')).toContainText(/Dashboard|Overview|Welcome/);
    
    // Check user greeting if present
    const greeting = page.locator('[data-testid="user-greeting"]');
    if (await greeting.isVisible()) {
      await expect(greeting).toContainText(/Hello|Welcome|Hi/);
    }
    
    // Verify main layout sections
    await expect(page.locator('[data-testid="sidebar"], nav')).toBeVisible();
    await expect(page.locator('main, [data-testid="main-content"]')).toBeVisible();
  });

  test('displays stats cards', async ({ page }) => {
    const statsSection = page.locator('[data-testid="stats"], [data-testid="metrics"]');
    
    if (await statsSection.isVisible()) {
      // Check for stat cards
      const statCards = statsSection.locator('[data-testid="stat-card"]');
      const cardCount = await statCards.count();
      
      expect(cardCount).toBeGreaterThan(0);
      
      // Each card should have title and value
      for (let i = 0; i < cardCount; i++) {
        const card = statCards.nth(i);
        await expect(card.locator('[data-testid="stat-title"]')).toBeVisible();
        await expect(card.locator('[data-testid="stat-value"]')).toBeVisible();
      }
    }
  });

  test('displays recent activity', async ({ page }) => {
    const activitySection = page.locator('[data-testid="recent-activity"], [data-testid="activity-feed"]');
    
    if (await activitySection.isVisible()) {
      // Should have activity items or empty state
      const activityItems = activitySection.locator('[data-testid="activity-item"]');
      const emptyState = activitySection.locator('[data-testid="empty-state"]');
      
      const hasActivity = await activityItems.count() > 0;
      const hasEmptyState = await emptyState.isVisible().catch(() => false);
      
      expect(hasActivity || hasEmptyState).toBeTruthy();
      
      // If has activity, check structure
      if (hasActivity) {
        const firstItem = activityItems.first();
        await expect(firstItem).toBeVisible();
        
        // Activity items should have timestamp
        const timestamp = firstItem.locator('[data-testid="activity-time"]');
        if (await timestamp.isVisible()) {
          const timeText = await timestamp.textContent();
          expect(timeText).toBeTruthy();
        }
      }
    }
  });

  test('responsive layout on mobile', async ({ page }) => {
    // Set mobile viewport
    await page.setViewportSize({ width: 375, height: 812 });
    
    // Sidebar should be hidden or collapsible
    const sidebar = page.locator('[data-testid="sidebar"]');
    const isSidebarVisible = await sidebar.isVisible();
    
    if (isSidebarVisible) {
      // Should have hamburger menu
      const menuButton = page.locator('[aria-label="Menu"], [data-testid="menu-toggle"]');
      await expect(menuButton).toBeVisible();
      
      // Test toggle
      await menuButton.click();
      await page.waitForTimeout(300); // Wait for animation
      
      // Sidebar state should change
      const sidebarAfterClick = await sidebar.isVisible();
      expect(sidebarAfterClick).toBe(!isSidebarVisible);
    }
  });
});
```

### Schritt 2: Navigation Tests
Erstelle `e2e/dashboard-navigation.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { DashboardPage, TestHelpers } from './helpers/test-helpers';

test.describe('Dashboard Navigation', () => {
  test.use({ storageState: 'playwright/.auth/user.json' });
  
  let dashboard: DashboardPage;
  let helpers: TestHelpers;

  test.beforeEach(async ({ page }) => {
    dashboard = new DashboardPage(page);
    helpers = new TestHelpers(page);
    await page.goto('/dashboard');
  });

  test('sidebar navigation links', async ({ page }) => {
    const sidebar = page.locator('[data-testid="sidebar"], nav');
    
    // Define expected navigation items
    const navItems = [
      { label: 'Dashboard', href: '/dashboard', icon: true },
      { label: 'Posts', href: '/posts', icon: true },
      { label: 'Comments', href: '/comments', icon: true },
      { label: 'Analytics', href: '/analytics', icon: true },
      { label: 'Settings', href: '/settings', icon: true },
    ];
    
    for (const item of navItems) {
      const link = sidebar.locator(`a:has-text("${item.label}")`);
      
      if (await link.isVisible()) {
        // Check href
        await expect(link).toHaveAttribute('href', item.href);
        
        // Check for icon if expected
        if (item.icon) {
          const icon = link.locator('svg, [data-testid="icon"]');
          await expect(icon).toBeVisible();
        }
        
        // Test navigation
        await link.click();
        await expect(page).toHaveURL(item.href);
        
        // Navigate back for next test
        await page.goto('/dashboard');
      }
    }
  });

  test('breadcrumb navigation', async ({ page }) => {
    // Navigate to nested page
    await page.goto('/posts/new');
    
    const breadcrumbs = page.locator('[data-testid="breadcrumbs"], nav[aria-label="Breadcrumb"]');
    
    if (await breadcrumbs.isVisible()) {
      // Should have home/dashboard link
      const homeLink = breadcrumbs.locator('a').first();
      await expect(homeLink).toBeVisible();
      
      // Click home breadcrumb
      await homeLink.click();
      await expect(page).toHaveURL('/dashboard');
    }
  });

  test('user menu navigation', async ({ page }) => {
    const userMenu = page.locator('[data-testid="user-menu"], [aria-label="User menu"]');
    await userMenu.click();
    
    // Check menu items
    const menuItems = [
      { label: 'Profile', href: '/profile' },
      { label: 'Settings', href: '/settings' },
      { label: 'Billing', href: '/billing' },
    ];
    
    for (const item of menuItems) {
      const menuLink = page.locator(`a:has-text("${item.label}")`);
      
      if (await menuLink.isVisible()) {
        await menuLink.click();
        await expect(page).toHaveURL(new RegExp(item.href));
        
        // Go back and reopen menu for next item
        await page.goto('/dashboard');
        await userMenu.click();
      }
    }
  });

  test('keyboard navigation', async ({ page }) => {
    // Focus first navigation item
    await page.keyboard.press('Tab');
    await page.keyboard.press('Tab'); // Skip skip-to-content if present
    
    // Get focused element
    const focusedElement = await page.evaluate(() => {
      const el = document.activeElement;
      return {
        tagName: el?.tagName,
        text: el?.textContent,
        href: el?.getAttribute('href')
      };
    });
    
    // Should focus navigation link
    expect(focusedElement.tagName).toBe('A');
    expect(focusedElement.href).toBeTruthy();
    
    // Navigate with Enter key
    await page.keyboard.press('Enter');
    
    // Should navigate to focused link
    await page.waitForLoadState('networkidle');
    const newUrl = page.url();
    expect(newUrl).toContain(focusedElement.href);
  });

  test('active state indicators', async ({ page }) => {
    // Check dashboard link is active
    const dashboardLink = page.locator('a[href="/dashboard"]').first();
    
    // Should have active class or aria-current
    const isActive = await dashboardLink.evaluate(el => {
      return el.classList.contains('active') || 
             el.getAttribute('aria-current') === 'page' ||
             el.classList.contains('bg-primary') ||
             el.classList.contains('text-primary');
    });
    
    expect(isActive).toBeTruthy();
    
    // Navigate to different page
    await page.goto('/posts');
    
    // Posts link should now be active
    const postsLink = page.locator('a[href="/posts"]').first();
    const postsActive = await postsLink.evaluate(el => {
      return el.classList.contains('active') || 
             el.getAttribute('aria-current') === 'page';
    });
    
    expect(postsActive).toBeTruthy();
  });
});
```

### Schritt 3: Quick Actions Tests
Erstelle `e2e/dashboard-quick-actions.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { DashboardPage, TestHelpers } from './helpers/test-helpers';

test.describe('Dashboard Quick Actions', () => {
  test.use({ storageState: 'playwright/.auth/user.json' });
  
  let dashboard: DashboardPage;
  let helpers: TestHelpers;

  test.beforeEach(async ({ page }) => {
    dashboard = new DashboardPage(page);
    helpers = new TestHelpers(page);
    await page.goto('/dashboard');
  });

  test('create new post quick action', async ({ page }) => {
    const newPostButton = page.locator(
      'button:has-text("New Post"), ' +
      'a:has-text("New Post"), ' +
      'button:has-text("Create Post")'
    ).first();
    
    if (await newPostButton.isVisible()) {
      await newPostButton.click();
      
      // Should navigate to new post page
      await expect(page).toHaveURL(/\/posts\/(new|create)/);
      
      // Should show post form
      await expect(page.locator('[name="title"], input[placeholder*="Title"]')).toBeVisible();
    }
  });

  test('quick stats navigation', async ({ page }) => {
    const statsCards = page.locator('[data-testid="stat-card"]');
    const firstCard = statsCards.first();
    
    if (await firstCard.isVisible()) {
      // Check if clickable
      const isClickable = await firstCard.evaluate(el => {
        return el.tagName === 'A' || 
               el.style.cursor === 'pointer' ||
               el.onclick !== null;
      });
      
      if (isClickable) {
        await firstCard.click();
        
        // Should navigate to detailed view
        await expect(page).not.toHaveURL('/dashboard');
      }
    }
  });

  test('quick search functionality', async ({ page }) => {
    const searchInput = page.locator(
      '[placeholder*="Search"], ' +
      '[aria-label*="Search"], ' +
      'input[type="search"]'
    ).first();
    
    if (await searchInput.isVisible()) {
      // Type search query
      await searchInput.fill('test query');
      await searchInput.press('Enter');
      
      // Should show results or navigate to search page
      await page.waitForLoadState('networkidle');
      
      const hasResults = 
        await page.locator('[data-testid="search-results"]').isVisible() ||
        page.url().includes('search') ||
        page.url().includes('q=');
      
      expect(hasResults).toBeTruthy();
    }
  });

  test('shortcuts panel', async ({ page }) => {
    const shortcutsPanel = page.locator('[data-testid="shortcuts"], [data-testid="quick-links"]');
    
    if (await shortcutsPanel.isVisible()) {
      const shortcuts = shortcutsPanel.locator('a, button');
      const shortcutCount = await shortcuts.count();
      
      expect(shortcutCount).toBeGreaterThan(0);
      
      // Test first shortcut
      const firstShortcut = shortcuts.first();
      const shortcutText = await firstShortcut.textContent();
      
      await firstShortcut.click();
      
      // Should navigate away from dashboard
      await page.waitForLoadState('networkidle');
      expect(page.url()).not.toBe(page.url() + '/dashboard');
    }
  });

  test('command palette', async ({ page }) => {
    // Try to open command palette with keyboard shortcut
    await page.keyboard.press('Control+K');
    // Also try Cmd+K for Mac
    await page.keyboard.press('Meta+K');
    
    // Check if command palette opened
    const commandPalette = page.locator(
      '[role="dialog"][aria-label*="Command"], ' +
      '[data-testid="command-palette"]'
    );
    
    if (await commandPalette.isVisible({ timeout: 1000 }).catch(() => false)) {
      // Type a command
      await page.keyboard.type('new post');
      
      // Check for suggestions
      const suggestions = commandPalette.locator('[role="option"]');
      await expect(suggestions.first()).toBeVisible();
      
      // Select first suggestion
      await page.keyboard.press('Enter');
      
      // Should navigate or perform action
      await page.waitForLoadState('networkidle');
    }
  });
});
```

### Schritt 4: Notifications Tests
Erstelle `e2e/dashboard-notifications.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { DashboardPage, TestHelpers } from './helpers/test-helpers';

test.describe('Dashboard Notifications', () => {
  test.use({ storageState: 'playwright/.auth/user.json' });
  
  let dashboard: DashboardPage;
  let helpers: TestHelpers;

  test.beforeEach(async ({ page }) => {
    dashboard = new DashboardPage(page);
    helpers = new TestHelpers(page);
    await page.goto('/dashboard');
  });

  test('notifications panel', async ({ page }) => {
    const notificationButton = page.locator(
      '[aria-label*="Notification"], ' +
      '[data-testid="notifications-button"], ' +
      'button:has-text("Notifications")'
    ).first();
    
    if (await notificationButton.isVisible()) {
      // Check for unread indicator
      const badge = notificationButton.locator('[data-testid="badge"], .badge');
      const hasUnread = await badge.isVisible();
      
      // Open notifications
      await notificationButton.click();
      
      // Panel should be visible
      const panel = page.locator(
        '[role="dialog"], ' +
        '[data-testid="notifications-panel"], ' +
        '[aria-label*="Notifications"]'
      );
      await expect(panel).toBeVisible();
      
      // Check content
      const notifications = panel.locator('[data-testid="notification-item"]');
      const emptyState = panel.locator('[data-testid="empty-state"]');
      
      const hasNotifications = await notifications.count() > 0;
      const isEmpty = await emptyState.isVisible().catch(() => false);
      
      expect(hasNotifications || isEmpty).toBeTruthy();
      
      // If has notifications, test interaction
      if (hasNotifications) {
        const firstNotification = notifications.first();
        
        // Check for mark as read button
        const markReadButton = firstNotification.locator('button[aria-label*="read"]');
        if (await markReadButton.isVisible()) {
          await markReadButton.click();
          
          // Should update UI
          await expect(firstNotification).toHaveAttribute('data-read', 'true');
        }
      }
      
      // Close panel
      await page.keyboard.press('Escape');
      await expect(panel).not.toBeVisible();
    }
  });

  test('notification preferences link', async ({ page }) => {
    // Open notifications panel
    const notificationButton = page.locator('[aria-label*="Notification"]').first();
    
    if (await notificationButton.isVisible()) {
      await notificationButton.click();
      
      // Look for settings link
      const settingsLink = page.locator('a:has-text("Settings"), a:has-text("Preferences")');
      
      if (await settingsLink.isVisible()) {
        await settingsLink.click();
        
        // Should navigate to notification settings
        await expect(page).toHaveURL(/settings.*notification|notification.*settings/);
      }
    }
  });
});
```

## Verifizierung

### Test 1: Run Dashboard Tests
```bash
npx playwright test dashboard-*.spec.ts
# Alle Dashboard Tests sollten grün sein
```

### Test 2: Test Responsive Behavior
```bash
npx playwright test dashboard-layout.spec.ts --project=mobile
# Mobile Layout Tests
```

### Test 3: Visual Regression
```bash
npx playwright test dashboard-layout.spec.ts --update-snapshots
# Screenshots für Visual Testing erstellen
```

## Erfolgskriterien
- [ ] Dashboard Layout wird korrekt angezeigt
- [ ] Statistik-Karten zeigen Daten
- [ ] Recent Activity funktioniert
- [ ] Sidebar Navigation funktioniert
- [ ] Breadcrumb Navigation funktioniert
- [ ] User Menu Navigation funktioniert
- [ ] Quick Actions funktionieren
- [ ] Suche funktioniert
- [ ] Notifications Panel funktioniert
- [ ] Responsive Design funktioniert
- [ ] Keyboard Navigation funktioniert
- [ ] Active States werden korrekt angezeigt

## Wichtige Hinweise

### Authenticated State Setup
```typescript
// Einmal einloggen und State speichern
npx playwright codegen --save-storage=playwright/.auth/user.json
```

### Performance Monitoring
```typescript
test('dashboard load performance', async ({ page }) => {
  const startTime = Date.now();
  await page.goto('/dashboard');
  const loadTime = Date.now() - startTime;
  
  expect(loadTime).toBeLessThan(2000);
});
```

### Accessibility Checks
```typescript
test('dashboard accessibility', async ({ page }) => {
  await page.goto('/dashboard');
  await injectAxe(page);
  await checkA11y(page);
});
```

## Potentielle Probleme

### Problem: Flaky Tests bei Animationen
**Lösung**: Animationen deaktivieren
```typescript
await page.addStyleTag({
  content: '* { animation-duration: 0s !important; }'
});
```

### Problem: Dynamic Content Loading
**Lösung**: Explizite Waits verwenden
```typescript
await page.waitForSelector('[data-testid="stats"]', { state: 'visible' });
await page.waitForLoadState('networkidle');
```

### Problem: Different Dashboard Layouts
**Lösung**: Flexible Selektoren
```typescript
const dashboard = page.locator('[data-testid="dashboard"], main:has(h1:text("Dashboard"))');
```

## Zeitschätzung
- Dashboard Layout Tests: 4 Minuten
- Navigation Tests: 5 Minuten
- Quick Actions Tests: 4 Minuten
- Notifications Tests: 3 Minuten
- Verifizierung: 2 Minuten
- **Total: 18 Minuten**

## Nächster Schritt
Nach erfolgreichen Dashboard Tests → [09.09.4 Posts CRUD Flow E2E Tests](./09.09.4-e2e-posts-crud-flow.md)