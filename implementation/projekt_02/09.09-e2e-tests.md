# Task 09.09: E2E Tests - Homepage und User Flows

## Ziel
Implementierung von End-to-End Tests für kritische User Flows mit Playwright.

## Voraussetzungen
- Task 09.08 abgeschlossen (Playwright konfiguriert)
- Development Server läuft
- Test Helpers verfügbar

## Implementierung

### Schritt 1: Homepage Tests
Erstelle `e2e/homepage.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { TestHelpers } from './helpers/test-helpers';

test.describe('Homepage', () => {
  let helpers: TestHelpers;

  test.beforeEach(async ({ page }) => {
    helpers = new TestHelpers(page);
    await page.goto('/');
  });

  test('has correct title and meta tags', async ({ page }) => {
    // Check title
    await expect(page).toHaveTitle(/App Starter Kit/);
    
    // Check meta description
    const metaDescription = await page.locator('meta[name="description"]').getAttribute('content');
    expect(metaDescription).toContain('starter kit');
    
    // Check Open Graph tags
    const ogTitle = await page.locator('meta[property="og:title"]').getAttribute('content');
    expect(ogTitle).toBeDefined();
  });

  test('displays hero section', async ({ page }) => {
    // Check hero heading
    const heading = page.locator('h1');
    await expect(heading).toBeVisible();
    await expect(heading).toContainText(/Welcome|Get Started|Build/i);
    
    // Check CTA buttons
    const ctaButton = page.locator('a[href="/sign-up"], button:has-text("Get Started")').first();
    await expect(ctaButton).toBeVisible();
  });

  test('navigation menu works', async ({ page }) => {
    // Check navigation links
    const nav = page.locator('nav');
    await expect(nav).toBeVisible();
    
    // Test navigation items
    const links = [
      { text: 'Features', href: '/features' },
      { text: 'Pricing', href: '/pricing' },
      { text: 'About', href: '/about' },
      { text: 'Sign In', href: '/sign-in' },
    ];
    
    for (const link of links) {
      const navLink = nav.locator(`a:has-text("${link.text}")`);
      await expect(navLink).toBeVisible();
      await expect(navLink).toHaveAttribute('href', link.href);
    }
  });

  test('responsive mobile menu', async ({ page }) => {
    // Set mobile viewport
    await page.setViewportSize({ width: 375, height: 667 });
    
    // Mobile menu button should be visible
    const menuButton = page.locator('[aria-label="Menu"], [data-testid="mobile-menu-button"]');
    await expect(menuButton).toBeVisible();
    
    // Open mobile menu
    await menuButton.click();
    
    // Menu should be visible
    const mobileMenu = page.locator('[role="dialog"], [data-testid="mobile-menu"]');
    await expect(mobileMenu).toBeVisible();
    
    // Check menu items
    await expect(mobileMenu.locator('a:has-text("Features")')).toBeVisible();
  });

  test('footer links and information', async ({ page }) => {
    // Scroll to footer
    const footer = page.locator('footer');
    await footer.scrollIntoViewIfNeeded();
    await expect(footer).toBeVisible();
    
    // Check footer links
    const footerLinks = [
      'Privacy Policy',
      'Terms of Service',
      'Contact',
    ];
    
    for (const linkText of footerLinks) {
      await expect(footer.locator(`a:has-text("${linkText}")`)).toBeVisible();
    }
    
    // Check copyright
    await expect(footer).toContainText(/© \d{4}/);
  });

  test('page loads quickly', async ({ page }) => {
    const startTime = Date.now();
    await page.goto('/', { waitUntil: 'domcontentloaded' });
    const loadTime = Date.now() - startTime;
    
    expect(loadTime).toBeLessThan(3000); // Should load in under 3 seconds
  });

  test('no console errors', async ({ page }) => {
    const errors: string[] = [];
    page.on('console', msg => {
      if (msg.type() === 'error') {
        errors.push(msg.text());
      }
    });
    
    await page.goto('/');
    await page.waitForLoadState('networkidle');
    
    expect(errors).toHaveLength(0);
  });
});
```

### Schritt 2: Authentication Flow Tests
Erstelle `e2e/auth.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { LoginPage } from './helpers/test-helpers';

test.describe('Authentication', () => {
  test.describe('Sign Up Flow', () => {
    test('successful registration', async ({ page }) => {
      await page.goto('/sign-up');
      
      // Fill registration form
      const email = `test+${Date.now()}@example.com`;
      await page.fill('[name="email"]', email);
      await page.fill('[name="password"]', 'TestPassword123!');
      await page.fill('[name="confirmPassword"]', 'TestPassword123!');
      await page.fill('[name="name"]', 'Test User');
      
      // Accept terms
      await page.check('[name="terms"]');
      
      // Submit form
      await page.click('button[type="submit"]');
      
      // Should redirect to dashboard or verification
      await expect(page).toHaveURL(/\/(dashboard|verify-email)/);
    });

    test('validation errors', async ({ page }) => {
      await page.goto('/sign-up');
      
      // Try to submit empty form
      await page.click('button[type="submit"]');
      
      // Should show validation errors
      await expect(page.locator('text=Email is required')).toBeVisible();
      await expect(page.locator('text=Password is required')).toBeVisible();
      
      // Test weak password
      await page.fill('[name="password"]', '123');
      await page.click('button[type="submit"]');
      await expect(page.locator('text=Password must be at least')).toBeVisible();
      
      // Test password mismatch
      await page.fill('[name="password"]', 'TestPassword123!');
      await page.fill('[name="confirmPassword"]', 'DifferentPassword123!');
      await page.click('button[type="submit"]');
      await expect(page.locator('text=Passwords do not match')).toBeVisible();
    });

    test('duplicate email prevention', async ({ page }) => {
      await page.goto('/sign-up');
      
      // Use existing email
      await page.fill('[name="email"]', 'existing@example.com');
      await page.fill('[name="password"]', 'TestPassword123!');
      await page.fill('[name="confirmPassword"]', 'TestPassword123!');
      await page.check('[name="terms"]');
      
      await page.click('button[type="submit"]');
      
      // Should show error
      await expect(page.locator('text=Email already registered')).toBeVisible();
    });
  });

  test.describe('Sign In Flow', () => {
    test('successful login', async ({ page }) => {
      const loginPage = new LoginPage(page);
      await page.goto('/sign-in');
      
      await loginPage.login('test@example.com', 'TestPassword123!');
      
      // Should be redirected to dashboard
      await expect(page).toHaveURL('/dashboard');
      
      // User menu should be visible
      await expect(page.locator('[data-testid="user-menu"]')).toBeVisible();
    });

    test('invalid credentials', async ({ page }) => {
      await page.goto('/sign-in');
      
      await page.fill('[name="email"]', 'wrong@example.com');
      await page.fill('[name="password"]', 'WrongPassword');
      await page.click('button[type="submit"]');
      
      // Should show error
      await expect(page.locator('text=Invalid email or password')).toBeVisible();
      
      // Should stay on sign-in page
      await expect(page).toHaveURL('/sign-in');
    });

    test('password reset flow', async ({ page }) => {
      await page.goto('/sign-in');
      
      // Click forgot password
      await page.click('a:has-text("Forgot password")');
      
      // Should navigate to reset page
      await expect(page).toHaveURL('/forgot-password');
      
      // Enter email
      await page.fill('[name="email"]', 'test@example.com');
      await page.click('button:has-text("Send reset link")');
      
      // Should show success message
      await expect(page.locator('text=Check your email')).toBeVisible();
    });

    test('remember me functionality', async ({ page, context }) => {
      await page.goto('/sign-in');
      
      // Check remember me
      await page.check('[name="rememberMe"]');
      
      // Login
      await page.fill('[name="email"]', 'test@example.com');
      await page.fill('[name="password"]', 'TestPassword123!');
      await page.click('button[type="submit"]');
      
      // Get cookies
      const cookies = await context.cookies();
      const sessionCookie = cookies.find(c => c.name.includes('session'));
      
      // Should have longer expiry when remember me is checked
      expect(sessionCookie?.expires).toBeGreaterThan(Date.now() / 1000 + 7 * 24 * 60 * 60);
    });
  });

  test.describe('Sign Out Flow', () => {
    test.use({ storageState: 'playwright/.auth/user.json' });

    test('successful logout', async ({ page }) => {
      await page.goto('/dashboard');
      
      // Open user menu
      await page.click('[data-testid="user-menu"]');
      
      // Click sign out
      await page.click('button:has-text("Sign out")');
      
      // Should redirect to homepage
      await expect(page).toHaveURL('/');
      
      // User menu should not be visible
      await expect(page.locator('[data-testid="user-menu"]')).not.toBeVisible();
    });
  });
});
```

### Schritt 3: Dashboard Tests
Erstelle `e2e/dashboard.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { DashboardPage, TestHelpers } from './helpers/test-helpers';

test.describe('Dashboard', () => {
  test.use({ storageState: 'playwright/.auth/user.json' });
  
  let dashboard: DashboardPage;
  let helpers: TestHelpers;

  test.beforeEach(async ({ page }) => {
    dashboard = new DashboardPage(page);
    helpers = new TestHelpers(page);
    await page.goto('/dashboard');
  });

  test('displays user dashboard', async ({ page }) => {
    // Check dashboard title
    await expect(page.locator('h1')).toContainText(/Dashboard|Overview/);
    
    // Check stats cards
    const statsSection = page.locator('[data-testid="stats"]');
    await expect(statsSection).toBeVisible();
    
    // Check navigation
    const nav = page.locator('nav');
    await expect(nav.locator('a:has-text("Posts")')).toBeVisible();
    await expect(nav.locator('a:has-text("Settings")')).toBeVisible();
  });

  test('displays recent activity', async ({ page }) => {
    const activitySection = page.locator('[data-testid="recent-activity"]');
    await expect(activitySection).toBeVisible();
    
    // Should have at least one activity item or empty state
    const activityItems = activitySection.locator('[data-testid="activity-item"]');
    const emptyState = activitySection.locator('text=No recent activity');
    
    const hasActivity = await activityItems.count() > 0;
    const hasEmptyState = await emptyState.isVisible().catch(() => false);
    
    expect(hasActivity || hasEmptyState).toBeTruthy();
  });

  test('quick actions work', async ({ page }) => {
    // Test create new post quick action
    const newPostButton = page.locator('button:has-text("New Post"), a:has-text("New Post")').first();
    await newPostButton.click();
    
    // Should navigate to new post page
    await expect(page).toHaveURL('/posts/new');
    
    // Go back to dashboard
    await page.goto('/dashboard');
    
    // Test view profile quick action
    const profileButton = page.locator('a:has-text("View Profile")');
    await profileButton.click();
    
    // Should navigate to profile
    await expect(page).toHaveURL(/\/profile/);
  });

  test('sidebar navigation', async ({ page }) => {
    // Test each sidebar link
    const links = [
      { text: 'Posts', url: '/posts' },
      { text: 'Comments', url: '/comments' },
      { text: 'Analytics', url: '/analytics' },
      { text: 'Settings', url: '/settings' },
    ];
    
    for (const link of links) {
      await dashboard.navigateToSection(link.text);
      await expect(page).toHaveURL(new RegExp(link.url));
      await page.goBack();
    }
  });

  test('search functionality', async ({ page }) => {
    const searchInput = page.locator('[placeholder*="Search"]');
    await searchInput.fill('test query');
    await searchInput.press('Enter');
    
    // Should show search results or navigate to search page
    await expect(page.locator('text=Search results, text=results for "test query"')).toBeVisible({ timeout: 5000 });
  });

  test('notifications panel', async ({ page }) => {
    // Open notifications
    const notificationButton = page.locator('[aria-label="Notifications"]');
    await notificationButton.click();
    
    // Notifications panel should be visible
    const notificationPanel = page.locator('[role="dialog"], [data-testid="notifications-panel"]');
    await expect(notificationPanel).toBeVisible();
    
    // Should show notifications or empty state
    const notifications = notificationPanel.locator('[data-testid="notification-item"]');
    const emptyState = notificationPanel.locator('text=No new notifications');
    
    const hasNotifications = await notifications.count() > 0;
    const hasEmptyState = await emptyState.isVisible().catch(() => false);
    
    expect(hasNotifications || hasEmptyState).toBeTruthy();
  });
});
```

### Schritt 4: CRUD Operations Tests
Erstelle `e2e/posts.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { TestHelpers } from './helpers/test-helpers';

test.describe('Posts CRUD', () => {
  test.use({ storageState: 'playwright/.auth/user.json' });
  
  let helpers: TestHelpers;

  test.beforeEach(async ({ page }) => {
    helpers = new TestHelpers(page);
  });

  test('create new post', async ({ page }) => {
    await page.goto('/posts/new');
    
    // Fill post form
    const title = `Test Post ${Date.now()}`;
    await page.fill('[name="title"]', title);
    await page.fill('[name="content"]', 'This is test content for the post.');
    
    // Select category
    await page.selectOption('[name="category"]', 'Tech');
    
    // Add tags
    await page.fill('[name="tags"]', 'test, playwright, e2e');
    
    // Save as draft first
    await page.click('button:has-text("Save as Draft")');
    
    // Should show success message
    await helpers.expectToast('Post saved as draft');
    
    // Should redirect to post edit page
    await expect(page).toHaveURL(/\/posts\/[^\/]+\/edit/);
    
    // Publish post
    await page.click('button:has-text("Publish")');
    
    // Confirm publish dialog
    await page.click('button:has-text("Yes, publish")');
    
    // Should show success and redirect
    await helpers.expectToast('Post published successfully');
    await expect(page).toHaveURL(/\/posts\/[^\/]+$/);
    
    // Verify post is displayed
    await expect(page.locator('h1')).toContainText(title);
  });

  test('edit existing post', async ({ page }) => {
    // Create a test post first
    await helpers.createTestPost({ title: 'Post to Edit' });
    
    // Click edit button
    await page.click('button:has-text("Edit"), a:has-text("Edit")');
    
    // Should be on edit page
    await expect(page).toHaveURL(/\/edit/);
    
    // Update title
    await page.fill('[name="title"]', 'Updated Post Title');
    
    // Update content
    await page.fill('[name="content"]', 'Updated content for the post.');
    
    // Save changes
    await page.click('button:has-text("Save Changes")');
    
    // Should show success
    await helpers.expectToast('Post updated successfully');
    
    // Verify changes
    await expect(page.locator('h1')).toContainText('Updated Post Title');
  });

  test('delete post', async ({ page }) => {
    // Create a test post
    await helpers.createTestPost({ title: 'Post to Delete' });
    
    // Open post options
    await page.click('[aria-label="Post options"], button:has-text("⋮")');
    
    // Click delete
    await page.click('button:has-text("Delete")');
    
    // Confirm deletion
    const dialog = page.locator('[role="dialog"]');
    await expect(dialog).toContainText('Are you sure');
    await dialog.locator('button:has-text("Delete")').click();
    
    // Should show success and redirect
    await helpers.expectToast('Post deleted successfully');
    await expect(page).toHaveURL('/posts');
    
    // Post should not be in list
    await expect(page.locator('text="Post to Delete"')).not.toBeVisible();
  });

  test('list and filter posts', async ({ page }) => {
    await page.goto('/posts');
    
    // Should show posts list
    await expect(page.locator('h1')).toContainText('Posts');
    
    // Filter by status
    await page.selectOption('[name="status"]', 'published');
    await page.waitForLoadState('networkidle');
    
    // Only published posts should be visible
    const postCards = page.locator('[data-testid="post-card"]');
    const count = await postCards.count();
    
    for (let i = 0; i < count; i++) {
      const status = await postCards.nth(i).locator('[data-testid="post-status"]').textContent();
      expect(status).toContain('Published');
    }
    
    // Search posts
    await page.fill('[placeholder*="Search posts"]', 'test');
    await page.press('[placeholder*="Search posts"]', 'Enter');
    await page.waitForLoadState('networkidle');
    
    // Results should contain search term
    const searchResults = page.locator('[data-testid="post-card"]');
    const searchCount = await searchResults.count();
    
    if (searchCount > 0) {
      const firstResult = await searchResults.first().textContent();
      expect(firstResult?.toLowerCase()).toContain('test');
    }
  });

  test('pagination', async ({ page }) => {
    await page.goto('/posts');
    
    // Check if pagination exists
    const pagination = page.locator('[data-testid="pagination"], nav[aria-label="Pagination"]');
    
    if (await pagination.isVisible()) {
      // Click next page
      await pagination.locator('button:has-text("Next"), a:has-text("Next")').click();
      
      // URL should update
      await expect(page).toHaveURL(/page=2/);
      
      // Different posts should be visible
      const firstPostTitle = await page.locator('[data-testid="post-card"]').first().textContent();
      
      // Go back to first page
      await pagination.locator('button:has-text("Previous"), a:has-text("Previous")').click();
      
      // Should be back on page 1
      await expect(page).toHaveURL(/posts(?!.*page=2)/);
      
      // First post should be different
      const newFirstPostTitle = await page.locator('[data-testid="post-card"]').first().textContent();
      expect(firstPostTitle).not.toBe(newFirstPostTitle);
    }
  });
});
```

### Schritt 5: Accessibility Tests
Erstelle `e2e/accessibility.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { injectAxe, checkA11y } from 'axe-playwright';

test.describe('Accessibility', () => {
  test('homepage accessibility', async ({ page }) => {
    await page.goto('/');
    await injectAxe(page);
    await checkA11y(page, undefined, {
      detailedReport: true,
      detailedReportOptions: {
        html: true,
      },
    });
  });

  test('sign in page accessibility', async ({ page }) => {
    await page.goto('/sign-in');
    await injectAxe(page);
    await checkA11y(page);
  });

  test('dashboard accessibility', async ({ page }) => {
    // Use authenticated state
    await page.goto('/dashboard', {
      storageState: 'playwright/.auth/user.json',
    });
    await injectAxe(page);
    await checkA11y(page);
  });

  test('keyboard navigation', async ({ page }) => {
    await page.goto('/');
    
    // Tab through interactive elements
    await page.keyboard.press('Tab');
    
    // First focusable element should have focus
    const focusedElement = await page.evaluate(() => document.activeElement?.tagName);
    expect(focusedElement).toBeDefined();
    
    // Continue tabbing
    for (let i = 0; i < 10; i++) {
      await page.keyboard.press('Tab');
      const element = await page.evaluate(() => ({
        tag: document.activeElement?.tagName,
        role: document.activeElement?.getAttribute('role'),
        ariaLabel: document.activeElement?.getAttribute('aria-label'),
      }));
      
      // Should only focus interactive elements
      expect(['A', 'BUTTON', 'INPUT', 'SELECT', 'TEXTAREA']).toContain(element.tag);
    }
  });

  test('screen reader labels', async ({ page }) => {
    await page.goto('/');
    
    // Check all buttons have accessible labels
    const buttons = await page.locator('button').all();
    for (const button of buttons) {
      const text = await button.textContent();
      const ariaLabel = await button.getAttribute('aria-label');
      const ariaLabelledBy = await button.getAttribute('aria-labelledby');
      
      // Button should have text, aria-label, or aria-labelledby
      expect(text || ariaLabel || ariaLabelledBy).toBeTruthy();
    }
    
    // Check all images have alt text
    const images = await page.locator('img').all();
    for (const img of images) {
      const alt = await img.getAttribute('alt');
      const role = await img.getAttribute('role');
      
      // Images should have alt text or be marked as decorative
      expect(alt !== null || role === 'presentation').toBeTruthy();
    }
  });

  test('color contrast', async ({ page }) => {
    await page.goto('/');
    await injectAxe(page);
    
    // Check specifically for color contrast issues
    const results = await page.evaluate(async () => {
      // @ts-ignore
      return await axe.run(document, {
        rules: {
          'color-contrast': { enabled: true },
        },
      });
    });
    
    expect(results.violations.filter(v => v.id === 'color-contrast')).toHaveLength(0);
  });
});
```

## Verifizierung

### Test 1: Run E2E Tests
```bash
npx playwright test
# Alle Tests sollten grün sein
```

### Test 2: Run specific test file
```bash
npx playwright test homepage.spec.ts
# Homepage Tests sollten laufen
```

### Test 3: Debug Mode
```bash
npx playwright test --debug
# Öffnet Playwright Inspector
```

### Test 4: UI Mode
```bash
npx playwright test --ui
# Öffnet Playwright UI
```

### Test 5: Generate Report
```bash
npx playwright show-report
# Öffnet HTML Report
```

## Erfolgskriterien
- [ ] Homepage Tests implementiert
- [ ] Authentication Flow Tests
- [ ] Dashboard Tests
- [ ] CRUD Operations Tests
- [ ] Accessibility Tests
- [ ] Keyboard Navigation Tests
- [ ] Responsive Tests
- [ ] Performance Tests
- [ ] Error Handling Tests
- [ ] Alle Tests grün

## Wichtige Hinweise

### Test Isolation
- Jeder Test sollte unabhängig laufen
- Cleanup nach Tests wichtig
- Keine Test-Abhängigkeiten

### Flaky Tests
- WaitForLoadState verwenden
- Explicit Waits statt implizite
- Retry-Logic für Network Calls

### CI/CD Considerations
- Tests sollten in CI laufen
- Screenshots bei Failures
- Parallel Execution beachten

## Potentielle Probleme

### Problem: Tests flaky
**Lösung**: Wait Strategies verbessern
```typescript
await page.waitForLoadState('networkidle');
await page.waitForSelector('[data-loaded="true"]');
```

### Problem: Auth State nicht persistent
**Lösung**: Storage State prüfen
```typescript
test.use({ storageState: 'playwright/.auth/user.json' });
```

### Problem: Timeouts
**Lösung**: Timeout erhöhen
```typescript
test('slow test', { timeout: 60000 }, async ({ page }) => {
  // Test code
});
```

## Rollback Plan
Falls Tests fehlschlagen:
```typescript
test.skip('flaky test', async ({ page }) => {
  // Skip temporarily
});
```

## Zeitschätzung
- Homepage Tests: 10 Minuten
- Auth Tests: 10 Minuten
- Dashboard Tests: 8 Minuten
- CRUD Tests: 10 Minuten
- Accessibility Tests: 7 Minuten
- Verifizierung: 5 Minuten
- **Total: 50 Minuten**

## Nächster Schritt
Nach erfolgreichen E2E Tests → [09.10 Test Scripts](./09.10-test-scripts.md)