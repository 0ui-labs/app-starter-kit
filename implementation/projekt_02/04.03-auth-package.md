# Arbeitspaket 04.03: Auth Package Implementation

## Ziel
Erstellung von Server-Side Auth Utilities mit TypeScript Types und Helper Functions.

## Vorbedingungen
- [ ] @clerk/nextjs ist installiert
- [ ] TypeScript Konfiguration vorhanden

## Implementierung

### Schritt 1: Auth Package Update
Update `packages/auth/index.ts`:

```typescript
import { auth, currentUser } from '@clerk/nextjs/server';

// Re-export Clerk server utilities
export { auth, currentUser };

// Type definitions
export interface AuthUser {
  id: string;
  email: string | undefined;
  firstName: string | null;
  lastName: string | null;
  fullName: string;
  imageUrl: string;
  createdAt: Date;
}

// Get current user with additional data
export async function getCurrentUser(): Promise<AuthUser | null> {
  const user = await currentUser();
  
  if (!user) {
    return null;
  }
  
  return {
    id: user.id,
    email: user.emailAddresses[0]?.emailAddress,
    firstName: user.firstName,
    lastName: user.lastName,
    fullName: `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'User',
    imageUrl: user.imageUrl,
    createdAt: new Date(user.createdAt),
  };
}

// Check if user has specific role
export async function hasRole(role: string): Promise<boolean> {
  const { has } = await auth();
  return has({ role });
}

// Check if user has specific permission
export async function hasPermission(permission: string): Promise<boolean> {
  const { has } = await auth();
  return has({ permission });
}

// Require authentication (throws if not authenticated)
export async function requireAuth(): Promise<string> {
  const { userId } = await auth();
  
  if (!userId) {
    throw new Error('Unauthorized: Authentication required');
  }
  
  return userId;
}

// Require specific role (throws if not authorized)
export async function requireRole(role: string): Promise<string> {
  const userId = await requireAuth();
  const authorized = await hasRole(role);
  
  if (!authorized) {
    throw new Error(`Unauthorized: Missing role '${role}'`);
  }
  
  return userId;
}

// Require specific permission (throws if not authorized)
export async function requirePermission(permission: string): Promise<string> {
  const userId = await requireAuth();
  const { has } = await auth();
  const authorized = await has({ permission });
  
  if (!authorized) {
    throw new Error(`Unauthorized: Missing permission '${permission}'`);
  }
  
  return userId;
}
```

## Verwendungsbeispiele

### In Server Components
```typescript
import { getCurrentUser, requireAuth } from '@starter-kit/auth';

export default async function ProtectedPage() {
  const user = await getCurrentUser();
  // oder
  const userId = await requireAuth(); // throws if not authenticated
}
```

### In API Routes
```typescript
import { requireRole } from '@starter-kit/auth';

export async function POST(req: Request) {
  await requireRole('admin'); // throws if not admin
  // Handle admin-only action
}
```

## Verifizierung
1. TypeScript kompiliert ohne Fehler
2. Imports funktionieren in Server Components
3. Helper Functions geben korrekte Werte zurück

## Erfolgskriterien
- [ ] AuthUser Interface ist definiert
- [ ] getCurrentUser() funktioniert
- [ ] requireAuth() wirft Error bei fehlender Auth
- [ ] hasRole() prüft Rollen korrekt
- [ ] Alle Exports sind typsicher

## Zeitschätzung: 15 Minuten

## Nächster Schritt
→ 04.04: Auth Components