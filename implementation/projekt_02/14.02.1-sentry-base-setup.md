# Sub-Task 14.02.1: Sentry Base Setup für Next.js 15

## Ziel
Installation und Grundkonfiguration von Sentry für Next.js 15 mit App Router. Setup der grundlegenden Error Tracking Infrastruktur für Client und Server mit environment-basierter Aktivierung.

## Voraussetzungen
- Next.js 15 App Router Setup
- Sentry Account mit Projekt erstellt
- DSN aus Sentry Dashboard

## Umfang
- Sentry SDK Installation
- Next.js 15 spezifische Konfiguration
- Environment Variables Setup
- Instrumentation Files für Client und Server
- Source Maps Upload Konfiguration
- Error Boundary Integration
- Basic Error Filtering

## Implementierung

### 1. Installation und Setup

```bash
# Installation mit Next.js 15 Support
npm install @sentry/nextjs@latest

# Optional: Wizard für automatisches Setup (prüfen ob Next.js 15 kompatibel)
npx @sentry/wizard@latest -i nextjs
```

### 2. Environment Variables

```env
# .env.local
NEXT_PUBLIC_SENTRY_DSN="your-public-dsn"
SENTRY_ORG="your-org"
SENTRY_PROJECT="your-project"
SENTRY_AUTH_TOKEN="your-auth-token"

# Conditional activation
NEXT_PUBLIC_SENTRY_ENVIRONMENT="development" # or "production", "staging"
NEXT_PUBLIC_SENTRY_ENABLED="true"
```

### 3. Instrumentation Setup für Next.js 15

`apps/web/instrumentation.ts`:
```typescript
export async function register() {
  // Server-side instrumentation
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await import('./sentry.server.config')
  }

  // Edge runtime instrumentation  
  if (process.env.NEXT_RUNTIME === 'edge') {
    await import('./sentry.edge.config')
  }
}

// Client-side instrumentation wird über app/layout.tsx geladen
```

### 4. Server Configuration

`apps/web/sentry.server.config.ts`:
```typescript
import * as Sentry from '@sentry/nextjs';

const SENTRY_DSN = process.env.NEXT_PUBLIC_SENTRY_DSN;
const isEnabled = process.env.NEXT_PUBLIC_SENTRY_ENABLED === 'true';

if (isEnabled && SENTRY_DSN) {
  Sentry.init({
    dsn: SENTRY_DSN,
    environment: process.env.NEXT_PUBLIC_SENTRY_ENVIRONMENT || 'development',
    
    // Sample rate for production
    tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
    
    // Capture unhandled promise rejections
    onUnhandledRejection: 'strict',
    
    // Debug mode in development
    debug: process.env.NODE_ENV === 'development',
    
    // Disable in development if needed
    enabled: process.env.NODE_ENV === 'production' || 
             process.env.NEXT_PUBLIC_SENTRY_FORCE_ENABLE === 'true',
    
    // Basic integrations
    integrations: [
      // Automatically instrument Node.js libraries
      Sentry.nativeNodeFetchIntegration(),
      
      // Capture console errors
      Sentry.captureConsoleIntegration({
        levels: ['error', 'warn'],
      }),
    ],
    
    // Before send hook for filtering
    beforeSend(event, hint) {
      // Filter out specific errors
      if (event.exception?.values?.[0]?.type === 'ChunkLoadError') {
        return null;
      }
      
      // Don't send events in development unless forced
      if (process.env.NODE_ENV === 'development' && 
          !process.env.NEXT_PUBLIC_SENTRY_FORCE_ENABLE) {
        console.log('Sentry Event (dev):', event);
        return null;
      }
      
      return event;
    },
  });
}
```

### 5. Client Configuration

`apps/web/sentry.client.config.ts`:
```typescript
import * as Sentry from '@sentry/nextjs';

const SENTRY_DSN = process.env.NEXT_PUBLIC_SENTRY_DSN;
const isEnabled = process.env.NEXT_PUBLIC_SENTRY_ENABLED === 'true';

if (isEnabled && SENTRY_DSN) {
  Sentry.init({
    dsn: SENTRY_DSN,
    environment: process.env.NEXT_PUBLIC_SENTRY_ENVIRONMENT || 'development',
    
    // Sample rate for production
    tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
    
    // Debug mode in development
    debug: process.env.NODE_ENV === 'development',
    
    // Disable in development if needed
    enabled: process.env.NODE_ENV === 'production' || 
             process.env.NEXT_PUBLIC_SENTRY_FORCE_ENABLE === 'true',
    
    // Client-specific integrations
    integrations: [
      // Browser Tracing for performance
      Sentry.browserTracingIntegration(),
      
      // Breadcrumbs for context
      Sentry.breadcrumbsIntegration({
        console: true,
        dom: true,
        fetch: true,
        history: true,
        xhr: true,
      }),
    ],
    
    // Client-side error filtering
    ignoreErrors: [
      // Browser extensions
      'top.GLOBALS',
      // Facebook related errors
      'fb_xd_fragment',
      // IE specific errors
      'Non-Error promise rejection captured',
      // Safari private mode
      'QuotaExceededError',
      // Network errors
      'NetworkError',
      'Network request failed',
      // Chunk load errors (usually from old cached bundles)
      'ChunkLoadError',
      'Loading chunk',
    ],
    
    // Filter transactions
    beforeTransaction(transaction) {
      // Don't track health checks
      if (transaction.name === '/api/health') {
        return null;
      }
      return transaction;
    },
  });
}
```

### 6. Edge Runtime Configuration

`apps/web/sentry.edge.config.ts`:
```typescript
import * as Sentry from '@sentry/nextjs';

const SENTRY_DSN = process.env.NEXT_PUBLIC_SENTRY_DSN;
const isEnabled = process.env.NEXT_PUBLIC_SENTRY_ENABLED === 'true';

if (isEnabled && SENTRY_DSN) {
  Sentry.init({
    dsn: SENTRY_DSN,
    environment: process.env.NEXT_PUBLIC_SENTRY_ENVIRONMENT || 'development',
    
    // Lower sample rate for edge functions
    tracesSampleRate: 0.1,
    
    // Edge runtime doesn't support all integrations
    integrations: [
      // Basic error tracking only
    ],
  });
}
```

### 7. Next.js Configuration

`apps/web/next.config.mjs`:
```javascript
import { withSentryConfig } from '@sentry/nextjs';

/** @type {import('next').NextConfig} */
const nextConfig = {
  // Your existing Next.js config
  reactStrictMode: true,
  
  // Sentry specific
  sentry: {
    // Hide source maps from client bundles
    hideSourceMaps: true,
    
    // Disable Sentry in development builds
    disableServerWebpackPlugin: process.env.NODE_ENV === 'development',
    disableClientWebpackPlugin: process.env.NODE_ENV === 'development',
  },
};

// Sentry webpack plugin configuration
const sentryWebpackPluginOptions = {
  // Organization and project
  org: process.env.SENTRY_ORG,
  project: process.env.SENTRY_PROJECT,
  authToken: process.env.SENTRY_AUTH_TOKEN,
  
  // Only upload source maps in production
  silent: true,
  dryRun: process.env.NODE_ENV !== 'production',
  
  // Source maps
  sourcemaps: {
    assets: './.next',
    ignore: ['./node_modules/**'],
  },
  
  // Release configuration
  release: {
    deploy: {
      env: process.env.NEXT_PUBLIC_SENTRY_ENVIRONMENT || 'development',
    },
  },
};

// Export with Sentry wrapper
export default process.env.NEXT_PUBLIC_SENTRY_ENABLED === 'true'
  ? withSentryConfig(nextConfig, sentryWebpackPluginOptions)
  : nextConfig;
```

### 8. Client Provider für App Router

`apps/web/src/providers/sentry-provider.tsx`:
```typescript
'use client';

import { useEffect } from 'react';
import { usePathname, useSearchParams } from 'next/navigation';
import * as Sentry from '@sentry/nextjs';

export function SentryProvider({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();
  const searchParams = useSearchParams();
  
  useEffect(() => {
    // Track page views
    if (typeof window !== 'undefined' && process.env.NEXT_PUBLIC_SENTRY_ENABLED === 'true') {
      const url = `${pathname}${searchParams ? `?${searchParams}` : ''}`;
      Sentry.addBreadcrumb({
        category: 'navigation',
        message: `Navigated to ${url}`,
        level: 'info',
      });
    }
  }, [pathname, searchParams]);
  
  return <>{children}</>;
}
```

### 9. Root Layout Integration

`apps/web/src/app/layout.tsx`:
```typescript
import { SentryProvider } from '@/providers/sentry-provider';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="de">
      <body>
        <SentryProvider>
          {children}
        </SentryProvider>
      </body>
    </html>
  );
}
```

### 10. Error Boundary für App Router

`apps/web/src/app/error.tsx`:
```typescript
'use client';

import { useEffect } from 'react';
import * as Sentry from '@sentry/nextjs';

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    // Log error to Sentry
    Sentry.captureException(error, {
      tags: {
        component: 'error-boundary',
        digest: error.digest,
      },
    });
  }, [error]);
  
  return (
    <div className="flex min-h-screen flex-col items-center justify-center">
      <h2 className="text-2xl font-bold mb-4">Ein Fehler ist aufgetreten!</h2>
      <p className="text-gray-600 mb-4">{error.message}</p>
      <button
        onClick={reset}
        className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
      >
        Erneut versuchen
      </button>
    </div>
  );
}
```

### 11. Global Error Handler

`apps/web/src/app/global-error.tsx`:
```typescript
'use client';

import * as Sentry from '@sentry/nextjs';
import { useEffect } from 'react';

export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    Sentry.captureException(error, {
      level: 'fatal',
      tags: {
        component: 'global-error-boundary',
      },
    });
  }, [error]);
  
  return (
    <html>
      <body>
        <div className="flex min-h-screen flex-col items-center justify-center">
          <h2 className="text-2xl font-bold mb-4">Kritischer Fehler!</h2>
          <p className="text-gray-600 mb-4">
            Die Anwendung ist auf einen kritischen Fehler gestoßen.
          </p>
          <button
            onClick={reset}
            className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
          >
            Anwendung neu laden
          </button>
        </div>
      </body>
    </html>
  );
}
```

### 12. Utility Functions

`apps/web/src/lib/monitoring/sentry-utils.ts`:
```typescript
import * as Sentry from '@sentry/nextjs';

/**
 * Capture an exception with additional context
 */
export function captureException(
  error: Error | unknown,
  context?: {
    tags?: Record<string, string>;
    extra?: Record<string, any>;
    level?: Sentry.SeverityLevel;
    user?: { id?: string; email?: string };
  }
) {
  if (process.env.NEXT_PUBLIC_SENTRY_ENABLED !== 'true') {
    console.error('Error (Sentry disabled):', error, context);
    return;
  }
  
  Sentry.withScope((scope) => {
    if (context?.tags) {
      Object.entries(context.tags).forEach(([key, value]) => {
        scope.setTag(key, value);
      });
    }
    
    if (context?.extra) {
      Object.entries(context.extra).forEach(([key, value]) => {
        scope.setExtra(key, value);
      });
    }
    
    if (context?.level) {
      scope.setLevel(context.level);
    }
    
    if (context?.user) {
      scope.setUser(context.user);
    }
    
    Sentry.captureException(error);
  });
}

/**
 * Add a breadcrumb for debugging context
 */
export function addBreadcrumb(breadcrumb: {
  message: string;
  category?: string;
  level?: Sentry.SeverityLevel;
  data?: Record<string, any>;
}) {
  if (process.env.NEXT_PUBLIC_SENTRY_ENABLED !== 'true') {
    return;
  }
  
  Sentry.addBreadcrumb(breadcrumb);
}

/**
 * Set user context for error tracking
 */
export function setUser(user: {
  id?: string;
  email?: string;
  username?: string;
} | null) {
  if (process.env.NEXT_PUBLIC_SENTRY_ENABLED !== 'true') {
    return;
  }
  
  Sentry.setUser(user);
}

/**
 * Capture a message (non-error event)
 */
export function captureMessage(
  message: string,
  level: Sentry.SeverityLevel = 'info'
) {
  if (process.env.NEXT_PUBLIC_SENTRY_ENABLED !== 'true') {
    console.log(`[${level.toUpperCase()}]:`, message);
    return;
  }
  
  Sentry.captureMessage(message, level);
}
```

## Testing

### Verify Installation

```typescript
// app/api/test-sentry/route.ts
import { NextResponse } from 'next/server';
import * as Sentry from '@sentry/nextjs';

export async function GET() {
  try {
    // Test error
    throw new Error('Test Sentry Error from API Route');
  } catch (error) {
    Sentry.captureException(error);
    return NextResponse.json({ error: 'Sentry test error sent' }, { status: 500 });
  }
}
```

### Client Test Component

```typescript
'use client';

import { captureException } from '@/lib/monitoring/sentry-utils';

export function TestSentryButton() {
  const handleClick = () => {
    try {
      throw new Error('Test Sentry Error from Client');
    } catch (error) {
      captureException(error, {
        tags: { component: 'test-button' },
        level: 'warning',
      });
    }
  };
  
  return (
    <button onClick={handleClick}>
      Test Sentry Error
    </button>
  );
}
```

## Erfolgskriterien
- [ ] Sentry SDK installiert und konfiguriert
- [ ] Environment Variables gesetzt
- [ ] Server-side Error Tracking funktioniert
- [ ] Client-side Error Tracking funktioniert
- [ ] Edge Runtime Errors werden erfasst
- [ ] Source Maps werden in Production hochgeladen
- [ ] Error Boundaries integriert
- [ ] Utility Functions verfügbar
- [ ] Error Filtering funktioniert
- [ ] Test Errors kommen in Sentry Dashboard an

## Zeitschätzung
- **Total: 35 Minuten**
  - Installation und Setup: 5 Min
  - Configuration Files: 10 Min
  - Error Boundaries: 5 Min
  - Utility Functions: 5 Min
  - Testing und Verifikation: 10 Min

## Nächster Schritt
Nach Base Setup → [14.02.2 Performance Monitoring](./14.02.2-sentry-performance-monitoring.md)