# Arbeitspaket 04.10: Testing & Verification

## Ziel
Vollständige Verifizierung aller Clerk Authentication Features.

## Vorbedingungen
- [ ] Alle vorherigen Schritte (04.01-04.09) sind implementiert
- [ ] Development Server läuft (`npm run dev`)
- [ ] Clerk Dashboard ist erreichbar

## Test Checkliste

### 1. Basic Setup Tests

#### Test: ClerkProvider Integration
```bash
# Start Dev Server
npm run dev

# Erwartung: Keine Errors in Console
# Prüfe: React DevTools zeigt ClerkProvider
```

#### Test: Environment Variables
```bash
# In Browser Console:
console.log(process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY)
# Sollte mit "pk_test_" beginnen
```

### 2. Authentication Flow Tests

#### Test: Sign Up Flow
1. Navigiere zu `/sign-up`
2. Fülle Formular aus:
   - Email: test@example.com
   - Password: TestPassword123!
3. Verifiziere Email (Check Inbox)
4. **Erwartung**: Redirect zu `/dashboard`

#### Test: Sign In Flow
1. Navigiere zu `/sign-in`
2. Login mit erstelltem Account
3. **Erwartung**: Redirect zu `/dashboard`

#### Test: Sign Out Flow
1. Im Dashboard: Click UserButton
2. Wähle "Sign Out"
3. **Erwartung**: Redirect zu `/`

### 3. Route Protection Tests

#### Test: Protected Route ohne Auth
```bash
# In Incognito/Private Browser
curl -I http://localhost:3004/dashboard

# Erwartung: 307 Redirect
# Location: /sign-in?redirect_url=/dashboard
```

#### Test: Public Route Access
```bash
curl http://localhost:3004/

# Erwartung: 200 OK
# Homepage wird angezeigt
```

#### Test: Admin Route ohne Rolle
1. Als normaler User einloggen
2. Navigiere zu `/admin`
3. **Erwartung**: Redirect zu `/unauthorized`

### 4. Component Tests

#### Test: UserButton
- [ ] Avatar wird angezeigt
- [ ] Dropdown öffnet sich
- [ ] "Manage Account" Link funktioniert
- [ ] Sign Out funktioniert

#### Test: SignInButton
- [ ] Modal Mode: Öffnet Modal
- [ ] Redirect Mode: Navigiert zu /sign-in

### 5. User Data Tests

#### Test: getCurrentUser Function
```typescript
// In einer Server Component
import { getCurrentUser } from '@starter-kit/auth';

const user = await getCurrentUser();
console.log(user);
// Sollte User-Objekt mit allen Feldern zeigen
```

#### Test: Auth State in Dashboard
- [ ] User Name wird angezeigt
- [ ] User Email wird angezeigt
- [ ] User ID wird angezeigt
- [ ] Registrierungsdatum wird angezeigt

### 6. Edge Cases & Error Handling

#### Test: Expired Session
1. Login
2. Warte Session Timeout ab (oder manipuliere Cookie)
3. Versuche protected Route
4. **Erwartung**: Redirect zu Sign In

#### Test: Invalid Credentials
1. Sign In mit falschen Daten
2. **Erwartung**: Error Message

#### Test: Duplicate Email Registration
1. Versuche Sign Up mit existierender Email
2. **Erwartung**: Error Message

### 7. Performance Tests

#### Test: Page Load Times
```bash
# Measure Initial Load
npm run build
npm start

# Mit Chrome DevTools Lighthouse:
# - First Contentful Paint < 1.5s
# - Time to Interactive < 3s
```

### 8. Mobile Responsiveness

#### Test: Mobile Views
1. Chrome DevTools → Toggle Device Toolbar
2. Teste alle Pages:
   - [ ] Homepage
   - [ ] Sign In/Up
   - [ ] Dashboard
   - [ ] Unauthorized

### 9. Browser Compatibility

Teste in folgenden Browsern:
- [ ] Chrome/Edge
- [ ] Firefox
- [ ] Safari
- [ ] Mobile Safari (iOS)
- [ ] Chrome Mobile (Android)

## Automatisierte Tests (Optional)

### E2E Test mit Playwright
```typescript
// e2e/auth.spec.ts
import { test, expect } from '@playwright/test';

test('sign up flow', async ({ page }) => {
  await page.goto('/sign-up');
  await page.fill('input[name="email"]', 'test@example.com');
  await page.fill('input[name="password"]', 'TestPassword123!');
  await page.click('button[type="submit"]');
  await expect(page).toHaveURL('/dashboard');
});
```

## Debugging Hilfe

### Browser Console Commands
```javascript
// Check Clerk Status
__clerk_db_jwt

// Get current user
await window.Clerk.user

// Check session
await window.Clerk.session
```

### Nützliche URLs
- Clerk Dashboard: https://dashboard.clerk.com
- Clerk Logs: https://dashboard.clerk.com/logs
- Clerk Users: https://dashboard.clerk.com/users

## Erfolgskriterien Zusammenfassung

- [ ] Sign Up funktioniert komplett
- [ ] Sign In funktioniert komplett
- [ ] Sign Out funktioniert komplett
- [ ] Protected Routes sind geschützt
- [ ] Public Routes sind zugänglich
- [ ] User Daten werden korrekt angezeigt
- [ ] Keine Console Errors
- [ ] Mobile Responsive
- [ ] Performance akzeptabel

## Bekannte Probleme & Lösungen

### Hydration Mismatch
**Problem**: "Text content does not match"
**Lösung**: `suppressHydrationWarning` in HTML Tag

### Slow Initial Load
**Problem**: Clerk JS Bundle ist groß
**Lösung**: Lazy Loading für nicht-kritische Components

### Session Persistence
**Problem**: User wird ausgeloggt nach Refresh
**Lösung**: Prüfe Cookie Settings in Clerk Dashboard

## Zeitschätzung: 15 Minuten

## Abschluss
Nach erfolgreicher Verifizierung:
1. Commit alle Änderungen
2. Update README mit Auth Instruktionen
3. Dokumentiere spezielle Konfigurationen

## Nächste Schritte nach Completion
- User Profile Page implementieren
- Organization Support hinzufügen
- Webhook Handler für User Events
- Multi-Factor Authentication aktivieren