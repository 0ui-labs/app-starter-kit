# 02.04 - Database Connection Test

## Ziel
Verifizieren dass die PrismaClient Singleton Instanz erfolgreich mit der Datenbank verbinden kann.

## Voraussetzungen
- [ ] Schritt 02.03 abgeschlossen
- [ ] DATABASE_URL in `.env` konfiguriert
- [ ] PostgreSQL Datenbank läuft (lokal oder Neon)

## Test 1: Basic Connection Test

### 1. Simple Query Test
```bash
cd packages/db

# Führe eine simple SELECT 1 Query aus
npx tsx -e "
import { db } from './index';
db.\$queryRaw\`SELECT 1 as result\`
  .then((res) => console.log('✅ Database connection works:', res))
  .catch((err) => console.error('❌ Connection failed:', err))
  .finally(() => process.exit(0));
"
```

**Erwartung:**
```
✅ Database connection works: [ { result: 1 } ]
```

## Test 2: Prisma Schema Test

### 1. Teste ob Schema-Models verfügbar sind
```bash
cd packages/db

# Liste verfügbare Models
npx tsx -e "
import { db } from './index';
console.log('Available Models:');
Object.keys(db).forEach(key => {
  if (!key.startsWith('$') && typeof db[key] === 'object') {
    console.log('  -', key);
  }
});
"
```

**Erwartung:** Liste der Prisma Models (z.B. `user`, `post`, etc.)

### 2. Teste eine Model-Query
```bash
# Beispiel mit User model (passe an dein Schema an)
npx tsx -e "
import { db } from './index';
db.user.count()
  .then((count) => console.log('✅ User count:', count))
  .catch((err) => console.error('❌ Query failed:', err))
  .finally(() => process.exit(0));
"
```

## Test 3: Connection Pool Test

### 1. Erstelle Multiple Connection Test
Erstelle `packages/db/test-pool.ts`:

```typescript
import { db } from './index';

async function testConnectionPool() {
  console.log('Testing connection pool...');
  
  // Führe 10 parallele Queries aus
  const promises = Array.from({ length: 10 }, (_, i) => 
    db.$queryRaw`SELECT ${i} as num, NOW() as time`
  );
  
  try {
    const results = await Promise.all(promises);
    console.log('✅ All queries completed');
    console.log(`   Executed ${results.length} parallel queries`);
    
    // Zeige erste und letzte Query Zeit
    console.log('   First query:', results[0]);
    console.log('   Last query:', results[9]);
  } catch (error) {
    console.error('❌ Pool test failed:', error);
  }
}

testConnectionPool()
  .then(() => process.exit(0))
  .catch(() => process.exit(1));
```

### 2. Führe Pool Test aus
```bash
cd packages/db
npx tsx test-pool.ts
```

**Erwartung:**
```
Testing connection pool...
✅ All queries completed
   Executed 10 parallel queries
   First query: [ { num: 0, time: ... } ]
   Last query: [ { num: 9, time: ... } ]
```

## Test 4: Environment-basiertes Logging

### 1. Test Development Logging
```bash
cd packages/db

# Mit Development Environment
NODE_ENV=development npx tsx -e "
import { db } from './index';
db.\$queryRaw\`SELECT 'test' as msg\`
  .then(() => console.log('Check logs above for query details'))
  .catch(console.error)
  .finally(() => process.exit(0));
"
```

**Erwartung:** Detaillierte Query Logs sollten erscheinen

### 2. Test Production Logging
```bash
# Mit Production Environment
NODE_ENV=production npx tsx -e "
import { db } from './index';
db.\$queryRaw\`SELECT 'test' as msg\`
  .then(() => console.log('✅ Query completed (no logs in production)'))
  .catch(console.error)
  .finally(() => process.exit(0));
"
```

**Erwartung:** Keine Query Logs, nur Errors würden geloggt

## Test 5: Disconnect Test

### 1. Test Clean Disconnect
```bash
npx tsx -e "
import { db } from './index';

async function testDisconnect() {
  console.log('Connecting...');
  await db.\$connect();
  console.log('✅ Connected');
  
  console.log('Disconnecting...');
  await db.\$disconnect();
  console.log('✅ Disconnected cleanly');
}

testDisconnect()
  .then(() => process.exit(0))
  .catch((err) => {
    console.error('❌ Error:', err);
    process.exit(1);
  });
"
```

## Troubleshooting

### Problem: Connection Refused
```bash
# Prüfe DATABASE_URL
grep DATABASE_URL .env

# Teste direkte PostgreSQL Verbindung
psql $DATABASE_URL -c "SELECT 1"
```

### Problem: SSL Required (Neon)
Stelle sicher dass DATABASE_URL SSL Parameter hat:
```
DATABASE_URL="postgresql://user:pass@host/db?sslmode=require"
```

### Problem: Prisma Client nicht generiert
```bash
# Regeneriere Prisma Client
cd packages/db
npx prisma generate
```

### Problem: Connection Timeout
```bash
# Prüfe Netzwerk/Firewall
ping [your-database-host]

# Prüfe Port (meist 5432)
nc -zv [your-database-host] 5432
```

## Performance Metriken

### Connection Time Test
```bash
npx tsx -e "
import { db } from './index';
const start = Date.now();
db.\$queryRaw\`SELECT 1\`
  .then(() => {
    const time = Date.now() - start;
    console.log(\`✅ First query time: \${time}ms\`);
    if (time < 100) console.log('   Excellent performance!');
    else if (time < 500) console.log('   Good performance');
    else console.log('   ⚠️ Consider optimizing connection');
  })
  .finally(() => process.exit(0));
"
```

## Checkliste
- [ ] Basic SELECT 1 Query erfolgreich
- [ ] Prisma Models sind verfügbar
- [ ] Parallele Queries funktionieren
- [ ] Environment-basiertes Logging funktioniert
- [ ] Clean disconnect möglich
- [ ] Performance akzeptabel (<500ms erste Query)

## Nächster Schritt
→ [02.05 - Hot Reload Test](./02.05-hot-reload-test.md)

## Cleanup
```bash
# Lösche Test-Dateien
rm test-pool.ts
```