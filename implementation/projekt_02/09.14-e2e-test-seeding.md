# Teilaufgabe 09.14: Dediziertes E2E-Test-Seeding

## 🎯 Ziel
Erstellung eines separaten Seed-Skripts für E2E-Tests, um eine konsistente und vorhersagbare Datenbasis für Playwright-Tests zu schaffen.

## 🛠️ Implementierung

### Schritt 1: E2E-Seed-Skript erstellen
Erstellen Sie eine dedizierte Seed-Datei für E2E-Tests.

**Datei**: `packages/db/prisma/seed-e2e.ts`

```typescript
import { PrismaClient } from '../generated/prisma';

const prisma = new PrismaClient();

async function main() {
  console.log('🌱 Seeding E2E test database...');

  // 1. Datenbank leeren (in umgekehrter Reihenfolge der Abhängigkeiten)
  await prisma.$transaction([
    prisma.comment.deleteMany({}),
    prisma.post.deleteMany({}),
    prisma.profile.deleteMany({}),
    prisma.user.deleteMany({}),
  ]);

  console.log('✅ Database cleared');

  // 2. Spezifische Test-User erstellen
  const testUser = await prisma.user.create({
    data: {
      email: 'e2e-user@test.com',
      name: 'E2E Test User',
      role: 'USER',
      status: 'ACTIVE',
      clerkId: 'e2e_user_test_123',
      emailVerified: new Date(),
      profile: {
        create: {
          bio: 'Test user for E2E tests',
          website: 'https://example.com',
          location: 'Test City',
        },
      },
    },
    include: {
      profile: true,
    },
  });

  const adminUser = await prisma.user.create({
    data: {
      email: 'e2e-admin@test.com',
      name: 'E2E Admin User',
      role: 'ADMIN',
      status: 'ACTIVE',
      clerkId: 'e2e_admin_test_456',
      emailVerified: new Date(),
      profile: {
        create: {
          bio: 'Admin user for E2E tests',
        },
      },
    },
    include: {
      profile: true,
    },
  });

  console.log('✅ Test users created');

  // 3. Test-Posts erstellen
  const posts = await prisma.$transaction([
    prisma.post.create({
      data: {
        title: 'Published Test Post',
        slug: 'published-test-post',
        content: 'This is a published test post for E2E testing.',
        excerpt: 'Test excerpt',
        published: true,
        publishedAt: new Date(),
        authorId: testUser.id,
      },
    }),
    prisma.post.create({
      data: {
        title: 'Draft Test Post',
        slug: 'draft-test-post',
        content: 'This is a draft test post for E2E testing.',
        excerpt: 'Draft excerpt',
        published: false,
        authorId: testUser.id,
      },
    }),
    prisma.post.create({
      data: {
        title: 'Admin Test Post',
        slug: 'admin-test-post',
        content: 'This is an admin test post for E2E testing.',
        excerpt: 'Admin excerpt',
        published: true,
        publishedAt: new Date(),
        authorId: adminUser.id,
      },
    }),
  ]);

  console.log(`✅ ${posts.length} test posts created`);

  // 4. Test-Comments erstellen
  await prisma.comment.createMany({
    data: [
      {
        content: 'Test comment 1',
        postId: posts[0].id,
        authorId: adminUser.id,
        approved: true,
      },
      {
        content: 'Test comment 2',
        postId: posts[0].id,
        authorId: testUser.id,
        approved: true,
      },
      {
        content: 'Unapproved comment',
        postId: posts[0].id,
        authorId: testUser.id,
        approved: false,
      },
    ],
  });

  console.log('✅ Test comments created');

  // 5. Zusammenfassung ausgeben
  const summary = await prisma.$transaction([
    prisma.user.count(),
    prisma.post.count(),
    prisma.comment.count(),
  ]);

  console.log(`
📊 E2E Seed Summary:
- Users: ${summary[0]}
- Posts: ${summary[1]}
- Comments: ${summary[2]}

✅ E2E Seeding complete!
  `);
}

main()
  .catch((e) => {
    console.error('❌ E2E Seeding failed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

### Schritt 2: E2E Seed Helper Functions
Erstellen Sie Hilfsfunktionen für konsistente Test-Daten.

**Datei**: `packages/db/prisma/e2e-helpers.ts`

```typescript
export const E2E_USERS = {
  USER: {
    email: 'e2e-user@test.com',
    password: 'TestPassword123!',
    clerkId: 'e2e_user_test_123',
  },
  ADMIN: {
    email: 'e2e-admin@test.com',
    password: 'AdminPassword123!',
    clerkId: 'e2e_admin_test_456',
  },
} as const;

export const E2E_POSTS = {
  PUBLISHED: {
    slug: 'published-test-post',
    title: 'Published Test Post',
  },
  DRAFT: {
    slug: 'draft-test-post',
    title: 'Draft Test Post',
  },
  ADMIN: {
    slug: 'admin-test-post',
    title: 'Admin Test Post',
  },
} as const;

export function getE2EUser(role: 'USER' | 'ADMIN') {
  return E2E_USERS[role];
}

export function getE2EPost(type: keyof typeof E2E_POSTS) {
  return E2E_POSTS[type];
}
```

### Schritt 3: NPM-Skript hinzufügen
Fügen Sie in `packages/db/package.json` neue Scripts hinzu:

```json
{
  "scripts": {
    "seed": "tsx prisma/seed.ts",
    "seed:e2e": "tsx prisma/seed-e2e.ts",
    "db:reset:e2e": "prisma migrate reset --force --skip-seed && npm run seed:e2e"
  }
}
```

### Schritt 4: Root-Level E2E Scripts
Fügen Sie in der root `package.json` hinzu:

```json
{
  "scripts": {
    "test:db:seed:e2e": "cd packages/db && npm run seed:e2e",
    "test:db:reset": "cd packages/db && npx prisma migrate reset --force --skip-seed",
    "test:e2e:setup": "npm run test:db:reset && npm run test:db:seed:e2e",
    "test:e2e:local": "npm run test:e2e:setup && playwright test"
  }
}
```

### Schritt 5: Playwright-Konfiguration anpassen
Aktualisieren Sie `playwright.config.ts`:

```typescript
import { defineConfig, devices } from '@playwright/test';
import { E2E_USERS } from './packages/db/prisma/e2e-helpers';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: false, // Wichtig: Tests sequenziell für konsistente Daten
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: 1, // Ein Worker für konsistente Datenbank
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3004',
    trace: 'on-first-retry',
    // Test-User Credentials als Kontext
    storageState: undefined, // Wird in globalSetup gesetzt
  },
  projects: [
    {
      name: 'setup',
      testMatch: /.*\.setup\.ts/,
    },
    {
      name: 'chromium',
      use: { 
        ...devices['Desktop Chrome'],
      },
      dependencies: ['setup'],
    },
    {
      name: 'firefox',
      use: { 
        ...devices['Desktop Firefox'],
      },
      dependencies: ['setup'],
    },
  ],
  webServer: {
    command: process.env.CI
      ? 'npm run build && npm run start'
      : 'npm run test:e2e:setup && npm run dev',
    port: 3004,
    reuseExistingServer: !process.env.CI,
    timeout: 120 * 1000, // 2 Minuten für DB-Setup
  },
});
```

### Schritt 6: E2E Test Fixtures
Erstellen Sie wiederverwendbare Test-Fixtures.

**Datei**: `e2e/fixtures/auth.setup.ts`

```typescript
import { test as setup } from '@playwright/test';
import { E2E_USERS } from '../packages/db/prisma/e2e-helpers';

const authFile = 'e2e/.auth/user.json';
const adminAuthFile = 'e2e/.auth/admin.json';

setup('authenticate as user', async ({ page }) => {
  await page.goto('/sign-in');
  await page.fill('input[name="email"]', E2E_USERS.USER.email);
  await page.fill('input[name="password"]', E2E_USERS.USER.password);
  await page.click('button[type="submit"]');
  await page.waitForURL('/dashboard');
  
  // Speichere Authentication State
  await page.context().storageState({ path: authFile });
});

setup('authenticate as admin', async ({ page }) => {
  await page.goto('/sign-in');
  await page.fill('input[name="email"]', E2E_USERS.ADMIN.email);
  await page.fill('input[name="password"]', E2E_USERS.ADMIN.password);
  await page.click('button[type="submit"]');
  await page.waitForURL('/admin');
  
  // Speichere Authentication State
  await page.context().storageState({ path: adminAuthFile });
});
```

### Schritt 7: E2E Test mit vordefinierten Daten
Erstellen Sie Tests, die die konsistenten Test-Daten nutzen.

**Datei**: `e2e/posts.spec.ts`

```typescript
import { test, expect } from '@playwright/test';
import { E2E_POSTS } from '../packages/db/prisma/e2e-helpers';

test.describe('Posts', () => {
  test.use({ storageState: 'e2e/.auth/user.json' });

  test('should show published posts', async ({ page }) => {
    await page.goto('/posts');
    
    // Verifiziere, dass der published post sichtbar ist
    await expect(page.locator(`text="${E2E_POSTS.PUBLISHED.title}"`)).toBeVisible();
    
    // Verifiziere, dass der draft post NICHT sichtbar ist
    await expect(page.locator(`text="${E2E_POSTS.DRAFT.title}"`)).not.toBeVisible();
  });

  test('should navigate to post detail', async ({ page }) => {
    await page.goto('/posts');
    await page.click(`text="${E2E_POSTS.PUBLISHED.title}"`);
    
    await expect(page).toHaveURL(`/posts/${E2E_POSTS.PUBLISHED.slug}`);
    await expect(page.locator('h1')).toContainText(E2E_POSTS.PUBLISHED.title);
  });

  test('should show comments on published post', async ({ page }) => {
    await page.goto(`/posts/${E2E_POSTS.PUBLISHED.slug}`);
    
    // Sollte 2 genehmigte Kommentare zeigen
    const comments = page.locator('[data-testid="comment"]');
    await expect(comments).toHaveCount(2);
  });
});

test.describe('Admin Posts', () => {
  test.use({ storageState: 'e2e/.auth/admin.json' });

  test('admin should see all posts including drafts', async ({ page }) => {
    await page.goto('/admin/posts');
    
    // Admin sollte alle Posts sehen
    await expect(page.locator(`text="${E2E_POSTS.PUBLISHED.title}"`)).toBeVisible();
    await expect(page.locator(`text="${E2E_POSTS.DRAFT.title}"`)).toBeVisible();
    await expect(page.locator(`text="${E2E_POSTS.ADMIN.title}"`)).toBeVisible();
  });

  test('admin should see unapproved comments', async ({ page }) => {
    await page.goto('/admin/comments');
    
    // Admin sollte ungenehmigten Kommentar sehen
    await expect(page.locator('text="Unapproved comment"')).toBeVisible();
  });
});
```

## ✅ Verifizierung

### Test 1: E2E Seed ausführen
```bash
npm run test:db:seed:e2e
# Sollte erfolgreich seeden und Summary zeigen
```

### Test 2: E2E Tests mit Seed-Daten
```bash
npm run test:e2e:local
# Tests sollten mit konsistenten Daten laufen
```

### Test 3: CI-Pipeline
```bash
# In CI sollte automatisch geseeded werden
npm run test:e2e
```

## 📊 Erfolgskriterien
- [ ] Dediziertes E2E-Seed-Skript erstellt
- [ ] Konsistente Test-Daten definiert
- [ ] E2E-Helper für Datenzugriff
- [ ] Playwright nutzt vordefinierte Daten
- [ ] Auth-Setup für verschiedene Rollen
- [ ] Tests sind deterministisch und stabil

## ⚠️ Potentielle Probleme

### Problem: Datenbank-Konflikte zwischen Tests
**Lösung**: Tests sequenziell ausführen:
```typescript
fullyParallel: false,
workers: 1,
```

### Problem: Seed-Daten inkonsistent
**Lösung**: Immer vollständig resetten vor Seed:
```bash
npx prisma migrate reset --force --skip-seed
```

### Problem: Auth-State verloren
**Lösung**: Setup-Tests als Dependencies definieren:
```typescript
dependencies: ['setup'],
```

## ⏱️ Zeitschätzung
- E2E-Seed-Skript erstellen: 15 Minuten
- Helper-Functions: 10 Minuten
- NPM-Scripts: 5 Minuten
- Playwright-Integration: 15 Minuten
- Test-Fixtures: 10 Minuten
- Verifizierung: 10 Minuten
- **Total**: 65 Minuten

## 🔄 Rollback Plan
Falls E2E-Seeding Probleme verursacht:
1. Nutzen Sie das normale Seed-Skript: `npm run seed`
2. Oder verwenden Sie In-Test-Seeding mit Playwright

## 📝 Notizen
- E2E-Seed-Daten sollten minimal aber repräsentativ sein
- Verwenden Sie sprechende IDs und Namen für einfaches Debugging
- Halten Sie Test-User-Credentials konstant
- Dokumentieren Sie die Test-Daten für das Team
- Bei CI: Datenbank wird bei jedem Run neu geseeded