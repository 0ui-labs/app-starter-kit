# 02.02 - Singleton Pattern Implementation

## Ziel
Implementierung eines Turbopack-kompatiblen Singleton Patterns für PrismaClient.

## Voraussetzungen
- [ ] Schritt 02.01 abgeschlossen
- [ ] Backup von `index.ts` vorhanden

## Implementation

### 1. Öffne die Datei
```bash
# Navigiere zum db Package
cd packages/db
```

### 2. Implementiere Singleton Pattern

**Ersetze** den gesamten Inhalt von `packages/db/index.ts` mit:

```typescript
import { PrismaClient } from '@prisma/client';

// Turbopack-kompatibles Singleton Pattern für PrismaClient
// Nutzt globalThis mit speziellem Key für Turbopack Compatibility
declare global {
  // Turbopack nutzt module caching anders - braucht eindeutigen namespace
  var __prisma_client__: PrismaClient | undefined;
  var __prisma_client_dev_initialized__: boolean | undefined;
}

// Funktion zur Erstellung des Clients mit Turbopack-Detection
function createPrismaClient() {
  const client = new PrismaClient({
    log: process.env.NODE_ENV === 'development' 
      ? ['query', 'error', 'warn'] 
      : ['error'],
  });

  // Turbopack HMR Detection
  if (process.env.NODE_ENV === 'development') {
    // Registriere cleanup bei HMR
    if (typeof window === 'undefined' && !globalThis.__prisma_client_dev_initialized__) {
      globalThis.__prisma_client_dev_initialized__ = true;
      
      // Cleanup handler für Turbopack HMR
      process.on('beforeExit', async () => {
        await client.$disconnect();
      });
    }
  }

  return client;
}

// Export Singleton mit Turbopack-safe Pattern
export const db = globalThis.__prisma_client__ ?? createPrismaClient();

// Store in global nur in Development
if (process.env.NODE_ENV !== 'production') {
  globalThis.__prisma_client__ = db;
}

// Re-export Prisma Client types für Type Safety
export * from '@prisma/client';
```

### 3. Verifiziere die Änderung
```bash
# Prüfe ob die Datei korrekt gespeichert wurde
cat index.ts | head -20
```

### 4. TypeScript Compilation prüfen
```bash
# Prüfe ob TypeScript die Datei kompilieren kann
npx tsc --noEmit index.ts
```

**Erwartung:** Keine TypeScript Fehler

## Wichtige Details

### Warum dieses Pattern?

1. **globalThis statt global**: Funktioniert in allen JS Umgebungen
2. **Eindeutige Keys** (`__prisma_client__`): Verhindert Kollisionen
3. **Development-only Global Storage**: In Production wird jedes Mal neue Instanz erstellt (für Serverless)
4. **HMR Cleanup**: Verhindert Memory Leaks bei Hot Reload
5. **Environment-basiertes Logging**: Verbose in Dev, minimal in Prod

### Was passiert bei Hot Reload?

1. Turbopack behält `globalThis.__prisma_client__` bei
2. Keine neue Instanz wird erstellt
3. `beforeExit` Handler disconnected alte Connections
4. Memory bleibt stabil

## Troubleshooting

### TypeScript Error bei `global`
```typescript
// Falls TypeScript meckert, nutze dieses Pattern:
const globalForPrisma = global as unknown as {
  prisma: PrismaClient | undefined;
};
```

### Custom Prisma Output Path
Falls du einen custom output path hast (`packages/db/generated/prisma/`):
```typescript
import { PrismaClient } from './generated/prisma';
// Rest bleibt gleich
```

## Checkliste
- [ ] Datei `packages/db/index.ts` ersetzt
- [ ] TypeScript Compilation erfolgreich
- [ ] Keine Syntax-Fehler
- [ ] Import/Export statements korrekt

## Nächster Schritt
→ [02.03 - Singleton Test](./02.03-singleton-test.md)

## Rollback bei Problemen
```bash
# Original wiederherstellen
cp index.ts.backup index.ts
```