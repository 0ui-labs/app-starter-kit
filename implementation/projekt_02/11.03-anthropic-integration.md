# 11.03 Anthropic Integration

## Ziel
Implementierung des Anthropic Providers mit vollständiger Unterstützung für Claude 3 Modelle (Opus, Sonnet, Haiku).

## Umfang
- Anthropic SDK integration
- Claude 3 model support
- System prompts implementation
- XML formatting support
- Vision capabilities

## Tasks

### 1. Package Dependencies
```json
// packages/ai-adapter/package.json
{
  "dependencies": {
    "@anthropic-ai/sdk": "^0.x.x"
  }
}
```

### 2. Anthropic Provider Implementation
```typescript
// packages/ai-adapter/src/providers/anthropic.ts
import Anthropic from '@anthropic-ai/sdk';
import { BaseAIProvider } from '../base-provider';

export class AnthropicProvider extends BaseAIProvider {
  private anthropic: Anthropic;
  
  async initialize(config: AnthropicConfig): Promise<void> {
    this.anthropic = new Anthropic({
      apiKey: config.apiKey,
      baseURL: config.baseURL,
    });
    this.config = config;
  }
  
  async complete(request: CompletionRequest): Promise<CompletionResponse> {
    // Claude benötigt spezielle System-Message Behandlung
    const systemPrompt = this.extractSystemPrompt(request.messages);
    const userMessages = this.extractUserMessages(request.messages);
    
    const completion = await this.anthropic.messages.create({
      model: request.model || 'claude-3-opus-20240229',
      messages: this.formatMessages(userMessages),
      system: systemPrompt,
      max_tokens: request.maxTokens || 4096,
      temperature: request.temperature,
    });
    
    return this.formatResponse(completion);
  }
  
  async stream(request: CompletionRequest): AsyncIterableIterator<StreamChunk> {
    const systemPrompt = this.extractSystemPrompt(request.messages);
    const userMessages = this.extractUserMessages(request.messages);
    
    const stream = await this.anthropic.messages.stream({
      model: request.model || 'claude-3-opus-20240229',
      messages: this.formatMessages(userMessages),
      system: systemPrompt,
      max_tokens: request.maxTokens || 4096,
      stream: true,
    });
    
    for await (const chunk of stream) {
      yield this.formatStreamChunk(chunk);
    }
  }
}
```

### 3. Message Formatting (Claude-specific)
```typescript
private formatMessages(messages: Message[]): Anthropic.MessageParam[] {
  // Claude benötigt alternierende user/assistant messages
  const formatted: Anthropic.MessageParam[] = [];
  
  for (const msg of messages) {
    if (msg.role === 'system') {
      // System messages werden separat behandelt
      continue;
    }
    
    formatted.push({
      role: msg.role as 'user' | 'assistant',
      content: this.formatContent(msg.content, msg.images),
    });
  }
  
  return this.ensureAlternatingRoles(formatted);
}

private formatContent(
  content: string, 
  images?: Image[]
): Anthropic.ContentBlock[] {
  const blocks: Anthropic.ContentBlock[] = [];
  
  // Text content
  blocks.push({
    type: 'text',
    text: content,
  });
  
  // Image content (Vision)
  if (images) {
    for (const image of images) {
      blocks.push({
        type: 'image',
        source: {
          type: 'base64',
          media_type: image.mimeType,
          data: image.data,
        },
      });
    }
  }
  
  return blocks;
}
```

### 4. Claude-specific Features
```typescript
// XML formatting support
private wrapInXMLTags(content: string, tag: string): string {
  return `<${tag}>${content}</${tag}>`;
}

// Tool use formatting (Claude uses XML format)
private formatToolsForClaude(tools?: Tool[]): string {
  if (!tools) return '';
  
  return tools.map(tool => `
<tool>
  <name>${tool.name}</name>
  <description>${tool.description}</description>
  <parameters>${JSON.stringify(tool.parameters)}</parameters>
</tool>
  `).join('\n');
}
```

### 5. Model Configuration
```typescript
// packages/ai-adapter/src/providers/anthropic-models.ts
export const ANTHROPIC_MODELS = {
  'claude-3-opus': 'claude-3-opus-20240229',
  'claude-3-sonnet': 'claude-3-sonnet-20240229',
  'claude-3-haiku': 'claude-3-haiku-20240307',
  'claude-2.1': 'claude-2.1',
  'claude-instant': 'claude-instant-1.2',
} as const;

export const CLAUDE_CAPABILITIES = {
  'claude-3-opus': {
    maxTokens: 4096,
    contextWindow: 200000,
    supportsVision: true,
    supportsTools: true,
  },
  'claude-3-sonnet': {
    maxTokens: 4096,
    contextWindow: 200000,
    supportsVision: true,
    supportsTools: true,
  },
  'claude-3-haiku': {
    maxTokens: 4096,
    contextWindow: 200000,
    supportsVision: true,
    supportsTools: true,
  },
};
```

### 6. Error Handling
```typescript
protected handleAnthropicError(error: any): never {
  if (error instanceof Anthropic.APIError) {
    throw new AIProviderError({
      code: error.status,
      message: error.message,
      provider: 'anthropic',
      retryable: this.isRetryableError(error),
    });
  }
  
  // Rate limit specific handling
  if (error.status === 429) {
    const retryAfter = error.headers?.['retry-after'];
    throw new RateLimitError({
      provider: 'anthropic',
      retryAfter: parseInt(retryAfter) || 60,
    });
  }
  
  throw error;
}
```

## Dateien zu erstellen/ändern
- `packages/ai-adapter/src/providers/anthropic.ts` - Main implementation
- `packages/ai-adapter/src/providers/anthropic-models.ts` - Model configurations
- `packages/ai-adapter/src/providers/anthropic-types.ts` - Anthropic specific types
- `packages/ai-adapter/package.json` - Add Anthropic dependency

## Akzeptanzkriterien
- [ ] Anthropic SDK korrekt integriert
- [ ] Claude 3 Modelle (Opus, Sonnet, Haiku) unterstützt
- [ ] System prompts korrekt verarbeitet
- [ ] Vision capabilities implementiert
- [ ] Alternierende message roles sichergestellt
- [ ] XML formatting für tools unterstützt
- [ ] Streaming funktioniert
- [ ] Tests für alle Hauptfunktionen

## Abhängigkeiten
- Task 11.01 (Provider Abstraction) muss abgeschlossen sein
- Anthropic API Key in environment variables
- @anthropic-ai/sdk npm package

## Geschätzter Aufwand
60-75 Minuten