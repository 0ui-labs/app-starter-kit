# Teilaufgabe 09.13: Pre-Commit Hooks einrichten

## ğŸ¯ Ziel
Einrichtung von Pre-Commit-Hooks mit Husky und lint-staged, um sicherzustellen, dass nur qualitativ hochwertiger Code (gelintet, formatiert, ohne Typfehler) committet werden kann.

## ğŸ› ï¸ Implementierung

### Schritt 1: Dependencies installieren
```bash
npm install --save-dev husky lint-staged
```

### Schritt 2: Husky initialisieren
```bash
npx husky init
```
Dieser Befehl:
- Erstellt einen `.husky`-Ordner
- FÃ¼gt `"prepare": "husky"` zu den Scripts hinzu
- Erstellt eine Beispiel pre-commit Hook

### Schritt 3: lint-staged konfigurieren
FÃ¼gen Sie den folgenden Block zu Ihrer root `package.json` hinzu:

```json
{
  "lint-staged": {
    "*.{ts,tsx}": [
      "eslint --fix",
      "vitest related --run"
    ],
    "*.{js,jsx}": [
      "eslint --fix"
    ],
    "*.{json,md}": [
      "prettier --write"
    ]
  }
}
```

### Schritt 4: Pre-Commit-Hook anpassen
Ã„ndern Sie die Datei `.husky/pre-commit`:

```bash
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

npx lint-staged
```

### Schritt 5: Pre-Push-Hook hinzufÃ¼gen (Optional)
Erstellen Sie `.husky/pre-push` fÃ¼r Tests vor dem Push:

```bash
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Run type checks
npm run typecheck

# Run tests
npm run test:run
```

Machen Sie die Datei ausfÃ¼hrbar:
```bash
chmod +x .husky/pre-push
```

### Schritt 6: Prettier installieren und konfigurieren
```bash
npm install --save-dev prettier
```

Erstellen Sie `.prettierrc`:
```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false
}
```

Erstellen Sie `.prettierignore`:
```
node_modules
.next
dist
.turbo
coverage
*.min.js
*.min.css
generated
```

### Schritt 7: ESLint fÃ¼r automatische Fixes konfigurieren
Stellen Sie sicher, dass ESLint mit `--fix` Flag konfiguriert ist. Update `.eslintrc.json`:

```json
{
  "extends": ["next/core-web-vitals"],
  "rules": {
    "no-unused-vars": "error",
    "no-console": ["warn", { "allow": ["warn", "error"] }],
    "@typescript-eslint/no-explicit-any": "warn"
  }
}
```

## âœ… Verifizierung

### Test 1: Commit mit Linting-Fehler
```bash
# Erstelle eine Datei mit Linting-Fehler
echo "const unused = 'test';" > test.ts

# Versuche zu committen
git add test.ts
git commit -m "Test commit"
# Sollte fehlschlagen oder automatisch fixen
```

### Test 2: Automatische Formatierung
```bash
# Erstelle eine schlecht formatierte Datei
echo "const x={a:1,b:2}" > format-test.ts

git add format-test.ts
git commit -m "Test formatting"
# Datei sollte automatisch formatiert werden
```

### Test 3: Type-Check beim Push
```bash
# Erstelle eine Datei mit Type-Fehler
echo "const x: string = 123;" > type-error.ts

git add type-error.ts
git commit -m "Type error test"
git push
# Push sollte fehlschlagen
```

## ğŸ“Š Erfolgskriterien
- [ ] Husky erfolgreich installiert und initialisiert
- [ ] lint-staged konfiguriert
- [ ] Pre-commit Hook verhindert Commits mit Fehlern
- [ ] ESLint fixes werden automatisch angewendet
- [ ] Prettier formatiert Code automatisch
- [ ] Pre-push Hook fÃ¼hrt Tests aus (optional)
- [ ] Alle Entwickler im Team haben Hooks aktiv

## âš ï¸ Potentielle Probleme

### Problem: Husky Hooks werden nicht ausgefÃ¼hrt
**LÃ¶sung**: FÃ¼hren Sie `npm run prepare` aus:
```bash
npm run prepare
```

### Problem: Windows Line Ending Issues
**LÃ¶sung**: Konfigurieren Sie Git fÃ¼r konsistente Line Endings:
```bash
git config core.autocrlf false
```

### Problem: Hooks zu langsam
**LÃ¶sung**: Optimieren Sie lint-staged Patterns:
```json
{
  "lint-staged": {
    "*.{ts,tsx}": [
      "eslint --fix --max-warnings 0",
      "bash -c 'vitest related --run $@' --"
    ]
  }
}
```

### Problem: CI umgeht Hooks
**LÃ¶sung**: Das ist gewollt! CI hat eigene Checks. Hooks sind nur fÃ¼r lokale Entwicklung.

## â±ï¸ ZeitschÃ¤tzung
- Dependencies installieren: 5 Minuten
- Husky Setup: 5 Minuten
- lint-staged Konfiguration: 10 Minuten
- Prettier Setup: 5 Minuten
- Testing und Debugging: 10 Minuten
- **Total**: 35 Minuten

## ğŸ”„ Rollback Plan
Falls Hooks Probleme verursachen:
1. TemporÃ¤r deaktivieren: `HUSKY=0 git commit`
2. Komplett entfernen: `rm -rf .husky && npm uninstall husky lint-staged`

## ğŸ“ Notizen
- Hooks laufen nur bei lokalen Commits, nicht in CI
- `--no-verify` Flag umgeht Hooks (nur im Notfall verwenden!)
- Team-Mitglieder mÃ¼ssen `npm install` ausfÃ¼hren, um Hooks zu aktivieren
- Hooks kÃ¶nnen projektspezifisch angepasst werden