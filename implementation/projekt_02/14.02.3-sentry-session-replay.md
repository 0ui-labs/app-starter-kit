# Sub-Task 14.02.3: Sentry Session Replay

## Ziel
Implementierung von Sentry Session Replay fÃ¼r visuelle Reproduktion von User Sessions und Errors. Privacy-konforme Konfiguration mit Maskierung sensibler Daten.

## Voraussetzungen
- Sentry Base Setup abgeschlossen (14.02.1)
- Sentry Session Replay Add-on aktiviert
- Understanding von Privacy Compliance (DSGVO)

## Umfang
- Session Replay Integration
- Privacy Settings und Maskierung
- Replay Sampling Strategien
- Error-triggered Replay
- Rage Click Detection
- Custom Privacy Rules
- Network Request Masking
- Console Log Capture

## Implementierung

### 1. Session Replay Configuration

`apps/web/sentry.client.config.ts` (Erweiterung):
```typescript
import * as Sentry from '@sentry/nextjs';
import { replayIntegration } from '@sentry/nextjs';

Sentry.init({
  // ... existing config
  
  // Session Replay sampling
  replaysSessionSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0, // 10% of sessions
  replaysOnErrorSampleRate: 1.0, // 100% of sessions with errors
  
  integrations: [
    // ... existing integrations
    
    // Session Replay with privacy settings
    replayIntegration({
      // Mask all text content by default
      maskAllText: true,
      
      // Mask all inputs
      maskAllInputs: true,
      
      // Block specific CSS classes from replay
      blockClass: 'sentry-block',
      
      // Ignore specific CSS classes (won't be masked)
      ignoreClass: 'sentry-ignore',
      
      // Block specific elements
      blockSelector: '[data-sentry-block]',
      
      // Mask specific elements
      maskTextSelector: '[data-sentry-mask]',
      
      // Network request/response masking
      networkDetailAllowUrls: [
        window.location.origin,
      ],
      
      // Capture network request/response bodies
      networkCaptureBodies: true,
      
      // Network request headers to capture
      networkRequestHeaders: ['Content-Type', 'Accept'],
      
      // Network response headers to capture
      networkResponseHeaders: ['Content-Type', 'Cache-Control'],
      
      // Slow click detection (rage clicks)
      slowClickTimeout: 3000,
      
      // Ignore interactions on these selectors
      ignoreSelector: '[data-sentry-ignore-interaction]',
      
      // Custom privacy rules
      beforeAddRecordingEvent: (event) => {
        // Filter out sensitive events
        if (event.data?.tag === 'sensitive') {
          return null;
        }
        return event;
      },
      
      // Mutation limit
      mutationLimit: 750,
      
      // Error sampling
      errorSampleRate: 1.0,
      
      // Session duration
      sessionSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
    }),
  ],
});
```

### 2. Privacy Utilities

`apps/web/src/lib/monitoring/privacy-utils.ts`:
```typescript
/**
 * Privacy utilities for Session Replay
 */

// CSS classes for privacy control
export const PRIVACY_CLASSES = {
  BLOCK: 'sentry-block', // Completely hide element
  MASK: 'sentry-mask', // Mask text content
  IGNORE: 'sentry-ignore', // Don't mask (use carefully)
  IGNORE_INTERACTION: 'sentry-ignore-interaction', // Ignore clicks/interactions
} as const;

// Data attributes for privacy control
export const PRIVACY_ATTRIBUTES = {
  BLOCK: 'data-sentry-block',
  MASK: 'data-sentry-mask',
  IGNORE: 'data-sentry-ignore',
} as const;

/**
 * HOC to apply privacy settings to components
 */
export function withPrivacy<P extends object>(
  Component: React.ComponentType<P>,
  privacy: 'block' | 'mask' | 'ignore' = 'mask'
): React.ComponentType<P> {
  return (props: P) => {
    const className = PRIVACY_CLASSES[privacy.toUpperCase() as keyof typeof PRIVACY_CLASSES];
    
    return (
      <div className={className}>
        <Component {...props} />
      </div>
    );
  };
}

/**
 * Hook for dynamic privacy control
 */
export function usePrivacyControl() {
  const setPrivacy = (
    element: HTMLElement | null,
    level: 'block' | 'mask' | 'ignore'
  ) => {
    if (!element) return;
    
    // Remove all privacy classes
    Object.values(PRIVACY_CLASSES).forEach(cls => {
      element.classList.remove(cls);
    });
    
    // Add new privacy class
    const className = PRIVACY_CLASSES[level.toUpperCase() as keyof typeof PRIVACY_CLASSES];
    element.classList.add(className);
  };
  
  return { setPrivacy, PRIVACY_CLASSES };
}
```

### 3. Privacy-Aware Components

`apps/web/src/components/privacy/sensitive-input.tsx`:
```typescript
'use client';

import { forwardRef, InputHTMLAttributes } from 'react';
import { PRIVACY_CLASSES } from '@/lib/monitoring/privacy-utils';

interface SensitiveInputProps extends InputHTMLAttributes<HTMLInputElement> {
  maskInReplay?: boolean;
  label?: string;
}

export const SensitiveInput = forwardRef<HTMLInputElement, SensitiveInputProps>(
  ({ maskInReplay = true, label, className = '', ...props }, ref) => {
    const privacyClass = maskInReplay ? PRIVACY_CLASSES.MASK : '';
    
    return (
      <div className="flex flex-col">
        {label && (
          <label className="text-sm font-medium text-gray-700 mb-1">
            {label}
          </label>
        )}
        <input
          ref={ref}
          className={`${privacyClass} ${className} px-3 py-2 border rounded-md`}
          data-sentry-mask={maskInReplay ? 'true' : undefined}
          {...props}
        />
      </div>
    );
  }
);

SensitiveInput.displayName = 'SensitiveInput';
```

`apps/web/src/components/privacy/private-section.tsx`:
```typescript
'use client';

import { ReactNode } from 'react';
import { PRIVACY_CLASSES, PRIVACY_ATTRIBUTES } from '@/lib/monitoring/privacy-utils';

interface PrivateSectionProps {
  children: ReactNode;
  level?: 'block' | 'mask' | 'none';
  className?: string;
}

export function PrivateSection({
  children,
  level = 'mask',
  className = '',
}: PrivateSectionProps) {
  if (level === 'none') {
    return <div className={className}>{children}</div>;
  }
  
  const privacyClass = level === 'block' 
    ? PRIVACY_CLASSES.BLOCK 
    : PRIVACY_CLASSES.MASK;
  
  const privacyAttr = level === 'block'
    ? { [PRIVACY_ATTRIBUTES.BLOCK]: 'true' }
    : { [PRIVACY_ATTRIBUTES.MASK]: 'true' };
  
  return (
    <div 
      className={`${privacyClass} ${className}`}
      {...privacyAttr}
    >
      {children}
    </div>
  );
}
```

### 4. Replay Control Component

`apps/web/src/components/monitoring/replay-control.tsx`:
```typescript
'use client';

import { useState, useEffect } from 'react';
import * as Sentry from '@sentry/nextjs';

export function ReplayControl() {
  const [isRecording, setIsRecording] = useState(false);
  const [replayId, setReplayId] = useState<string | null>(null);
  
  useEffect(() => {
    const replay = Sentry.getReplay();
    if (replay) {
      setIsRecording(replay.isRecording());
      
      // Get current replay session ID
      const session = replay.getReplayId();
      setReplayId(session);
    }
  }, []);
  
  const handleStop = () => {
    const replay = Sentry.getReplay();
    replay?.stop();
    setIsRecording(false);
  };
  
  const handleStart = () => {
    const replay = Sentry.getReplay();
    replay?.start();
    setIsRecording(true);
  };
  
  const handleFlush = () => {
    // Force upload current replay buffer
    const replay = Sentry.getReplay();
    replay?.flush();
  };
  
  if (process.env.NODE_ENV === 'production') {
    return null; // Don't show in production
  }
  
  return (
    <div className="fixed bottom-4 right-4 bg-white shadow-lg rounded-lg p-4 z-50">
      <h3 className="text-sm font-semibold mb-2">Session Replay Control</h3>
      
      <div className="space-y-2">
        <div className="flex items-center">
          <span className={`w-2 h-2 rounded-full mr-2 ${
            isRecording ? 'bg-red-500 animate-pulse' : 'bg-gray-400'
          }`} />
          <span className="text-sm">
            {isRecording ? 'Recording' : 'Not Recording'}
          </span>
        </div>
        
        {replayId && (
          <div className="text-xs text-gray-600">
            Session: {replayId.substring(0, 8)}...
          </div>
        )}
        
        <div className="flex gap-2">
          {isRecording ? (
            <>
              <button
                onClick={handleStop}
                className="px-3 py-1 text-xs bg-red-500 text-white rounded"
              >
                Stop
              </button>
              <button
                onClick={handleFlush}
                className="px-3 py-1 text-xs bg-blue-500 text-white rounded"
              >
                Flush
              </button>
            </>
          ) : (
            <button
              onClick={handleStart}
              className="px-3 py-1 text-xs bg-green-500 text-white rounded"
            >
              Start
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
```

### 5. Custom Replay Triggers

`apps/web/src/lib/monitoring/replay-triggers.ts`:
```typescript
import * as Sentry from '@sentry/nextjs';

/**
 * Start replay on specific user actions
 */
export function startReplayOnError() {
  const replay = Sentry.getReplay();
  
  if (replay && !replay.isRecording()) {
    replay.start();
    
    // Add context
    Sentry.setContext('replay_trigger', {
      reason: 'error_occurred',
      timestamp: new Date().toISOString(),
    });
  }
}

/**
 * Start replay for specific user segments
 */
export function conditionalReplayStart(user: {
  id: string;
  email: string;
  isPremium?: boolean;
  isInternalUser?: boolean;
}) {
  const replay = Sentry.getReplay();
  
  if (!replay) return;
  
  // Always record internal users for debugging
  if (user.isInternalUser) {
    replay.start();
    Sentry.setTag('replay.reason', 'internal_user');
    return;
  }
  
  // Record premium users more frequently
  if (user.isPremium) {
    const shouldRecord = Math.random() < 0.5; // 50% sampling
    if (shouldRecord) {
      replay.start();
      Sentry.setTag('replay.reason', 'premium_user_sample');
    }
    return;
  }
  
  // Regular users: only on error
  // Handled by replaysOnErrorSampleRate
}

/**
 * Detect and report rage clicks
 */
export function setupRageClickDetection() {
  let clickCount = 0;
  let lastClickTime = 0;
  let lastTarget: EventTarget | null = null;
  
  document.addEventListener('click', (event) => {
    const now = Date.now();
    const timeDiff = now - lastClickTime;
    
    // Reset if different target or too much time passed
    if (event.target !== lastTarget || timeDiff > 1000) {
      clickCount = 1;
      lastTarget = event.target;
    } else {
      clickCount++;
      
      // Rage click detected
      if (clickCount >= 5) {
        const replay = Sentry.getReplay();
        
        // Start replay if not already recording
        if (replay && !replay.isRecording()) {
          replay.start();
        }
        
        // Log rage click event
        Sentry.addBreadcrumb({
          category: 'ui.rage-click',
          message: `Rage click detected on ${(event.target as HTMLElement).tagName}`,
          level: 'warning',
          data: {
            clickCount,
            element: (event.target as HTMLElement).outerHTML.substring(0, 100),
          },
        });
        
        // Reset counter
        clickCount = 0;
      }
    }
    
    lastClickTime = now;
  });
}
```

### 6. Form with Privacy Controls

`apps/web/src/components/forms/user-profile-form.tsx`:
```typescript
'use client';

import { useState } from 'react';
import { SensitiveInput } from '@/components/privacy/sensitive-input';
import { PrivateSection } from '@/components/privacy/private-section';
import * as Sentry from '@sentry/nextjs';

export function UserProfileForm() {
  const [formData, setFormData] = useState({
    email: '',
    name: '',
    phone: '',
    ssn: '',
    notes: '',
  });
  
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    // Add breadcrumb without sensitive data
    Sentry.addBreadcrumb({
      category: 'form',
      message: 'User profile form submitted',
      level: 'info',
      // Don't include actual form data
      data: {
        formId: 'user-profile',
        timestamp: new Date().toISOString(),
      },
    });
    
    // Process form...
  };
  
  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <h2 className="text-xl font-bold">User Profile</h2>
      
      {/* Public information - can be shown in replay */}
      <SensitiveInput
        label="Name"
        value={formData.name}
        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
        maskInReplay={false}
        placeholder="John Doe"
      />
      
      {/* Semi-sensitive - masked in replay */}
      <SensitiveInput
        label="Email"
        type="email"
        value={formData.email}
        onChange={(e) => setFormData({ ...formData, email: e.target.value })}
        maskInReplay={true}
        placeholder="john@example.com"
      />
      
      {/* Sensitive section - completely blocked */}
      <PrivateSection level="block">
        <SensitiveInput
          label="Social Security Number"
          value={formData.ssn}
          onChange={(e) => setFormData({ ...formData, ssn: e.target.value })}
          maskInReplay={true}
          placeholder="XXX-XX-XXXX"
          pattern="[0-9]{3}-[0-9]{2}-[0-9]{4}"
        />
      </PrivateSection>
      
      {/* Masked text area */}
      <div>
        <label className="text-sm font-medium text-gray-700 mb-1 block">
          Notes
        </label>
        <textarea
          className="sentry-mask w-full px-3 py-2 border rounded-md"
          rows={4}
          value={formData.notes}
          onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
          placeholder="Additional notes..."
        />
      </div>
      
      <button
        type="submit"
        className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
      >
        Save Profile
      </button>
    </form>
  );
}
```

### 7. Replay Context Provider

`apps/web/src/providers/replay-provider.tsx`:
```typescript
'use client';

import { createContext, useContext, useEffect, useState } from 'react';
import * as Sentry from '@sentry/nextjs';
import { setupRageClickDetection } from '@/lib/monitoring/replay-triggers';

interface ReplayContextType {
  isRecording: boolean;
  replayId: string | null;
  startRecording: () => void;
  stopRecording: () => void;
}

const ReplayContext = createContext<ReplayContextType | null>(null);

export function ReplayProvider({ children }: { children: React.ReactNode }) {
  const [isRecording, setIsRecording] = useState(false);
  const [replayId, setReplayId] = useState<string | null>(null);
  
  useEffect(() => {
    // Setup rage click detection
    setupRageClickDetection();
    
    // Check initial recording state
    const replay = Sentry.getReplay();
    if (replay) {
      setIsRecording(replay.isRecording());
      setReplayId(replay.getReplayId());
      
      // Listen for replay updates
      const checkRecordingStatus = setInterval(() => {
        setIsRecording(replay.isRecording());
        setReplayId(replay.getReplayId());
      }, 1000);
      
      return () => clearInterval(checkRecordingStatus);
    }
  }, []);
  
  const startRecording = () => {
    const replay = Sentry.getReplay();
    replay?.start();
    setIsRecording(true);
  };
  
  const stopRecording = () => {
    const replay = Sentry.getReplay();
    replay?.stop();
    setIsRecording(false);
  };
  
  return (
    <ReplayContext.Provider
      value={{
        isRecording,
        replayId,
        startRecording,
        stopRecording,
      }}
    >
      {children}
    </ReplayContext.Provider>
  );
}

export function useReplay() {
  const context = useContext(ReplayContext);
  if (!context) {
    throw new Error('useReplay must be used within ReplayProvider');
  }
  return context;
}
```

### 8. Testing Session Replay

`apps/web/src/app/test-replay/page.tsx`:
```typescript
'use client';

import { useState } from 'react';
import { UserProfileForm } from '@/components/forms/user-profile-form';
import { ReplayControl } from '@/components/monitoring/replay-control';
import { PrivateSection } from '@/components/privacy/private-section';
import * as Sentry from '@sentry/nextjs';

export default function TestReplay() {
  const [showSensitive, setShowSensitive] = useState(false);
  
  const triggerError = () => {
    try {
      throw new Error('Test error for Session Replay');
    } catch (error) {
      Sentry.captureException(error);
    }
  };
  
  const simulateRageClick = () => {
    const button = document.getElementById('rage-target');
    if (button) {
      for (let i = 0; i < 6; i++) {
        setTimeout(() => button.click(), i * 100);
      }
    }
  };
  
  return (
    <div className="p-8 max-w-4xl mx-auto">
      <h1 className="text-2xl font-bold mb-6">Session Replay Testing</h1>
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <h2 className="text-lg font-semibold mb-4">Test Controls</h2>
          
          <div className="space-y-4">
            <button
              onClick={triggerError}
              className="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
            >
              Trigger Error (Starts Replay)
            </button>
            
            <button
              id="rage-target"
              onClick={() => console.log('Click')}
              className="w-full px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600"
            >
              Rage Click Target
            </button>
            
            <button
              onClick={simulateRageClick}
              className="w-full px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600"
            >
              Simulate Rage Click
            </button>
            
            <button
              onClick={() => setShowSensitive(!showSensitive)}
              className="w-full px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
            >
              Toggle Sensitive Data
            </button>
          </div>
        </div>
        
        <div>
          <h2 className="text-lg font-semibold mb-4">Privacy Demo</h2>
          
          {/* Public content */}
          <div className="mb-4 p-4 bg-green-50 rounded">
            <p className="text-sm text-green-800">
              This content is visible in replays
            </p>
          </div>
          
          {/* Masked content */}
          <PrivateSection level="mask" className="mb-4 p-4 bg-yellow-50 rounded">
            <p className="text-sm text-yellow-800">
              This text is masked in replays: user@example.com
            </p>
          </PrivateSection>
          
          {/* Blocked content */}
          <PrivateSection level="block" className="mb-4 p-4 bg-red-50 rounded">
            <p className="text-sm text-red-800">
              This entire section is hidden: SSN 123-45-6789
            </p>
          </PrivateSection>
          
          {showSensitive && (
            <PrivateSection level="block" className="mt-4">
              <div className="p-4 bg-red-100 rounded">
                <p className="font-bold">Sensitive Information:</p>
                <p>Credit Card: 4111-1111-1111-1111</p>
                <p>Password: super_secret_123</p>
              </div>
            </PrivateSection>
          )}
        </div>
      </div>
      
      <div className="mt-8">
        <UserProfileForm />
      </div>
      
      <ReplayControl />
    </div>
  );
}
```

## Erfolgskriterien
- [ ] Session Replay Integration aktiv
- [ ] Privacy Maskierung funktioniert
- [ ] Sensitive Daten werden geblockt
- [ ] Error-triggered Replay funktioniert
- [ ] Rage Click Detection aktiv
- [ ] Network Requests werden erfasst
- [ ] Console Logs werden aufgezeichnet
- [ ] Replay Sessions in Sentry Dashboard sichtbar
- [ ] DSGVO-konforme Konfiguration

## ZeitschÃ¤tzung
- **Total: 25 Minuten**
  - Replay Configuration: 5 Min
  - Privacy Utilities: 5 Min
  - Privacy Components: 5 Min
  - Replay Controls: 5 Min
  - Testing und Verifikation: 5 Min

## NÃ¤chster Schritt
Nach Session Replay â [14.02.4 User Feedback](./14.02.4-sentry-user-feedback.md)