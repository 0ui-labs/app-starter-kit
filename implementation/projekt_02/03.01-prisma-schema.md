# Arbeitspaket 03.01: Prisma Schema Implementation

## Ziel
Implementierung eines vollständigen Prisma Schemas mit allen notwendigen Models für User Management, Content Management und Audit Logging.

## Kontext
- **Package**: `@starter-kit/db`
- **Schema Location**: `packages/db/prisma/schema.prisma`
- **Database**: PostgreSQL (Neon in Production)
- **Prisma Version**: 5.21.0

## Implementierung

### Vollständiges Prisma Schema
Update `packages/db/prisma/schema.prisma`:

```prisma
generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PERMISSION_CHANGE
}

// User Management
model User {
  id              String      @id @default(uuid())
  email           String      @unique
  name            String?
  role            UserRole    @default(USER)
  status          UserStatus  @default(ACTIVE)
  emailVerified   DateTime?
  image           String?
  
  // Clerk Integration
  clerkId         String?     @unique
  
  // Profile
  profile         Profile?
  
  // Relations
  posts           Post[]
  comments        Comment[]
  sessions        Session[]
  auditLogs       AuditLog[]
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?
  
  // Indexes
  @@index([email])
  @@index([clerkId])
  @@index([status])
  @@index([createdAt])
  @@map("users")
}

model Profile {
  id              String      @id @default(uuid())
  userId          String      @unique
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Profile Data
  bio             String?
  website         String?
  location        String?
  company         String?
  
  // Social Links
  twitter         String?
  github          String?
  linkedin        String?
  
  // Settings
  settings        Json        @default("{}")
  preferences     Json        @default("{}")
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@map("profiles")
}

// Session Management
model Session {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token           String      @unique
  userAgent       String?
  ip              String?
  
  expiresAt       DateTime
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// Content Management
model Post {
  id              String      @id @default(uuid())
  authorId        String
  author          User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  title           String
  slug            String      @unique
  content         String
  excerpt         String?
  
  published       Boolean     @default(false)
  publishedAt     DateTime?
  
  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String[]
  
  // Relations
  tags            Tag[]
  comments        Comment[]
  
  // Stats
  views           Int         @default(0)
  likes           Int         @default(0)
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?
  
  @@index([authorId])
  @@index([slug])
  @@index([published])
  @@index([publishedAt])
  @@index([createdAt])
  @@map("posts")
}

model Comment {
  id              String      @id @default(uuid())
  postId          String
  post            Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId        String
  author          User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  content         String
  
  // Nested comments
  parentId        String?
  parent          Comment?    @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         Comment[]   @relation("CommentReplies")
  
  // Moderation
  approved        Boolean     @default(true)
  flagged         Boolean     @default(false)
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?
  
  @@index([postId])
  @@index([authorId])
  @@index([parentId])
  @@index([approved])
  @@map("comments")
}

model Tag {
  id              String      @id @default(uuid())
  name            String      @unique
  slug            String      @unique
  description     String?
  
  posts           Post[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([slug])
  @@map("tags")
}

// Audit & Logging
model AuditLog {
  id              String      @id @default(uuid())
  userId          String?
  user            User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action          AuditAction
  entity          String      // Table name
  entityId        String?     // Record ID
  
  oldValues       Json?
  newValues       Json?
  
  ip              String?
  userAgent       String?
  
  createdAt       DateTime    @default(now())
  
  @@index([userId])
  @@index([entity])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// API Keys Management
model ApiKey {
  id              String      @id @default(uuid())
  name            String
  key             String      @unique
  
  // Permissions
  scopes          String[]    @default([])
  
  // Rate Limiting
  rateLimit       Int         @default(1000) // requests per hour
  
  // Usage
  lastUsedAt      DateTime?
  usageCount      Int         @default(0)
  
  // Validity
  expiresAt       DateTime?
  revokedAt       DateTime?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([key])
  @@index([expiresAt])
  @@map("api_keys")
}

// Webhook Events
model WebhookEvent {
  id              String      @id @default(uuid())
  
  event           String
  payload         Json
  
  // Delivery
  url             String
  headers         Json?
  
  // Status
  delivered       Boolean     @default(false)
  attempts        Int         @default(0)
  lastAttemptAt   DateTime?
  deliveredAt     DateTime?
  
  // Error tracking
  lastError       String?
  
  createdAt       DateTime    @default(now())
  
  @@index([event])
  @@index([delivered])
  @@index([createdAt])
  @@map("webhook_events")
}
```

## Features

### Models Overview
- **User Management**: User, Profile, Session
- **Content Management**: Post, Comment, Tag
- **System**: AuditLog, ApiKey, WebhookEvent

### Key Features
- Soft Delete Support (deletedAt fields)
- Audit Logging Vorbereitung
- Session Management
- API Key Management
- Webhook Event Tracking
- Hierarchische Kommentare
- Tag System
- User Rollen und Status

### Indexes
- Performance-optimierte Indexes auf häufig genutzte Felder
- Composite Indexes für komplexe Queries
- Unique Constraints für Business Logic

## Verifizierung

```bash
cd packages/db
npx prisma validate
```

## Erfolgskriterien
- [ ] Schema ohne Validation Errors
- [ ] Alle Relations korrekt definiert
- [ ] Cascade Rules implementiert
- [ ] Indexes für Performance
- [ ] Enums für Type Safety
- [ ] Soft Delete vorbereitet