# Arbeitspaket 03.03: Seed Data Implementation

## Ziel
Erstellung eines Seed Scripts für konsistente Test-Daten in der Entwicklungsumgebung.

## Kontext
- **Package**: `@starter-kit/db`
- **Location**: `packages/db/prisma/seed.ts`
- **Runner**: tsx (TypeScript Execute)
- **Purpose**: Entwicklungs- und Test-Daten

## Implementierung

### Seed Script
Erstelle `packages/db/prisma/seed.ts`:

```typescript
import { PrismaClient, UserRole, UserStatus, AuditAction } from '../generated/prisma';
import { randomBytes } from 'crypto';

const prisma = new PrismaClient();

// Helper für sichere API Keys
function generateApiKey(prefix = 'sk_test'): string {
  const random = randomBytes(24).toString('base64')
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=/g, '');
  return `${prefix}_${random}`;
}

// Helper für Slugs
function createSlug(text: string): string {
  return text
    .toLowerCase()
    .replace(/[^\w\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .trim();
}

async function clearDatabase() {
  console.log('🧹 Clearing existing data...');
  
  // Delete in correct order (respecting relations)
  await prisma.webhookEvent.deleteMany();
  await prisma.apiKey.deleteMany();
  await prisma.auditLog.deleteMany();
  await prisma.comment.deleteMany();
  await prisma.post.deleteMany();
  await prisma.tag.deleteMany();
  await prisma.session.deleteMany();
  await prisma.profile.deleteMany();
  await prisma.user.deleteMany();
  
  console.log('✅ Database cleared');
}

async function seedUsers() {
  console.log('👤 Creating users...');
  
  // Admin User
  const adminUser = await prisma.user.create({
    data: {
      email: 'admin@example.com',
      name: 'Admin User',
      role: UserRole.ADMIN,
      status: UserStatus.ACTIVE,
      emailVerified: new Date(),
      clerkId: 'clerk_admin_123',
      profile: {
        create: {
          bio: 'System Administrator',
          location: 'Berlin, Germany',
          company: 'Starter Kit Inc.',
          website: 'https://example.com',
          github: 'admin',
          twitter: 'admin',
          linkedin: 'admin-user',
          settings: {
            theme: 'dark',
            notifications: {
              email: true,
              push: true,
              sms: false
            },
            language: 'de'
          },
          preferences: {
            newsletter: true,
            marketing: false,
            analytics: true
          }
        }
      }
    }
  });
  
  // Moderator User
  const modUser = await prisma.user.create({
    data: {
      email: 'moderator@example.com',
      name: 'Moderator User',
      role: UserRole.MODERATOR,
      status: UserStatus.ACTIVE,
      emailVerified: new Date(),
      profile: {
        create: {
          bio: 'Content Moderator',
          location: 'Munich, Germany'
        }
      }
    }
  });
  
  // Regular Users
  const users = await Promise.all(
    Array.from({ length: 5 }).map(async (_, i) => {
      const userNumber = i + 1;
      return prisma.user.create({
        data: {
          email: `user${userNumber}@example.com`,
          name: `User ${userNumber}`,
          role: UserRole.USER,
          status: i === 4 ? UserStatus.INACTIVE : UserStatus.ACTIVE,
          emailVerified: i < 3 ? new Date() : null,
          profile: {
            create: {
              bio: `I am test user ${userNumber}`,
              location: ['Berlin', 'Hamburg', 'Munich', 'Cologne', 'Frankfurt'][i],
              website: i < 2 ? `https://user${userNumber}.example.com` : undefined,
              github: i < 3 ? `user${userNumber}` : undefined,
              settings: {
                theme: i % 2 === 0 ? 'light' : 'dark',
                notifications: {
                  email: true,
                  push: false
                }
              }
            }
          }
        }
      });
    })
  );
  
  console.log(`✅ Created ${users.length + 2} users`);
  return { adminUser, modUser, users };
}

async function seedTags() {
  console.log('🏷️  Creating tags...');
  
  const tagData = [
    { name: 'Technology', description: 'Tech articles and tutorials' },
    { name: 'Design', description: 'Design patterns and UI/UX' },
    { name: 'Business', description: 'Business and entrepreneurship' },
    { name: 'Marketing', description: 'Marketing strategies and tips' },
    { name: 'Development', description: 'Software development' },
    { name: 'JavaScript', description: 'JavaScript programming' },
    { name: 'TypeScript', description: 'TypeScript programming' },
    { name: 'React', description: 'React framework' },
    { name: 'Next.js', description: 'Next.js framework' },
    { name: 'Database', description: 'Database design and optimization' }
  ];
  
  const tags = await Promise.all(
    tagData.map((tag) =>
      prisma.tag.create({
        data: {
          name: tag.name,
          slug: createSlug(tag.name),
          description: tag.description
        }
      })
    )
  );
  
  console.log(`✅ Created ${tags.length} tags`);
  return tags;
}

async function seedPosts(users: any[], tags: any[]) {
  console.log('📝 Creating posts...');
  
  const postData = [
    {
      title: 'Getting Started with Next.js 15',
      content: 'Next.js 15 brings exciting new features including improved performance with Turbopack, better error handling, and enhanced developer experience. In this comprehensive guide, we will explore all the new features and how to migrate your existing applications.',
      excerpt: 'A comprehensive guide to Next.js 15 new features',
      published: true,
      authorIndex: 0,
      tagIndexes: [4, 8]
    },
    {
      title: 'TypeScript Best Practices 2024',
      content: 'TypeScript continues to evolve with new features and patterns. This article covers the latest best practices including type inference improvements, template literal types, and advanced pattern matching.',
      excerpt: 'Modern TypeScript patterns and practices',
      published: true,
      authorIndex: 1,
      tagIndexes: [4, 6]
    },
    {
      title: 'Building Scalable APIs with Prisma',
      content: 'Prisma ORM provides a type-safe database client that makes it easy to build scalable APIs. Learn how to design efficient schemas, implement soft deletes, and optimize queries for production.',
      excerpt: 'Database design and optimization with Prisma',
      published: true,
      authorIndex: 2,
      tagIndexes: [4, 9]
    },
    {
      title: 'Draft: Upcoming Features',
      content: 'This is a draft post about upcoming features in our platform. It includes detailed roadmap and technical specifications.',
      excerpt: 'Preview of upcoming features',
      published: false,
      authorIndex: 0,
      tagIndexes: [0]
    },
    {
      title: 'React Server Components Deep Dive',
      content: 'React Server Components represent a paradigm shift in how we build React applications. This deep dive explores the architecture, benefits, and implementation patterns.',
      excerpt: 'Understanding React Server Components',
      published: true,
      authorIndex: 1,
      tagIndexes: [4, 7]
    }
  ];
  
  const posts = await Promise.all(
    postData.map(async (data) => {
      const post = await prisma.post.create({
        data: {
          title: data.title,
          slug: createSlug(data.title),
          content: data.content,
          excerpt: data.excerpt,
          published: data.published,
          publishedAt: data.published ? new Date() : null,
          authorId: users[data.authorIndex].id,
          metaTitle: data.title,
          metaDescription: data.excerpt,
          metaKeywords: data.tagIndexes.map(i => tags[i].name),
          views: Math.floor(Math.random() * 1000),
          likes: Math.floor(Math.random() * 100),
          tags: {
            connect: data.tagIndexes.map(i => ({ id: tags[i].id }))
          }
        }
      });
      return post;
    })
  );
  
  console.log(`✅ Created ${posts.length} posts`);
  return posts;
}

async function seedComments(posts: any[], users: any[]) {
  console.log('💬 Creating comments...');
  
  let commentCount = 0;
  
  for (const post of posts.slice(0, 3)) {
    // Root comment
    const rootComment = await prisma.comment.create({
      data: {
        postId: post.id,
        authorId: users[3].id,
        content: 'Great article! This really helped me understand the concepts better.',
        approved: true
      }
    });
    commentCount++;
    
    // Reply from post author
    const reply1 = await prisma.comment.create({
      data: {
        postId: post.id,
        authorId: post.authorId,
        content: 'Thank you for your feedback! Glad it was helpful.',
        parentId: rootComment.id,
        approved: true
      }
    });
    commentCount++;
    
    // Another reply
    await prisma.comment.create({
      data: {
        postId: post.id,
        authorId: users[4].id,
        content: 'I have a follow-up question about the implementation details.',
        parentId: rootComment.id,
        approved: true
      }
    });
    commentCount++;
    
    // Standalone comment
    await prisma.comment.create({
      data: {
        postId: post.id,
        authorId: users[2].id,
        content: 'Looking forward to more content like this!',
        approved: true
      }
    });
    commentCount++;
    
    // Flagged comment
    if (post === posts[0]) {
      await prisma.comment.create({
        data: {
          postId: post.id,
          authorId: users[4].id,
          content: 'This comment has been flagged for review.',
          approved: false,
          flagged: true
        }
      });
      commentCount++;
    }
  }
  
  console.log(`✅ Created ${commentCount} comments`);
}

async function seedSessions(users: any[]) {
  console.log('🔐 Creating sessions...');
  
  const sessions = await Promise.all(
    users.slice(0, 3).map(async (user) => {
      return prisma.session.create({
        data: {
          userId: user.id,
          token: generateApiKey('sess'),
          userAgent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)',
          ip: '192.168.1.' + Math.floor(Math.random() * 255),
          expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days
        }
      });
    })
  );
  
  console.log(`✅ Created ${sessions.length} sessions`);
  return sessions;
}

async function seedApiKeys() {
  console.log('🔑 Creating API keys...');
  
  const apiKeys = await Promise.all([
    prisma.apiKey.create({
      data: {
        name: 'Production API Key',
        key: generateApiKey('sk_live'),
        scopes: ['read', 'write', 'delete'],
        rateLimit: 10000,
        expiresAt: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000) // 1 year
      }
    }),
    prisma.apiKey.create({
      data: {
        name: 'Development API Key',
        key: generateApiKey('sk_test'),
        scopes: ['read', 'write'],
        rateLimit: 1000,
        expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) // 30 days
      }
    }),
    prisma.apiKey.create({
      data: {
        name: 'Read-only API Key',
        key: generateApiKey('sk_ro'),
        scopes: ['read'],
        rateLimit: 5000,
        expiresAt: null // No expiration
      }
    })
  ]);
  
  console.log(`✅ Created ${apiKeys.length} API keys`);
  return apiKeys;
}

async function seedAuditLogs(users: any[]) {
  console.log('📋 Creating audit logs...');
  
  const auditLogs = await Promise.all([
    prisma.auditLog.create({
      data: {
        userId: users[0].id,
        action: AuditAction.LOGIN,
        entity: 'users',
        entityId: users[0].id,
        ip: '192.168.1.100',
        userAgent: 'Mozilla/5.0'
      }
    }),
    prisma.auditLog.create({
      data: {
        userId: users[0].id,
        action: AuditAction.UPDATE,
        entity: 'profiles',
        entityId: users[0].id,
        oldValues: { bio: 'Old bio' },
        newValues: { bio: 'System Administrator' },
        ip: '192.168.1.100'
      }
    }),
    prisma.auditLog.create({
      data: {
        userId: users[1].id,
        action: AuditAction.CREATE,
        entity: 'posts',
        newValues: { title: 'New Post' },
        ip: '192.168.1.101'
      }
    })
  ]);
  
  console.log(`✅ Created ${auditLogs.length} audit logs`);
  return auditLogs;
}

async function seedWebhookEvents() {
  console.log('🪝 Creating webhook events...');
  
  const webhookEvents = await Promise.all([
    prisma.webhookEvent.create({
      data: {
        event: 'user.created',
        payload: { userId: 'test-123', email: 'test@example.com' },
        url: 'https://webhook.site/test',
        delivered: true,
        deliveredAt: new Date(),
        attempts: 1
      }
    }),
    prisma.webhookEvent.create({
      data: {
        event: 'post.published',
        payload: { postId: 'post-456', title: 'Test Post' },
        url: 'https://webhook.site/test',
        delivered: false,
        attempts: 3,
        lastAttemptAt: new Date(),
        lastError: 'Connection timeout'
      }
    })
  ]);
  
  console.log(`✅ Created ${webhookEvents.length} webhook events`);
  return webhookEvents;
}

async function main() {
  console.log('🌱 Starting database seed...\n');
  
  try {
    // Clear existing data
    await clearDatabase();
    
    // Seed in order
    const { adminUser, modUser, users } = await seedUsers();
    const allUsers = [adminUser, modUser, ...users];
    
    const tags = await seedTags();
    const posts = await seedPosts(allUsers, tags);
    await seedComments(posts, allUsers);
    await seedSessions(allUsers);
    await seedApiKeys();
    await seedAuditLogs(allUsers);
    await seedWebhookEvents();
    
    console.log('\n🎉 Database seeding completed successfully!');
    console.log('\n📊 Summary:');
    console.log(`   - Users: ${allUsers.length}`);
    console.log(`   - Tags: ${tags.length}`);
    console.log(`   - Posts: ${posts.length}`);
    console.log(`   - Comments: Multiple with nesting`);
    console.log(`   - Sessions: Active`);
    console.log(`   - API Keys: 3 with different scopes`);
    console.log(`   - Audit Logs: Sample entries`);
    console.log(`   - Webhook Events: 2 samples`);
    
    console.log('\n🔑 Test Credentials:');
    console.log('   Admin: admin@example.com');
    console.log('   Moderator: moderator@example.com');
    console.log('   Users: user1@example.com ... user5@example.com');
    
  } catch (error) {
    console.error('❌ Seeding failed:', error);
    throw error;
  }
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

## Features

### Comprehensive Test Data
- Multiple User mit verschiedenen Rollen
- Posts mit Tags und Metadaten
- Verschachtelte Kommentare
- Active Sessions
- API Keys mit Scopes
- Audit Log Einträge
- Webhook Events

### Helper Functions
- `generateApiKey()`: Sichere API Key Generation
- `createSlug()`: URL-freundliche Slugs
- `clearDatabase()`: Clean Slate vor Seeding

### Realistische Daten
- Deutsche Städte für Location
- Verschiedene User Status
- Flagged/Approved Comments
- Published/Draft Posts
- Expired/Active Sessions

## Verwendung

```bash
# Einmalig seeden
cd packages/db
npm run seed

# Mit Reset (löscht alle Daten)
npm run migrate:reset
# Prisma fragt automatisch ob geseedet werden soll
```

## Package.json Integration

```json
{
  "scripts": {
    "seed": "tsx prisma/seed.ts",
    "seed:prod": "NODE_ENV=production tsx prisma/seed.ts"
  },
  "prisma": {
    "seed": "tsx prisma/seed.ts"
  }
}
```

## Erfolgskriterien
- [ ] Seed Script erstellt alle Models
- [ ] Relationen korrekt verknüpft
- [ ] Realistische Test-Daten
- [ ] Clear Function für Clean State
- [ ] Summary Output mit Credentials