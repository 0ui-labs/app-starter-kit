# Teilaufgabe 05.09: Admin Role Management (Optional)

## Ziel
Implementierung von Server Actions für Admin User Management und Role/Permission Verwaltung.

## Zeitschätzung
15 Minuten

## Vorbedingungen
- [ ] 05.01-05.08 abgeschlossen
- [ ] Clerk Client SDK verfügbar
- [ ] Admin Role konfiguriert

## Implementierung

### Schritt 1: Server Actions für User Management

Erstelle `apps/web/src/app/admin/_actions.ts`:

```typescript
'use server';

import { clerkClient } from '@clerk/nextjs/server';
import { hasRole } from '@starter-kit/auth';
import { revalidatePath } from 'next/cache';

// Set user role
export async function setUserRole(
  userId: string, 
  role: 'user' | 'moderator' | 'admin'
) {
  // Check that the current user is an admin
  const isAdmin = await hasRole('admin');
  if (!isAdmin) {
    throw new Error('Unauthorized: Admin access required');
  }

  const client = await clerkClient();
  
  try {
    const res = await client.users.updateUserMetadata(userId, {
      publicMetadata: { role },
    });
    
    revalidatePath('/admin/users');
    
    return { 
      success: true, 
      metadata: res.publicMetadata 
    };
  } catch (err) {
    console.error('Failed to set role:', err);
    throw new Error('Failed to update user role');
  }
}

// Set user permissions
export async function setUserPermissions(
  userId: string, 
  permissions: string[]
) {
  const isAdmin = await hasRole('admin');
  if (!isAdmin) {
    throw new Error('Unauthorized: Admin access required');
  }

  const client = await clerkClient();
  
  try {
    const res = await client.users.updateUserMetadata(userId, {
      publicMetadata: { permissions },
    });
    
    revalidatePath('/admin/users');
    
    return { 
      success: true, 
      metadata: res.publicMetadata 
    };
  } catch (err) {
    console.error('Failed to set permissions:', err);
    throw new Error('Failed to update user permissions');
  }
}

// Update user metadata
export async function updateUserMetadata(
  userId: string,
  metadata: Record<string, any>
) {
  const isAdmin = await hasRole('admin');
  if (!isAdmin) {
    throw new Error('Unauthorized: Admin access required');
  }

  const client = await clerkClient();
  
  try {
    const user = await client.users.getUser(userId);
    const currentMetadata = user.publicMetadata || {};
    
    const res = await client.users.updateUserMetadata(userId, {
      publicMetadata: {
        ...currentMetadata,
        ...metadata
      },
    });
    
    revalidatePath('/admin/users');
    
    return { 
      success: true, 
      metadata: res.publicMetadata 
    };
  } catch (err) {
    console.error('Failed to update metadata:', err);
    throw new Error('Failed to update user metadata');
  }
}

// Get all users with metadata
export async function getAllUsers(
  limit: number = 100,
  offset: number = 0
) {
  const isAdmin = await hasRole('admin');
  if (!isAdmin) {
    throw new Error('Unauthorized: Admin access required');
  }

  const client = await clerkClient();
  
  try {
    const { data: users, totalCount } = await client.users.getUserList({
      limit,
      offset,
    });
    
    return {
      users: users.map(user => ({
        id: user.id,
        email: user.emailAddresses[0]?.emailAddress || '',
        name: `${user.firstName || ''} ${user.lastName || ''}`.trim(),
        imageUrl: user.imageUrl,
        role: user.publicMetadata?.role || 'user',
        permissions: user.publicMetadata?.permissions || [],
        createdAt: user.createdAt,
        lastSignInAt: user.lastSignInAt,
      })),
      totalCount,
      hasMore: offset + limit < totalCount,
    };
  } catch (err) {
    console.error('Failed to get users:', err);
    throw new Error('Failed to fetch users');
  }
}

// Delete user
export async function deleteUser(userId: string) {
  const isAdmin = await hasRole('admin');
  if (!isAdmin) {
    throw new Error('Unauthorized: Admin access required');
  }

  const client = await clerkClient();
  
  try {
    await client.users.deleteUser(userId);
    revalidatePath('/admin/users');
    
    return { success: true };
  } catch (err) {
    console.error('Failed to delete user:', err);
    throw new Error('Failed to delete user');
  }
}

// Ban/Unban user
export async function toggleUserBan(userId: string, ban: boolean) {
  const isAdmin = await hasRole('admin');
  if (!isAdmin) {
    throw new Error('Unauthorized: Admin access required');
  }

  const client = await clerkClient();
  
  try {
    if (ban) {
      await client.users.banUser(userId);
    } else {
      await client.users.unbanUser(userId);
    }
    
    revalidatePath('/admin/users');
    
    return { success: true, banned: ban };
  } catch (err) {
    console.error('Failed to toggle ban:', err);
    throw new Error(`Failed to ${ban ? 'ban' : 'unban'} user`);
  }
}
```

### Schritt 2: Admin User Management UI

Erstelle `apps/web/src/app/admin/users/page.tsx`:

```typescript
import { AdminOnly } from '@/components/auth';
import { getAllUsers } from '../_actions';
import { UserManagementTable } from './user-table';

export default async function AdminUsersPage() {
  const { users, totalCount } = await getAllUsers();
  
  return (
    <AdminOnly>
      <div className="container mx-auto py-8">
        <h1 className="text-3xl font-bold mb-6">User Management</h1>
        
        <div className="bg-white rounded-lg shadow">
          <div className="p-4 border-b">
            <p className="text-sm text-gray-600">
              Total Users: {totalCount}
            </p>
          </div>
          
          <UserManagementTable users={users} />
        </div>
      </div>
    </AdminOnly>
  );
}
```

### Schritt 3: User Management Table Component

Erstelle `apps/web/src/app/admin/users/user-table.tsx`:

```typescript
'use client';

import { useState } from 'react';
import { Button } from '@starter-kit/ui';
import { 
  setUserRole, 
  setUserPermissions,
  deleteUser,
  toggleUserBan 
} from '../_actions';
import { PERMISSIONS } from '@starter-kit/auth';

interface User {
  id: string;
  email: string;
  name: string;
  role: string;
  permissions: string[];
  createdAt: number;
}

export function UserManagementTable({ users }: { users: User[] }) {
  const [loading, setLoading] = useState<string | null>(null);
  
  const handleRoleChange = async (userId: string, role: string) => {
    setLoading(userId);
    try {
      await setUserRole(userId, role as any);
      // Refresh or update UI
    } catch (error) {
      console.error('Failed to update role:', error);
      alert('Failed to update role');
    } finally {
      setLoading(null);
    }
  };
  
  const handlePermissionToggle = async (
    userId: string, 
    permission: string,
    currentPermissions: string[]
  ) => {
    setLoading(userId);
    try {
      const newPermissions = currentPermissions.includes(permission)
        ? currentPermissions.filter(p => p !== permission)
        : [...currentPermissions, permission];
      
      await setUserPermissions(userId, newPermissions);
      // Refresh or update UI
    } catch (error) {
      console.error('Failed to update permissions:', error);
      alert('Failed to update permissions');
    } finally {
      setLoading(null);
    }
  };
  
  const handleDeleteUser = async (userId: string) => {
    if (!confirm('Are you sure you want to delete this user?')) {
      return;
    }
    
    setLoading(userId);
    try {
      await deleteUser(userId);
      // Refresh or remove from UI
    } catch (error) {
      console.error('Failed to delete user:', error);
      alert('Failed to delete user');
    } finally {
      setLoading(null);
    }
  };
  
  return (
    <div className="overflow-x-auto">
      <table className="min-w-full">
        <thead>
          <tr className="border-b">
            <th className="px-4 py-2 text-left">User</th>
            <th className="px-4 py-2 text-left">Role</th>
            <th className="px-4 py-2 text-left">Permissions</th>
            <th className="px-4 py-2 text-left">Created</th>
            <th className="px-4 py-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody>
          {users.map((user) => (
            <tr key={user.id} className="border-b hover:bg-gray-50">
              <td className="px-4 py-3">
                <div>
                  <div className="font-medium">{user.name || 'No name'}</div>
                  <div className="text-sm text-gray-500">{user.email}</div>
                </div>
              </td>
              
              <td className="px-4 py-3">
                <select
                  value={user.role}
                  onChange={(e) => handleRoleChange(user.id, e.target.value)}
                  disabled={loading === user.id}
                  className="rounded border-gray-300"
                >
                  <option value="user">User</option>
                  <option value="moderator">Moderator</option>
                  <option value="admin">Admin</option>
                </select>
              </td>
              
              <td className="px-4 py-3">
                <div className="space-y-1">
                  {Object.values(PERMISSIONS).slice(0, 3).map((perm) => (
                    <label key={perm} className="flex items-center text-sm">
                      <input
                        type="checkbox"
                        checked={user.permissions.includes(perm)}
                        onChange={() => handlePermissionToggle(
                          user.id, 
                          perm, 
                          user.permissions
                        )}
                        disabled={loading === user.id}
                        className="mr-2"
                      />
                      {perm}
                    </label>
                  ))}
                </div>
              </td>
              
              <td className="px-4 py-3 text-sm text-gray-500">
                {new Date(user.createdAt).toLocaleDateString()}
              </td>
              
              <td className="px-4 py-3">
                <div className="flex space-x-2">
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => handleDeleteUser(user.id)}
                    disabled={loading === user.id}
                  >
                    Delete
                  </Button>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

### Schritt 4: Permission Manager Component

Erstelle `apps/web/src/app/admin/users/permission-manager.tsx`:

```typescript
'use client';

import { useState } from 'react';
import { PERMISSIONS } from '@starter-kit/auth';
import { setUserPermissions } from '../_actions';
import { Button } from '@starter-kit/ui';

interface PermissionManagerProps {
  userId: string;
  currentPermissions: string[];
  onUpdate?: (permissions: string[]) => void;
}

export function PermissionManager({
  userId,
  currentPermissions,
  onUpdate
}: PermissionManagerProps) {
  const [permissions, setPermissions] = useState(currentPermissions);
  const [loading, setLoading] = useState(false);
  
  const permissionGroups = {
    'User Management': [
      PERMISSIONS.USER_VIEW,
      PERMISSIONS.USER_CREATE,
      PERMISSIONS.USER_UPDATE,
      PERMISSIONS.USER_DELETE,
    ],
    'Post Management': [
      PERMISSIONS.POST_VIEW,
      PERMISSIONS.POST_CREATE,
      PERMISSIONS.POST_UPDATE,
      PERMISSIONS.POST_DELETE,
      PERMISSIONS.POST_PUBLISH,
    ],
    'Comment Management': [
      PERMISSIONS.COMMENT_VIEW,
      PERMISSIONS.COMMENT_CREATE,
      PERMISSIONS.COMMENT_UPDATE,
      PERMISSIONS.COMMENT_DELETE,
      PERMISSIONS.COMMENT_MODERATE,
    ],
    'Admin': [
      PERMISSIONS.ADMIN_ACCESS,
      PERMISSIONS.ADMIN_SETTINGS,
      PERMISSIONS.ADMIN_ANALYTICS,
    ],
  };
  
  const handleToggle = (permission: string) => {
    setPermissions(prev =>
      prev.includes(permission)
        ? prev.filter(p => p !== permission)
        : [...prev, permission]
    );
  };
  
  const handleSave = async () => {
    setLoading(true);
    try {
      await setUserPermissions(userId, permissions);
      onUpdate?.(permissions);
    } catch (error) {
      console.error('Failed to save permissions:', error);
      alert('Failed to save permissions');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="space-y-4">
      {Object.entries(permissionGroups).map(([group, perms]) => (
        <div key={group}>
          <h3 className="font-medium text-gray-700 mb-2">{group}</h3>
          <div className="space-y-2">
            {perms.map((perm) => (
              <label key={perm} className="flex items-center">
                <input
                  type="checkbox"
                  checked={permissions.includes(perm)}
                  onChange={() => handleToggle(perm)}
                  className="mr-2"
                />
                <span className="text-sm">{perm}</span>
              </label>
            ))}
          </div>
        </div>
      ))}
      
      <div className="pt-4">
        <Button
          onClick={handleSave}
          disabled={loading}
          className="w-full"
        >
          {loading ? 'Saving...' : 'Save Permissions'}
        </Button>
      </div>
    </div>
  );
}
```

## Verifizierung

### Test 1: Server Actions
```typescript
// Test role update
const result = await setUserRole('user_123', 'moderator');
// Should update user role
```

### Test 2: Permission Updates
```typescript
// Test permission assignment
const result = await setUserPermissions('user_123', ['post:create']);
// Should update permissions
```

### Test 3: User List
```bash
# Navigate to /admin/users
# Should show user table with all users
```

### Test 4: UI Interactions
- Change user role via dropdown
- Toggle permissions via checkboxes
- Delete user with confirmation

## Erfolgskriterien
- [ ] Server Actions erstellt
- [ ] Admin UI implementiert
- [ ] User Table funktioniert
- [ ] Permission Manager arbeitet
- [ ] Role Updates funktionieren
- [ ] Permission Updates funktionieren
- [ ] Delete User implementiert

## Troubleshooting

### Problem: Clerk Client Error
**Lösung:**
1. Prüfe Clerk API Keys
2. Verifiziere Clerk Dashboard Settings
3. Check Rate Limits

### Problem: Revalidation nicht aktiv
**Lösung:**
1. Nutze `revalidatePath` nach Updates
2. Implementiere Client-side Refresh
3. Verwende SWR oder React Query

### Problem: Permission Updates nicht sichtbar
**Lösung:**
1. User muss neu einloggen für Token Refresh
2. Clear Session Cache
3. Force Token Refresh

## Nächster Schritt
Nach erfolgreichem Admin Management → [05.10-verification-tests.md](./05.10-verification-tests.md)