# 11.02 OpenAI Integration

## Ziel
Implementierung des OpenAI Providers mit vollständiger Unterstützung für GPT-4, GPT-3.5 und Embeddings.

## Umfang
- OpenAI SDK integration
- Chat completions implementation
- Embeddings support
- Function calling support
- Error handling

## Tasks

### 1. Package Dependencies
```json
// packages/ai-adapter/package.json
{
  "dependencies": {
    "openai": "^4.x.x"
  }
}
```

### 2. OpenAI Provider Implementation
```typescript
// packages/ai-adapter/src/providers/openai.ts
import OpenAI from 'openai';
import { BaseAIProvider } from '../base-provider';

export class OpenAIProvider extends BaseAIProvider {
  private openai: OpenAI;
  
  async initialize(config: OpenAIConfig): Promise<void> {
    this.openai = new OpenAI({
      apiKey: config.apiKey,
      organization: config.organization,
      baseURL: config.baseURL,
    });
    this.config = config;
  }
  
  async complete(request: CompletionRequest): Promise<CompletionResponse> {
    const completion = await this.openai.chat.completions.create({
      model: request.model || 'gpt-4-turbo-preview',
      messages: this.formatMessages(request.messages),
      temperature: request.temperature,
      max_tokens: request.maxTokens,
      tools: this.formatTools(request.tools),
    });
    
    return this.formatResponse(completion);
  }
  
  async stream(request: CompletionRequest): AsyncIterableIterator<StreamChunk> {
    const stream = await this.openai.chat.completions.create({
      model: request.model || 'gpt-4-turbo-preview',
      messages: this.formatMessages(request.messages),
      temperature: request.temperature,
      stream: true,
    });
    
    for await (const chunk of stream) {
      yield this.formatStreamChunk(chunk);
    }
  }
  
  async embed(text: string): Promise<number[]> {
    const embedding = await this.openai.embeddings.create({
      model: 'text-embedding-3-small',
      input: text,
    });
    
    return embedding.data[0].embedding;
  }
}
```

### 3. Message Formatting
```typescript
// packages/ai-adapter/src/providers/openai.ts
private formatMessages(messages: Message[]): OpenAI.ChatCompletionMessage[] {
  return messages.map(msg => ({
    role: msg.role as 'system' | 'user' | 'assistant',
    content: msg.content,
    name: msg.name,
    tool_calls: msg.toolCalls,
  }));
}
```

### 4. Function Calling Support
```typescript
private formatTools(tools?: Tool[]): OpenAI.ChatCompletionTool[] {
  if (!tools) return undefined;
  
  return tools.map(tool => ({
    type: 'function',
    function: {
      name: tool.name,
      description: tool.description,
      parameters: tool.parameters,
    },
  }));
}
```

### 5. Error Handling
```typescript
protected handleOpenAIError(error: any): never {
  if (error instanceof OpenAI.APIError) {
    throw new AIProviderError({
      code: error.status,
      message: error.message,
      provider: 'openai',
      retryable: this.isRetryableError(error),
    });
  }
  throw error;
}
```

### 6. Model Mapping
```typescript
// packages/ai-adapter/src/providers/openai-models.ts
export const OPENAI_MODELS = {
  'gpt-4-turbo': 'gpt-4-turbo-preview',
  'gpt-4': 'gpt-4',
  'gpt-3.5-turbo': 'gpt-3.5-turbo',
  'text-embedding-3-small': 'text-embedding-3-small',
  'text-embedding-3-large': 'text-embedding-3-large',
} as const;

export const getModelConfig = (model: string) => {
  return {
    maxTokens: getMaxTokens(model),
    supportsFunctions: supportsFunctions(model),
    supportsVision: supportsVision(model),
  };
};
```

## Dateien zu erstellen/ändern
- `packages/ai-adapter/src/providers/openai.ts` - Main implementation
- `packages/ai-adapter/src/providers/openai-models.ts` - Model configurations
- `packages/ai-adapter/src/providers/openai-types.ts` - OpenAI specific types
- `packages/ai-adapter/package.json` - Add OpenAI dependency

## Akzeptanzkriterien
- [ ] OpenAI SDK korrekt integriert
- [ ] Chat completions funktionieren mit GPT-4 und GPT-3.5
- [ ] Embeddings funktionieren
- [ ] Function calling unterstützt
- [ ] Streaming implementiert
- [ ] Fehler werden korrekt gemapped
- [ ] Tests für alle Hauptfunktionen

## Abhängigkeiten
- Task 11.01 (Provider Abstraction) muss abgeschlossen sein
- OpenAI API Key in environment variables
- OpenAI npm package

## Geschätzter Aufwand
60-75 Minuten