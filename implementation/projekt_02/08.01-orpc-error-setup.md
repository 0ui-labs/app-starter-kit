# Arbeitspaket 08.01: oRPC Error Setup mit Type-Safe Errors

## Ziel
Implementierung einer zentralen Error-Definition mit type-safe Errors fÃ¼r die gesamte Anwendung unter Verwendung der nativen oRPC Error Features.

## Kontext
- **Framework**: oRPC mit nativen Error Handling Features
- **Sprache**: Deutsche Fehlermeldungen fÃ¼r User
- **Logging**: Console (Vorbereitung fÃ¼r winston/pino)
- **Error Tracking**: Vorbereitung fÃ¼r Sentry Integration

## Implementierung

### Schritt 1: Base Error Types definieren
Erstelle `packages/api/src/errors/index.ts`:

```typescript
import { os, ORPCError } from '@orpc/server';
import * as z from 'zod';

// Define base error types that will be shared across all procedures
export const baseErrors = {
  // Validation Errors (400)
  VALIDATION_ERROR: {
    message: 'Validierung fehlgeschlagen',
    data: z.object({
      field: z.string().optional(),
      value: z.any().optional(),
      constraints: z.array(z.string()).optional(),
    }),
  },
  INVALID_INPUT: {
    message: 'UngÃ¼ltige Eingabe',
    data: z.object({
      field: z.string().optional(),
    }),
  },
  
  // Authentication Errors (401)
  UNAUTHORIZED: {
    message: 'Nicht autorisiert',
  },
  TOKEN_EXPIRED: {
    message: 'Token ist abgelaufen',
  },
  
  // Authorization Errors (403)
  FORBIDDEN: {
    message: 'Zugriff verweigert',
  },
  INSUFFICIENT_PERMISSIONS: {
    message: 'Unzureichende Berechtigungen',
  },
  
  // Not Found Errors (404)
  NOT_FOUND: {
    message: 'Ressource nicht gefunden',
  },
  
  // Conflict Errors (409)
  DUPLICATE_RESOURCE: {
    message: 'Ressource existiert bereits',
    data: z.object({
      field: z.string().optional(),
    }),
  },
  
  // Rate Limiting (429)
  RATE_LIMIT_EXCEEDED: {
    message: 'Zu viele Anfragen',
    data: z.object({
      retryAfter: z.number(),
    }),
  },
  
  // Server Errors (500)
  INTERNAL_ERROR: {
    message: 'Ein interner Fehler ist aufgetreten',
  },
  DATABASE_ERROR: {
    message: 'Datenbankfehler',
    data: z.object({
      code: z.string().optional(),
    }),
  },
  EXTERNAL_SERVICE_ERROR: {
    message: 'Externer Service nicht verfÃ¼gbar',
  },
  
  // Timeout Errors (504)
  TIMEOUT: {
    message: 'ZeitÃ¼berschreitung',
  },
};

// Create base router with common errors
export const baseRouter = os.errors(baseErrors);
```

### Schritt 2: Error Logger Utility
Erweitere `packages/api/src/errors/index.ts`:

```typescript
// Error logger utility
export function logError(error: unknown, context?: any) {
  const errorLog = {
    timestamp: new Date(),
    error: error instanceof ORPCError ? {
      code: error.code,
      message: error.message,
      data: error.data,
    } : String(error),
    context,
    stack: error instanceof Error ? error.stack : undefined,
  };
  
  if (error instanceof ORPCError) {
    const status = error.status || 500;
    if (status >= 500) {
      console.error('ðŸ”´ Server Error:', errorLog);
    } else if (status >= 400) {
      console.warn('ðŸŸ¡ Client Error:', errorLog);
    }
  } else {
    console.error('ðŸ”´ Unexpected Error:', errorLog);
  }
  
  // Here: Send to monitoring service (Sentry, etc.)
  // if (process.env.SENTRY_DSN) {
  //   Sentry.captureException(error, { extra: errorLog });
  // }
}
```

### Schritt 3: Export Error Types fÃ¼r TypeScript
Erweitere `packages/api/src/errors/index.ts`:

```typescript
// Type exports for client-side usage
export type BaseErrorCodes = keyof typeof baseErrors;
export type BaseErrorData<T extends BaseErrorCodes> = 
  typeof baseErrors[T] extends { data: z.ZodType<infer D> } ? D : never;
```

## Verifizierung

### Test 1: Base Router erstellen
```typescript
import { baseRouter } from './errors';

const testRouter = baseRouter
  .procedure('test')
  .handler(async ({ errors }) => {
    // errors sollte alle baseErrors enthalten
    throw errors.VALIDATION_ERROR({
      message: 'Test validation',
      data: { field: 'email' }
    });
  });
```

### Test 2: Error Logging
```typescript
import { logError } from './errors';

// Test Server Error
logError(new ORPCError('INTERNAL_ERROR', { message: 'Test' }));
// Sollte mit ðŸ”´ loggen

// Test Client Error
logError(new ORPCError('NOT_FOUND', { message: 'Test' }));
// Sollte mit ðŸŸ¡ loggen
```

## Erfolgskriterien
- [ ] Base Error Types definiert
- [ ] Error Logger implementiert
- [ ] Type Exports fÃ¼r TypeScript
- [ ] Strukturierte Error Codes (HTTP Status entsprechend)
- [ ] Deutsche Fehlermeldungen
- [ ] Vorbereitung fÃ¼r Monitoring (Sentry)

## Potentielle Probleme

### Problem: oRPC Version KompatibilitÃ¤t
**LÃ¶sung**: Stelle sicher, dass @orpc/server in der richtigen Version installiert ist

### Problem: Zod Schema Validierung
**LÃ¶sung**: Optional data fields verwenden fÃ¼r FlexibilitÃ¤t

## ZeitschÃ¤tzung
- Base Error Types: 10 Minuten
- Error Logger: 5 Minuten
- Type Exports: 5 Minuten
- Total: 20 Minuten