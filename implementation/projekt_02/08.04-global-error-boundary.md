# Arbeitspaket 08.04: Global Error Boundary f√ºr Next.js

## Ziel
Implementierung einer Global Error Boundary, die kritische Fehler auf Application-Level abf√§ngt und eine benutzerfreundliche Fehlerseite anzeigt.

## Kontext
- **Framework**: Next.js 15 App Router
- **Zweck**: Letzte Verteidigungslinie bei unerwarteten Fehlern
- **UI**: Benutzerfreundliche deutsche Fehlermeldungen

## Implementierung

### Schritt 1: Global Error Component
Erstelle `apps/web/app/global-error.tsx`:

```typescript
'use client';

import { useEffect } from 'react';
import { Button } from '@starter-kit/ui';

interface GlobalErrorProps {
  error: Error & { digest?: string };
  reset: () => void;
}

export default function GlobalError({ error, reset }: GlobalErrorProps) {
  useEffect(() => {
    // Log error to monitoring service
    const errorData = {
      message: error.message,
      digest: error.digest,
      stack: error.stack,
      timestamp: new Date().toISOString(),
      url: typeof window !== 'undefined' ? window.location.href : 'unknown',
      userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : 'unknown',
    };
    
    console.error('üö® Global error caught:', errorData);
    
    // Send to error tracking service
    // if (typeof window !== 'undefined' && window.Sentry) {
    //   window.Sentry.captureException(error, {
    //     tags: {
    //       type: 'global-error',
    //       digest: error.digest,
    //     },
    //     extra: errorData,
    //   });
    // }
  }, [error]);

  return (
    <html lang="de">
      <body>
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-50 to-gray-100">
          <div className="max-w-md w-full mx-4">
            <div className="bg-white rounded-xl shadow-xl overflow-hidden">
              {/* Error Header */}
              <div className="bg-red-50 border-b border-red-100 p-6">
                <div className="flex items-center">
                  <div className="flex-shrink-0">
                    <div className="rounded-full bg-red-100 p-3">
                      <svg 
                        className="h-8 w-8 text-red-600" 
                        fill="none" 
                        viewBox="0 0 24 24" 
                        stroke="currentColor"
                      >
                        <path 
                          strokeLinecap="round" 
                          strokeLinejoin="round" 
                          strokeWidth={2} 
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" 
                        />
                      </svg>
                    </div>
                  </div>
                  <div className="ml-4">
                    <h1 className="text-xl font-bold text-gray-900">
                      Kritischer Fehler
                    </h1>
                    <p className="text-sm text-gray-600 mt-1">
                      Die Anwendung konnte nicht geladen werden
                    </p>
                  </div>
                </div>
              </div>

              {/* Error Body */}
              <div className="p-6">
                <div className="text-center mb-6">
                  <h2 className="text-lg font-semibold text-gray-900 mb-2">
                    Was ist passiert?
                  </h2>
                  <p className="text-gray-600">
                    Ein unerwarteter Fehler hat verhindert, dass die Seite korrekt geladen werden konnte. 
                    Unser Team wurde automatisch benachrichtigt.
                  </p>
                </div>

                {/* Error Details (Development only) */}
                {process.env.NODE_ENV === 'development' && (
                  <div className="mb-6">
                    <div className="bg-gray-900 rounded-lg p-4 overflow-auto max-h-48">
                      <p className="text-xs font-mono text-gray-100">
                        {error.message}
                      </p>
                      {error.digest && (
                        <p className="text-xs font-mono text-gray-400 mt-2">
                          Error ID: {error.digest}
                        </p>
                      )}
                      {error.stack && (
                        <details className="mt-2">
                          <summary className="text-xs text-gray-400 cursor-pointer hover:text-gray-200">
                            Stack Trace
                          </summary>
                          <pre className="text-xs text-gray-300 mt-2 whitespace-pre-wrap">
                            {error.stack}
                          </pre>
                        </details>
                      )}
                    </div>
                  </div>
                )}

                {/* Helpful Information */}
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                  <h3 className="text-sm font-semibold text-blue-900 mb-2">
                    Was k√∂nnen Sie tun?
                  </h3>
                  <ul className="text-sm text-blue-700 space-y-1">
                    <li className="flex items-start">
                      <span className="mr-2">‚Ä¢</span>
                      <span>Versuchen Sie die Seite neu zu laden</span>
                    </li>
                    <li className="flex items-start">
                      <span className="mr-2">‚Ä¢</span>
                      <span>L√∂schen Sie Ihren Browser-Cache</span>
                    </li>
                    <li className="flex items-start">
                      <span className="mr-2">‚Ä¢</span>
                      <span>Versuchen Sie es in einem anderen Browser</span>
                    </li>
                    <li className="flex items-start">
                      <span className="mr-2">‚Ä¢</span>
                      <span>Kontaktieren Sie den Support, falls das Problem weiterhin besteht</span>
                    </li>
                  </ul>
                </div>

                {/* Actions */}
                <div className="space-y-3">
                  <Button 
                    onClick={reset} 
                    className="w-full"
                    size="lg"
                  >
                    Seite neu laden
                  </Button>
                  <Button
                    variant="outline"
                    onClick={() => {
                      // Clear any problematic state
                      if (typeof window !== 'undefined') {
                        sessionStorage.clear();
                        window.location.href = '/';
                      }
                    }}
                    className="w-full"
                    size="lg"
                  >
                    Zur Startseite (Cache l√∂schen)
                  </Button>
                </div>

                {/* Support Information */}
                {error.digest && (
                  <div className="mt-6 pt-6 border-t border-gray-200">
                    <p className="text-xs text-center text-gray-500">
                      Fehler-ID f√ºr Support: <code className="font-mono bg-gray-100 px-2 py-1 rounded">{error.digest}</code>
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </body>
    </html>
  );
}
```

### Schritt 2: Styles f√ºr Global Error
Da global-error.tsx au√üerhalb des normalen Layout-Systems rendert, m√ºssen Styles inline oder separat geladen werden.

Erstelle `apps/web/app/global-error-styles.css`:

```css
/* Emergency styles for global error boundary */
.global-error-container {
  font-family: system-ui, -apple-system, sans-serif;
}

.global-error-container * {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* Animation for error icon */
@keyframes pulse-error {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.error-pulse {
  animation: pulse-error 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
```

### Schritt 3: Error Recovery Helper
Erstelle `apps/web/src/lib/error-recovery.ts`:

```typescript
// Helper functions for error recovery
export function clearErrorState() {
  // Clear all potential error-causing state
  try {
    // Clear session storage
    if (typeof sessionStorage !== 'undefined') {
      sessionStorage.clear();
    }
    
    // Clear specific localStorage items (keep user preferences)
    if (typeof localStorage !== 'undefined') {
      const keysToKeep = ['theme', 'language', 'user-preferences'];
      const allKeys = Object.keys(localStorage);
      
      allKeys.forEach(key => {
        if (!keysToKeep.some(keepKey => key.includes(keepKey))) {
          localStorage.removeItem(key);
        }
      });
    }
    
    // Clear any service worker cache
    if ('serviceWorker' in navigator && 'caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => caches.delete(name));
      });
    }
    
    return true;
  } catch (error) {
    console.error('Error clearing state:', error);
    return false;
  }
}

// Check if error is recoverable
export function isRecoverableError(error: Error): boolean {
  const recoverablePatterns = [
    'ChunkLoadError',
    'Loading chunk',
    'Failed to fetch',
    'NetworkError',
    'Hydration failed',
  ];
  
  return recoverablePatterns.some(pattern => 
    error.message.includes(pattern) || error.name.includes(pattern)
  );
}

// Auto-recovery attempt
export function attemptAutoRecovery(error: Error): void {
  if (isRecoverableError(error)) {
    console.log('Attempting auto-recovery for:', error.message);
    clearErrorState();
    
    // Reload after a short delay
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  }
}
```

## Verifizierung

### Test 1: Simuliere Global Error
```typescript
// In einer Component
throw new Error('Test global error');
// Sollte Global Error Page zeigen
```

### Test 2: Reset Funktionalit√§t
```typescript
// Nach Error anzeige
// Click "Seite neu laden"
// Sollte App neu laden
```

### Test 3: Development vs Production
```bash
# Development
npm run dev
# Sollte Stack Trace zeigen

# Production
npm run build && npm start
# Sollte nur benutzerfreundliche Meldung zeigen
```

## Erfolgskriterien
- [ ] Global Error Component erstellt
- [ ] Benutzerfreundliche deutsche UI
- [ ] Error Logging implementiert
- [ ] Development/Production Unterscheidung
- [ ] Recovery Optionen
- [ ] Error ID f√ºr Support

## Potentielle Probleme

### Problem: Styles nicht verf√ºgbar
**L√∂sung**: Inline styles oder critical CSS verwenden

### Problem: Infinite Error Loop
**L√∂sung**: Einfachste m√∂gliche Component ohne Dependencies

### Problem: Hydration Errors
**L√∂sung**: SSR-safe checks mit typeof window

## Zeitsch√§tzung
- Global Error Component: 15 Minuten
- Recovery Helpers: 5 Minuten
- Total: 20 Minuten