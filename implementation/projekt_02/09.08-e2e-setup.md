# Task 09.08: E2E Setup - Playwright Konfiguration

## Ziel
Konfiguration von Playwright für End-to-End Testing mit Browser-Automatisierung.

## Voraussetzungen
- Task 09.01 abgeschlossen (Playwright installiert)
- Development Server läuft auf Port 3004
- Browser installiert via `npx playwright install`

## Implementierung

### Schritt 1: Playwright Config
Erstelle `playwright.config.ts` im Root:

```typescript
import { defineConfig, devices } from '@playwright/test';
import path from 'path';

// Load env variables
import dotenv from 'dotenv';
dotenv.config({ path: '.env.local' });
dotenv.config({ path: '.env' });

/**
 * See https://playwright.dev/docs/test-configuration.
 */
export default defineConfig({
  testDir: './e2e',
  /* Run tests in files in parallel */
  fullyParallel: true,
  /* Fail the build on CI if you accidentally left test.only in the source code */
  forbidOnly: !!process.env.CI,
  /* Retry on CI only */
  retries: process.env.CI ? 2 : 0,
  /* Opt out of parallel tests on CI */
  workers: process.env.CI ? 1 : undefined,
  /* Reporter to use */
  reporter: process.env.CI 
    ? [['github'], ['html', { open: 'never' }]]
    : [['html', { open: 'on-failure' }]],
  
  /* Shared settings for all the projects below */
  use: {
    /* Base URL to use in actions like `await page.goto('/')` */
    baseURL: process.env.PLAYWRIGHT_TEST_URL || 'http://localhost:3004',
    
    /* Collect trace when retrying the failed test */
    trace: 'on-first-retry',
    
    /* Take screenshot on failure */
    screenshot: 'only-on-failure',
    
    /* Video on failure */
    video: 'retain-on-failure',
    
    /* Maximum time each action can take */
    actionTimeout: 15000,
    
    /* Navigation timeout */
    navigationTimeout: 30000,
  },

  /* Configure projects for major browsers */
  projects: [
    {
      name: 'setup',
      testMatch: /.*\.setup\.ts/,
    },
    
    {
      name: 'chromium',
      use: { 
        ...devices['Desktop Chrome'],
        // Use prepared auth state
        storageState: 'playwright/.auth/user.json',
      },
      dependencies: ['setup'],
    },

    {
      name: 'firefox',
      use: { 
        ...devices['Desktop Firefox'],
        storageState: 'playwright/.auth/user.json',
      },
      dependencies: ['setup'],
    },

    {
      name: 'webkit',
      use: { 
        ...devices['Desktop Safari'],
        storageState: 'playwright/.auth/user.json',
      },
      dependencies: ['setup'],
    },

    /* Test against mobile viewports */
    {
      name: 'Mobile Chrome',
      use: { 
        ...devices['Pixel 5'],
        storageState: 'playwright/.auth/user.json',
      },
      dependencies: ['setup'],
    },
    
    {
      name: 'Mobile Safari',
      use: { 
        ...devices['iPhone 12'],
        storageState: 'playwright/.auth/user.json',
      },
      dependencies: ['setup'],
    },

    /* Test against branded browsers */
    {
      name: 'Microsoft Edge',
      use: { 
        ...devices['Desktop Edge'],
        channel: 'msedge',
        storageState: 'playwright/.auth/user.json',
      },
      dependencies: ['setup'],
    },
    
    {
      name: 'Google Chrome',
      use: { 
        ...devices['Desktop Chrome'],
        channel: 'chrome',
        storageState: 'playwright/.auth/user.json',
      },
      dependencies: ['setup'],
    },
  ],

  /* Run your local dev server before starting the tests */
  webServer: {
    command: process.env.CI ? 'npm run build && npm start' : 'npm run dev',
    port: 3004,
    reuseExistingServer: !process.env.CI,
    stdout: 'pipe',
    stderr: 'pipe',
    timeout: 120000,
    env: {
      ...process.env,
      NODE_ENV: 'test',
    },
  },

  /* Folder for test artifacts such as screenshots, videos, traces, etc. */
  outputDir: 'test-results/',

  /* Global timeout */
  globalTimeout: process.env.CI ? 60 * 60 * 1000 : undefined, // 1 hour on CI
  
  /* Each test timeout */
  timeout: process.env.CI ? 60000 : 30000,
  
  /* Expect timeout */
  expect: {
    timeout: 10000,
  },
});
```

### Schritt 2: Auth Setup für Tests
Erstelle `e2e/auth.setup.ts`:

```typescript
import { test as setup, expect } from '@playwright/test';
import path from 'path';

const authFile = path.join('playwright', '.auth', 'user.json');

setup('authenticate', async ({ page, context }) => {
  // Navigate to login page
  await page.goto('/sign-in');
  
  // Check if already logged in (for local development)
  const isLoggedIn = await page.locator('[data-testid="user-menu"]').isVisible()
    .catch(() => false);
  
  if (!isLoggedIn) {
    // Mock Clerk authentication for tests
    await page.evaluate(() => {
      // Set test auth cookies/localStorage
      localStorage.setItem('__clerk_db_jwt', 'test-jwt-token');
      localStorage.setItem('__clerk_session', JSON.stringify({
        id: 'test-session-id',
        userId: 'test-user-id',
        status: 'active',
      }));
    });
    
    // Alternative: Use real Clerk test mode
    if (process.env.CLERK_TEST_EMAIL && process.env.CLERK_TEST_PASSWORD) {
      // Fill in Clerk form
      await page.fill('input[name="identifier"]', process.env.CLERK_TEST_EMAIL);
      await page.click('button[type="submit"]');
      
      await page.waitForSelector('input[name="password"]');
      await page.fill('input[name="password"]', process.env.CLERK_TEST_PASSWORD);
      await page.click('button[type="submit"]');
      
      // Wait for redirect
      await page.waitForURL('/dashboard', { timeout: 10000 });
    }
  }
  
  // Save authentication state
  await context.storageState({ path: authFile });
  
  // Verify authentication worked
  await page.goto('/dashboard');
  await expect(page).toHaveURL('/dashboard');
});

setup('authenticate as admin', async ({ page, context }) => {
  const adminAuthFile = path.join('playwright', '.auth', 'admin.json');
  
  // Similar to above but with admin credentials
  await page.evaluate(() => {
    localStorage.setItem('__clerk_db_jwt', 'test-admin-jwt-token');
    localStorage.setItem('__clerk_session', JSON.stringify({
      id: 'test-admin-session-id',
      userId: 'test-admin-id',
      status: 'active',
      publicUserData: {
        role: 'admin',
      },
    }));
  });
  
  await context.storageState({ path: adminAuthFile });
});
```

### Schritt 3: E2E Test Helpers
Erstelle `e2e/helpers/test-helpers.ts`:

```typescript
import { Page, expect, Locator } from '@playwright/test';

export class TestHelpers {
  constructor(private page: Page) {}

  // Navigation helpers
  async navigateTo(path: string) {
    await this.page.goto(path);
    await this.page.waitForLoadState('networkidle');
  }

  // Wait helpers
  async waitForElement(selector: string, timeout = 5000) {
    await this.page.waitForSelector(selector, { timeout });
  }

  async waitForText(text: string, timeout = 5000) {
    await this.page.waitForSelector(`text=${text}`, { timeout });
  }

  // Form helpers
  async fillForm(data: Record<string, string>) {
    for (const [field, value] of Object.entries(data)) {
      const input = this.page.locator(`[name="${field}"]`);
      await input.fill(value);
    }
  }

  async submitForm(buttonText = 'Submit') {
    await this.page.click(`button:has-text("${buttonText}")`);
  }

  // Assertion helpers
  async expectToast(message: string) {
    const toast = this.page.locator('[role="alert"]');
    await expect(toast).toContainText(message);
  }

  async expectError(message: string) {
    const error = this.page.locator('[role="alert"][aria-live="assertive"]');
    await expect(error).toContainText(message);
  }

  // Data helpers
  async createTestPost(data: Partial<{ title: string; content: string }> = {}) {
    await this.navigateTo('/posts/new');
    await this.fillForm({
      title: data.title || `Test Post ${Date.now()}`,
      content: data.content || 'Test content',
    });
    await this.submitForm('Create Post');
    await this.page.waitForURL('/posts/*');
  }

  async cleanupTestData() {
    // Call API to clean test data if needed
    await this.page.request.delete('/api/test/cleanup', {
      headers: {
        'X-Test-Cleanup': 'true',
      },
    });
  }

  // Screenshot helpers
  async takeDebugScreenshot(name: string) {
    await this.page.screenshot({
      path: `test-results/debug-${name}-${Date.now()}.png`,
      fullPage: true,
    });
  }

  // Accessibility helpers
  async checkAccessibility(options = {}) {
    // Run axe accessibility checks
    await this.page.addScriptTag({
      path: require.resolve('axe-core/axe.min.js'),
    });
    
    const violations = await this.page.evaluate(() => {
      return new Promise((resolve) => {
        // @ts-ignore
        window.axe.run(options, (err, results) => {
          if (err) throw err;
          resolve(results.violations);
        });
      });
    });
    
    expect(violations).toHaveLength(0);
  }

  // Performance helpers
  async measurePerformance(actionName: string, action: () => Promise<void>) {
    const startTime = Date.now();
    await action();
    const endTime = Date.now();
    const duration = endTime - startTime;
    
    console.log(`${actionName} took ${duration}ms`);
    expect(duration).toBeLessThan(3000); // Max 3 seconds
    
    return duration;
  }

  // Network helpers
  async interceptAPI(pattern: string, response: any) {
    await this.page.route(pattern, route => {
      route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify(response),
      });
    });
  }

  async waitForAPI(pattern: string) {
    return this.page.waitForResponse(response =>
      response.url().includes(pattern) && response.status() === 200
    );
  }
}

// Page Object Models
export class LoginPage {
  constructor(private page: Page) {}
  
  async login(email: string, password: string) {
    await this.page.fill('[name="email"]', email);
    await this.page.fill('[name="password"]', password);
    await this.page.click('button[type="submit"]');
    await this.page.waitForURL('/dashboard');
  }
  
  async logout() {
    await this.page.click('[data-testid="user-menu"]');
    await this.page.click('text=Sign out');
    await this.page.waitForURL('/');
  }
}

export class DashboardPage {
  constructor(private page: Page) {}
  
  async getStats() {
    const stats = await this.page.locator('[data-testid="stats"]').allTextContents();
    return stats;
  }
  
  async navigateToSection(section: string) {
    await this.page.click(`nav a:has-text("${section}")`);
  }
}
```

### Schritt 4: Global Setup
Erstelle `e2e/global-setup.ts`:

```typescript
import { chromium, FullConfig } from '@playwright/test';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: '.env.test' });
dotenv.config({ path: '.env.local' });
dotenv.config({ path: '.env' });

async function globalSetup(config: FullConfig) {
  // Set test environment variables
  process.env.NODE_ENV = 'test';
  process.env.DATABASE_URL = process.env.TEST_DATABASE_URL || process.env.DATABASE_URL;
  
  // Create .auth directory if it doesn't exist
  const fs = await import('fs');
  const authDir = path.join('playwright', '.auth');
  if (!fs.existsSync(authDir)) {
    fs.mkdirSync(authDir, { recursive: true });
  }
  
  // Optional: Seed test database
  if (process.env.SEED_TEST_DB === 'true') {
    console.log('Seeding test database...');
    // Run seed script
    const { execSync } = await import('child_process');
    execSync('npm run db:seed:test', { stdio: 'inherit' });
  }
  
  // Optional: Start mock servers
  if (process.env.USE_MOCK_SERVERS === 'true') {
    console.log('Starting mock servers...');
    // Start MSW or other mock servers
  }
  
  return async () => {
    // Global teardown
    console.log('Global teardown...');
    
    // Clean up test data
    if (process.env.CLEANUP_TEST_DB === 'true') {
      const { execSync } = await import('child_process');
      execSync('npm run db:cleanup:test', { stdio: 'inherit' });
    }
  };
}

export default globalSetup;
```

### Schritt 5: Test Environment File
Erstelle `.env.test`:

```bash
# Test Environment Variables
NODE_ENV=test
DATABASE_URL=postgresql://test:test@localhost:5432/test_db
TEST_DATABASE_URL=postgresql://test:test@localhost:5432/test_db

# Clerk Test Mode
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_testing
CLERK_SECRET_KEY=sk_test_testing
CLERK_TEST_EMAIL=test@example.com
CLERK_TEST_PASSWORD=TestPassword123!

# Test Configuration
PLAYWRIGHT_TEST_URL=http://localhost:3004
SEED_TEST_DB=true
CLEANUP_TEST_DB=true
USE_MOCK_SERVERS=false

# Disable telemetry in tests
NEXT_TELEMETRY_DISABLED=1
```

### Schritt 6: Update .gitignore
Update `.gitignore`:

```
# Playwright
/test-results/
/playwright-report/
/playwright/.cache/
/playwright/.auth/
/e2e/screenshots/
/e2e/videos/
/e2e/traces/

# Test artifacts
*.har
*.png
*.webm
test-results/
```

## Verifizierung

### Test 1: Config Validation
```bash
npx playwright test --list
# Sollte verfügbare Tests listen
```

### Test 2: Browser Installation
```bash
npx playwright install --with-deps
# Installiert Browser wenn nötig
```

### Test 3: Run Setup
```bash
npx playwright test --project=setup
# Auth Setup sollte laufen
```

### Test 4: Debug Mode
```bash
npx playwright test --debug
# Öffnet Playwright Inspector
```

## Erfolgskriterien
- [ ] playwright.config.ts erstellt und konfiguriert
- [ ] Auth Setup für Tests implementiert
- [ ] Test Helpers und Page Objects erstellt
- [ ] Global Setup/Teardown konfiguriert
- [ ] Test Environment Variables definiert
- [ ] Browser Projects konfiguriert
- [ ] Web Server Auto-Start eingerichtet
- [ ] Reporter konfiguriert
- [ ] Trace/Screenshot/Video Settings
- [ ] Mobile Testing Support

## Wichtige Hinweise

### Auth State
- Auth State wird zwischen Tests geteilt für Performance
- Separate Auth States für verschiedene Rollen (User, Admin)

### Parallel Testing
- Tests laufen parallel für schnellere Ausführung
- CI nutzt single Worker für Stabilität

### Debug Features
- `--debug` Flag für interaktives Debugging
- `--ui` Flag für Playwright UI Mode
- Traces bei Failures für Debugging

## Potentielle Probleme

### Problem: Port bereits belegt
**Lösung**: Anderen Port verwenden oder Server stoppen
```bash
lsof -ti:3004 | xargs kill -9
```

### Problem: Browser nicht installiert
**Lösung**: Browser installieren
```bash
npx playwright install chromium
```

### Problem: Auth State nicht persistent
**Lösung**: Cookies/LocalStorage prüfen
```typescript
await context.storageState({ path: authFile });
```

### Problem: Tests flaky
**Lösung**: WaitForLoadState verwenden
```typescript
await page.waitForLoadState('networkidle');
```

## Rollback Plan
Falls Setup nicht funktioniert:
```bash
# Minimal config verwenden
mv playwright.config.ts playwright.config.ts.bak
# Basis-Config ohne Auth verwenden
```

## Zeitschätzung
- Playwright Config: 10 Minuten
- Auth Setup: 8 Minuten
- Test Helpers: 8 Minuten
- Global Setup: 5 Minuten
- Environment Setup: 3 Minuten
- Verifizierung: 5 Minuten
- **Total: 39 Minuten**

## Nächster Schritt
Nach erfolgreicher E2E Setup → [09.09 E2E Tests](./09.09-e2e-tests.md)