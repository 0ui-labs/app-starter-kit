# Arbeitspaket 03.02: Database Client mit Soft Delete Extensions

## Ziel
Erstellung eines erweiterten Prisma Clients mit Soft Delete Funktionalität über Prisma Client Extensions.

## Kontext
- **Package**: `@starter-kit/db`
- **Location**: `packages/db/src/client.ts`
- **Feature**: Automatisches Soft Delete für User, Post und Comment Models

## Implementierung

### Extended Prisma Client
Erstelle `packages/db/src/client.ts`:

```typescript
import { PrismaClient } from '../generated/prisma';

// Create extended client with soft delete functionality
export const createPrismaClient = () => {
  const prisma = new PrismaClient().$extends({
    query: {
      // Soft delete for User model
      user: {
        async delete({ args, query }) {
          return query({
            ...args,
            data: { deletedAt: new Date() }
          });
        },
        async deleteMany({ args, query }) {
          return query({
            ...args,
            data: { deletedAt: new Date() }
          });
        },
        async findMany({ args, query }) {
          args.where = { ...args.where, deletedAt: null };
          return query(args);
        },
        async findFirst({ args, query }) {
          args.where = { ...args.where, deletedAt: null };
          return query(args);
        },
        async findUnique({ args, query }) {
          args.where = { ...args.where, deletedAt: null };
          return query(args);
        }
      },
      // Soft delete for Post model
      post: {
        async delete({ args, query }) {
          return query({
            ...args,
            data: { deletedAt: new Date() }
          });
        },
        async deleteMany({ args, query }) {
          return query({
            ...args,
            data: { deletedAt: new Date() }
          });
        },
        async findMany({ args, query }) {
          args.where = { ...args.where, deletedAt: null };
          return query(args);
        },
        async findFirst({ args, query }) {
          args.where = { ...args.where, deletedAt: null };
          return query(args);
        },
        async findUnique({ args, query }) {
          args.where = { ...args.where, deletedAt: null };
          return query(args);
        }
      },
      // Soft delete for Comment model
      comment: {
        async delete({ args, query }) {
          return query({
            ...args,
            data: { deletedAt: new Date() }
          });
        },
        async deleteMany({ args, query }) {
          return query({
            ...args,
            data: { deletedAt: new Date() }
          });
        },
        async findMany({ args, query }) {
          args.where = { ...args.where, deletedAt: null };
          return query(args);
        },
        async findFirst({ args, query }) {
          args.where = { ...args.where, deletedAt: null };
          return query(args);
        },
        async findUnique({ args, query }) {
          args.where = { ...args.where, deletedAt: null };
          return query(args);
        }
      }
    },
    model: {
      // Add custom methods to User model
      user: {
        async findWithDeleted(id: string) {
          return prisma.user.findUnique({
            where: { id }
          });
        },
        async restore(id: string) {
          return prisma.user.update({
            where: { id },
            data: { deletedAt: null }
          });
        },
        async hardDelete(id: string) {
          return prisma.$queryRaw`
            DELETE FROM users WHERE id = ${id}
          `;
        }
      },
      // Add custom methods to Post model
      post: {
        async findWithDeleted(id: string) {
          return prisma.post.findUnique({
            where: { id }
          });
        },
        async restore(id: string) {
          return prisma.post.update({
            where: { id },
            data: { deletedAt: null }
          });
        },
        async hardDelete(id: string) {
          return prisma.$queryRaw`
            DELETE FROM posts WHERE id = ${id}
          `;
        }
      },
      // Add custom methods to Comment model
      comment: {
        async findWithDeleted(id: string) {
          return prisma.comment.findUnique({
            where: { id }
          });
        },
        async restore(id: string) {
          return prisma.comment.update({
            where: { id },
            data: { deletedAt: null }
          });
        },
        async hardDelete(id: string) {
          return prisma.$queryRaw`
            DELETE FROM comments WHERE id = ${id}
          `;
        }
      }
    }
  });

  return prisma;
};

// Type for the extended client
export type ExtendedPrismaClient = ReturnType<typeof createPrismaClient>;

// Singleton instance for Next.js
let prismaInstance: ExtendedPrismaClient;

export const getPrismaClient = () => {
  if (!prismaInstance) {
    prismaInstance = createPrismaClient();
  }
  return prismaInstance;
};

// Development: Reset the Prisma Client during hot reloads
if (process.env.NODE_ENV !== 'production') {
  const globalWithPrisma = global as typeof globalThis & {
    prisma: ExtendedPrismaClient;
  };
  
  if (!globalWithPrisma.prisma) {
    globalWithPrisma.prisma = createPrismaClient();
  }
  prismaInstance = globalWithPrisma.prisma;
}
```

## Features

### Soft Delete Automatisierung
- `delete()` setzt automatisch `deletedAt` statt zu löschen
- `find*()` Methoden filtern gelöschte Records automatisch aus
- Transparente Integration ohne Code-Änderungen

### Custom Methods
- `findWithDeleted()`: Findet Records inkl. gelöschte
- `restore()`: Stellt gelöschte Records wieder her
- `hardDelete()`: Permanentes Löschen aus der Datenbank

### Singleton Pattern
- Verhindert mehrere Prisma Client Instanzen
- Optimiert für Next.js Hot Reload
- Production-ready

## Verwendung

```typescript
import { getPrismaClient } from '@starter-kit/db';

const prisma = getPrismaClient();

// Soft delete (setzt nur deletedAt)
await prisma.user.delete({ where: { id: '123' } });

// Find ohne gelöschte (automatisch)
const activeUsers = await prisma.user.findMany();

// Find mit gelöschten
const deletedUser = await prisma.user.findWithDeleted('123');

// Wiederherstellen
await prisma.user.restore('123');

// Permanent löschen
await prisma.user.hardDelete('123');
```

## Verifizierung

```typescript
// Test Soft Delete
const user = await prisma.user.create({ data: { email: 'test@example.com' } });
await prisma.user.delete({ where: { id: user.id } });

// User sollte nicht mehr in normalen Queries auftauchen
const users = await prisma.user.findMany();
console.assert(!users.find(u => u.id === user.id));

// Aber noch in der DB sein
const deletedUser = await prisma.user.findWithDeleted(user.id);
console.assert(deletedUser?.deletedAt !== null);
```

## Erfolgskriterien
- [ ] Extended Client mit Soft Delete
- [ ] Custom Methods für Restore und Hard Delete
- [ ] Singleton Pattern implementiert
- [ ] Hot Reload Support
- [ ] Type Safety erhalten