# Teilaufgabe 05.05: Protected Page Wrapper Component

## Ziel
Erstellung einer wiederverwendbaren Protected Page Component für Server-Side Protection mit Role und Permission Checks.

## Zeitschätzung
15 Minuten

## Vorbedingungen
- [ ] 05.01-05.04 abgeschlossen
- [ ] Auth Package mit Guards implementiert
- [ ] TypeScript Types verfügbar

## Implementierung

### Schritt 1: Erstelle Component Directory
```bash
mkdir -p apps/web/src/components/auth
```

### Schritt 2: Implementiere ProtectedPage Component

Erstelle `apps/web/src/components/auth/protected-page.tsx`:

```typescript
import { ReactNode } from 'react';
import { redirect } from 'next/navigation';
import { 
  requireAuth, 
  requireRole, 
  requirePermission,
  hasAllPermissions,
  hasAnyPermission,
  type AuthUser 
} from '@starter-kit/auth';

interface ProtectedPageProps {
  children: ReactNode | ((user: AuthUser) => ReactNode);
  role?: 'admin' | 'moderator';
  permission?: string;
  permissions?: string[];
  requireAll?: boolean;
  fallback?: ReactNode;
  redirectTo?: string;
}

export async function ProtectedPage({
  children,
  role,
  permission,
  permissions,
  requireAll = false,
  fallback,
  redirectTo,
}: ProtectedPageProps) {
  let user: AuthUser;
  
  try {
    if (role) {
      user = await requireRole(role, redirectTo);
    } else if (permission) {
      user = await requirePermission(permission, redirectTo);
    } else if (permissions && permissions.length > 0) {
      user = await requireAuth(redirectTo);
      
      const hasPerms = requireAll
        ? await hasAllPermissions(permissions)
        : await hasAnyPermission(permissions);
      
      if (!hasPerms) {
        if (fallback) return <>{fallback}</>;
        redirect('/unauthorized');
      }
    } else {
      user = await requireAuth(redirectTo);
    }
    
    return <>{typeof children === 'function' ? children(user) : children}</>;
  } catch (error) {
    if (fallback) return <>{fallback}</>;
    throw error;
  }
}
```

### Schritt 3: Erstelle Conditional Protection Component

Erstelle `apps/web/src/components/auth/conditional-render.tsx`:

```typescript
import { ReactNode } from 'react';
import { 
  hasRole, 
  hasPermission,
  hasAnyPermission,
  hasAllPermissions,
  getAuthUser,
  type AuthUser 
} from '@starter-kit/auth';

interface ConditionalRenderProps {
  children: ReactNode | ((user: AuthUser | null) => ReactNode);
  role?: 'admin' | 'moderator';
  permission?: string;
  permissions?: string[];
  requireAll?: boolean;
  fallback?: ReactNode;
}

export async function ConditionalRender({
  children,
  role,
  permission,
  permissions,
  requireAll = false,
  fallback = null,
}: ConditionalRenderProps) {
  const user = await getAuthUser();
  
  // Check conditions
  let shouldRender = !!user;
  
  if (shouldRender && role) {
    shouldRender = await hasRole(role);
  }
  
  if (shouldRender && permission) {
    shouldRender = await hasPermission(permission);
  }
  
  if (shouldRender && permissions && permissions.length > 0) {
    shouldRender = requireAll
      ? await hasAllPermissions(permissions)
      : await hasAnyPermission(permissions);
  }
  
  if (!shouldRender) {
    return <>{fallback}</>;
  }
  
  return <>{typeof children === 'function' ? children(user) : children}</>;
}
```

### Schritt 4: Erstelle Role-Specific Components

Erstelle `apps/web/src/components/auth/role-gates.tsx`:

```typescript
import { ReactNode } from 'react';
import { ProtectedPage } from './protected-page';
import { ConditionalRender } from './conditional-render';

// Admin Only Page
export function AdminOnly({ 
  children, 
  fallback 
}: { 
  children: ReactNode;
  fallback?: ReactNode;
}) {
  return (
    <ProtectedPage role="admin" fallback={fallback}>
      {children}
    </ProtectedPage>
  );
}

// Moderator Access (includes Admin)
export function ModeratorAccess({ 
  children, 
  fallback 
}: { 
  children: ReactNode;
  fallback?: ReactNode;
}) {
  return (
    <ProtectedPage role="moderator" fallback={fallback}>
      {children}
    </ProtectedPage>
  );
}

// Show only to Admin
export function ShowToAdmin({ 
  children, 
  fallback 
}: { 
  children: ReactNode;
  fallback?: ReactNode;
}) {
  return (
    <ConditionalRender role="admin" fallback={fallback}>
      {children}
    </ConditionalRender>
  );
}

// Show only to authenticated users
export function ShowToAuthenticated({ 
  children, 
  fallback 
}: { 
  children: ReactNode;
  fallback?: ReactNode;
}) {
  return (
    <ConditionalRender fallback={fallback}>
      {children}
    </ConditionalRender>
  );
}
```

### Schritt 5: Export Index

Erstelle `apps/web/src/components/auth/index.ts`:

```typescript
export { ProtectedPage } from './protected-page';
export { ConditionalRender } from './conditional-render';
export { 
  AdminOnly, 
  ModeratorAccess, 
  ShowToAdmin, 
  ShowToAuthenticated 
} from './role-gates';
```

## Usage Examples

### Example 1: Basic Page Protection
```typescript
import { ProtectedPage } from '@/components/auth';

export default function DashboardPage() {
  return (
    <ProtectedPage>
      <h1>Dashboard</h1>
      <p>This page requires authentication</p>
    </ProtectedPage>
  );
}
```

### Example 2: Admin Only Page
```typescript
import { AdminOnly } from '@/components/auth';

export default function AdminPage() {
  return (
    <AdminOnly fallback={<div>Access Denied</div>}>
      <h1>Admin Panel</h1>
    </AdminOnly>
  );
}
```

### Example 3: With User Data
```typescript
import { ProtectedPage } from '@/components/auth';

export default function ProfilePage() {
  return (
    <ProtectedPage>
      {(user) => (
        <div>
          <h1>Welcome, {user.name}!</h1>
          <p>Email: {user.email}</p>
          <p>Role: {user.role}</p>
        </div>
      )}
    </ProtectedPage>
  );
}
```

### Example 4: Conditional UI Elements
```typescript
import { ShowToAdmin, ShowToAuthenticated } from '@/components/auth';

export default function HomePage() {
  return (
    <div>
      <h1>Welcome</h1>
      
      <ShowToAuthenticated fallback={<a href="/sign-in">Sign In</a>}>
        <a href="/dashboard">Go to Dashboard</a>
      </ShowToAuthenticated>
      
      <ShowToAdmin>
        <button>Admin Actions</button>
      </ShowToAdmin>
    </div>
  );
}
```

### Example 5: Permission Based
```typescript
import { ProtectedPage } from '@/components/auth';
import { PERMISSIONS } from '@starter-kit/auth';

export default function EditPostPage() {
  return (
    <ProtectedPage permission={PERMISSIONS.POST_UPDATE}>
      <h1>Edit Post</h1>
    </ProtectedPage>
  );
}
```

## Verifizierung

### Test 1: Basic Protection
```typescript
// Nicht eingeloggt → Redirect zu /sign-in
// Eingeloggt → Zeigt Content
```

### Test 2: Role Protection
```typescript
// Als User → Redirect zu /unauthorized
// Als Admin → Zeigt Content
```

### Test 3: Fallback Rendering
```typescript
// Ohne Berechtigung → Zeigt Fallback
// Mit Berechtigung → Zeigt Content
```

### Test 4: Function Children
```typescript
// User Daten werden korrekt an Function übergeben
// Type Safety funktioniert
```

## Erfolgskriterien
- [ ] ProtectedPage Component erstellt
- [ ] ConditionalRender Component erstellt
- [ ] Role-specific Gates implementiert
- [ ] Fallback Support funktioniert
- [ ] Function Children Support
- [ ] TypeScript Types korrekt
- [ ] Export Index erstellt

## Troubleshooting

### Problem: Component rendert nicht
**Lösung:**
1. Prüfe ob Component als Server Component verwendet wird
2. Stelle sicher dass await verwendet wird
3. Check Console für Errors

### Problem: Redirect funktioniert nicht
**Lösung:**
1. Verwende Component nur in Server Components
2. Nicht in Client Components ('use client')
3. Alternative: Router.push in Client Components

### Problem: User Data nicht verfügbar
**Lösung:**
1. Prüfe ob User eingeloggt ist
2. Verifiziere Auth Package Implementation
3. Check Session Cookie

## Nächster Schritt
Nach erfolgreicher Protected Page Implementation → [05.06-api-route-protection.md](./05.06-api-route-protection.md)