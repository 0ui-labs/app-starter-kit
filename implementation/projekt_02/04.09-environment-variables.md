# Arbeitspaket 04.09: Environment Variables Setup

## Ziel
Konfiguration aller notwendigen Clerk Environment Variables.

## Vorbedingungen
- [ ] Clerk Account erstellt auf clerk.com
- [ ] Neue Application in Clerk Dashboard angelegt
- [ ] API Keys aus Clerk Dashboard kopiert

## Implementierung

### Schritt 1: Environment Variables Template
Update `.env.example`:

```bash
# Clerk Authentication
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...

# Clerk URLs (optional aber empfohlen)
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/dashboard

# Clerk Webhook Secret (für spätere Webhook Integration)
CLERK_WEBHOOK_SECRET=whsec_...
```

### Schritt 2: Lokale Environment Setup
Erstelle/Update `.env.local`:

```bash
# Clerk Authentication (aus Clerk Dashboard kopieren)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_your_actual_key_here
CLERK_SECRET_KEY=sk_test_your_actual_secret_here

# Clerk URLs
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/dashboard
```

### Schritt 3: Clerk Dashboard Konfiguration

#### In Clerk Dashboard (clerk.com):

1. **Paths Configuration**:
   - Sign in URL: `/sign-in`
   - Sign up URL: `/sign-up`
   - After sign in URL: `/dashboard`
   - After sign up URL: `/dashboard`
   - Home URL: `/`

2. **Allowed Redirect URLs**:
   ```
   http://localhost:3004/*
   http://localhost:3000/*
   https://your-production-domain.com/*
   ```

3. **Social Login Providers** (optional):
   - Google OAuth
   - GitHub OAuth
   - Microsoft OAuth

4. **Session Settings**:
   - Session lifetime: 7 days
   - Inactivity timeout: 30 minutes

### Schritt 4: Environment Validation
Erstelle `apps/web/src/lib/env.ts`:

```typescript
// Runtime environment validation
export function validateEnv() {
  const required = [
    'NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY',
    'CLERK_SECRET_KEY',
  ];

  const missing = required.filter(key => !process.env[key]);
  
  if (missing.length > 0) {
    throw new Error(
      `Missing required environment variables: ${missing.join(', ')}\n` +
      `Please check your .env.local file.`
    );
  }
}

// Optional: Type-safe environment variables
export const env = {
  clerk: {
    publishableKey: process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY!,
    secretKey: process.env.CLERK_SECRET_KEY!,
    signInUrl: process.env.NEXT_PUBLIC_CLERK_SIGN_IN_URL || '/sign-in',
    signUpUrl: process.env.NEXT_PUBLIC_CLERK_SIGN_UP_URL || '/sign-up',
    afterSignInUrl: process.env.NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL || '/dashboard',
    afterSignUpUrl: process.env.NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL || '/dashboard',
  },
} as const;
```

### Schritt 5: Production Environment Variables

#### Für Vercel Deployment:
```bash
# In Vercel Dashboard → Settings → Environment Variables
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_...
CLERK_SECRET_KEY=sk_live_...
```

#### Für andere Hosting Provider:
```bash
# .env.production
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_...
CLERK_SECRET_KEY=sk_live_...
```

## Sicherheitshinweise

### NIEMALS committen:
- `.env.local`
- `.env.production` mit echten Keys
- Jegliche Dateien mit `sk_` Keys

### Immer in .gitignore:
```gitignore
# Environment files
.env
.env.local
.env.production
.env.*.local
```

## Debugging

### Problem: "Missing publishable key"
```bash
# Prüfe ob Variable gesetzt ist
echo $NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY

# Restart Dev Server
npm run dev
```

### Problem: "Invalid API key"
- Prüfe ob Production/Development Keys vertauscht sind
- Development: `pk_test_` und `sk_test_`
- Production: `pk_live_` und `sk_live_`

## Verifizierung
1. `npm run dev` startet ohne Fehler
2. Clerk Components laden korrekt
3. Authentication funktioniert
4. Keine Console Errors bezüglich Keys

## Erfolgskriterien
- [ ] .env.example ist aktualisiert
- [ ] .env.local enthält gültige Keys
- [ ] Clerk Dashboard ist konfiguriert
- [ ] Environment Validation funktioniert
- [ ] Keys sind NICHT im Git Repository

## Zeitschätzung: 5 Minuten

## Nächster Schritt
→ 04.10: Testing & Verification