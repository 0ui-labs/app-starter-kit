# Teilaufgabe 05.08: Usage Examples

## Ziel
Erstellung von umfassenden Beispielen für die Verwendung des Authentication Systems.

## Zeitschätzung
10 Minuten

## Vorbedingungen
- [ ] 05.01-05.07 abgeschlossen
- [ ] Alle Auth Components funktionieren
- [ ] TypeScript Setup komplett

## Implementierung

### Schritt 1: Server Component Examples

Erstelle `apps/web/src/app/examples/server-components.tsx`:

```typescript
// ============================================
// Server Component Examples
// ============================================

import { 
  requireAuth, 
  requireRole,
  hasRole, 
  hasPermission,
  getAuthUser,
  getSession,
  PERMISSIONS 
} from '@starter-kit/auth';
import { 
  ProtectedPage,
  AdminOnly,
  ShowToAdmin,
  ConditionalRender 
} from '@/components/auth';

// Example 1: Basic Protected Page
export async function BasicProtectedPage() {
  const user = await requireAuth(); // Redirects if not authenticated
  
  return (
    <div>
      <h1>Welcome {user.name}</h1>
      <p>This page requires authentication</p>
    </div>
  );
}

// Example 2: Using ProtectedPage Component
export async function ProtectedDashboard() {
  return (
    <ProtectedPage>
      {(user) => (
        <div>
          <h1>Dashboard for {user.email}</h1>
          <p>Role: {user.role}</p>
          <p>Permissions: {user.permissions.join(', ')}</p>
        </div>
      )}
    </ProtectedPage>
  );
}

// Example 3: Admin Only Page
export async function AdminPanel() {
  return (
    <AdminOnly fallback={<div>Admin access required</div>}>
      <h1>Admin Panel</h1>
      <p>Secret admin content here</p>
    </AdminOnly>
  );
}

// Example 4: Conditional Rendering
export async function NavigationBar() {
  const isAdmin = await hasRole('admin');
  const canModerate = await hasPermission(PERMISSIONS.COMMENT_MODERATE);
  
  return (
    <nav>
      <a href="/home">Home</a>
      <a href="/dashboard">Dashboard</a>
      
      {isAdmin && <a href="/admin">Admin</a>}
      {canModerate && <a href="/moderate">Moderate</a>}
      
      <ShowToAdmin>
        <a href="/admin/settings">Settings</a>
      </ShowToAdmin>
    </nav>
  );
}

// Example 5: Permission-based Access
export async function PostEditor({ postId }: { postId: string }) {
  return (
    <ProtectedPage permission={PERMISSIONS.POST_UPDATE}>
      <div>
        <h1>Edit Post {postId}</h1>
        {/* Editor content */}
      </div>
    </ProtectedPage>
  );
}

// Example 6: Multiple Permissions (ANY)
export async function ContentManager() {
  return (
    <ProtectedPage 
      permissions={[
        PERMISSIONS.POST_CREATE,
        PERMISSIONS.POST_UPDATE,
        PERMISSIONS.POST_DELETE
      ]}
      requireAll={false} // User needs ANY of these permissions
    >
      <h1>Content Management</h1>
    </ProtectedPage>
  );
}

// Example 7: Multiple Permissions (ALL)
export async function SuperAdminPanel() {
  return (
    <ProtectedPage 
      permissions={[
        PERMISSIONS.ADMIN_ACCESS,
        PERMISSIONS.ADMIN_SETTINGS
      ]}
      requireAll={true} // User needs ALL permissions
    >
      <h1>Super Admin Panel</h1>
    </ProtectedPage>
  );
}

// Example 8: With Custom Redirect
export async function CustomRedirectExample() {
  return (
    <ProtectedPage redirectTo="/custom-login">
      <h1>Protected Content</h1>
    </ProtectedPage>
  );
}

// Example 9: Session Information
export async function SessionInfo() {
  const session = await getSession();
  
  if (!session) {
    return <div>No active session</div>;
  }
  
  return (
    <div>
      <h2>Session Details</h2>
      <p>User: {session.user.email}</p>
      <p>Expires: {session.expires.toLocaleString()}</p>
      <p>Active: {session.isActive ? 'Yes' : 'No'}</p>
    </div>
  );
}

// Example 10: Complex Authorization Logic
export async function ComplexAuthExample() {
  const user = await getAuthUser();
  
  if (!user) {
    return <div>Please sign in</div>;
  }
  
  const isAdmin = user.role === 'admin';
  const isModerator = user.role === 'moderator';
  const canPublish = user.permissions.includes(PERMISSIONS.POST_PUBLISH);
  
  return (
    <div>
      <h1>Content Dashboard</h1>
      
      {/* Admin or Moderator */}
      {(isAdmin || isModerator) && (
        <section>
          <h2>Moderation Queue</h2>
          {/* ... */}
        </section>
      )}
      
      {/* Specific permission */}
      {canPublish && (
        <button>Publish Post</button>
      )}
      
      {/* Admin only */}
      {isAdmin && (
        <section>
          <h2>System Settings</h2>
          {/* ... */}
        </section>
      )}
    </div>
  );
}
```

### Schritt 2: API Route Examples

Erstelle `apps/web/src/app/examples/api-routes.ts`:

```typescript
// ============================================
// API Route Protection Examples
// ============================================

import { NextRequest, NextResponse } from 'next/server';
import { 
  withAPIAuth, 
  protectAPI,
  withCSRFProtection 
} from '@/lib/api-auth';
import { withRateLimit } from '@/lib/rate-limit';
import { PERMISSIONS } from '@starter-kit/auth';

// Example 1: Basic Protected API
export const example1GET = withAPIAuth(
  async (req: NextRequest, user) => {
    return NextResponse.json({
      message: 'Protected endpoint',
      userId: user?.id,
      userEmail: user?.email
    });
  }
);

// Example 2: Admin Only API
export const example2POST = protectAPI(
  async (req: NextRequest, user) => {
    const data = await req.json();
    
    // User is guaranteed to be admin
    return NextResponse.json({
      success: true,
      adminAction: 'completed',
      by: user?.email
    });
  },
  { role: 'admin' }
);

// Example 3: Permission-based API
export const example3PUT = protectAPI(
  async (req: NextRequest, user) => {
    const data = await req.json();
    
    // User has POST_UPDATE permission
    return NextResponse.json({
      updated: true,
      by: user?.email
    });
  },
  { permission: PERMISSIONS.POST_UPDATE }
);

// Example 4: Multiple Permissions (ANY)
export const example4DELETE = protectAPI(
  async (req: NextRequest, user) => {
    // User has at least one of these permissions
    return NextResponse.json({
      deleted: true
    });
  },
  { 
    permissions: [
      PERMISSIONS.POST_DELETE,
      PERMISSIONS.ADMIN_ACCESS
    ],
    requireAll: false 
  }
);

// Example 5: Multiple Permissions (ALL)
export const example5PATCH = protectAPI(
  async (req: NextRequest, user) => {
    // User has ALL of these permissions
    return NextResponse.json({
      patched: true
    });
  },
  { 
    permissions: [
      PERMISSIONS.ADMIN_ACCESS,
      PERMISSIONS.ADMIN_SETTINGS
    ],
    requireAll: true 
  }
);

// Example 6: Public API with Rate Limiting
export const example6PublicAPI = withRateLimit(
  async (req: NextRequest) => {
    return NextResponse.json({
      message: 'Public API',
      timestamp: new Date().toISOString()
    });
  },
  { requests: 10, window: 60 } // 10 requests per minute
);

// Example 7: Mixed Protection (Auth + Rate Limit)
export const example7Mixed = withRateLimit(
  withAPIAuth(
    async (req: NextRequest, user) => {
      return NextResponse.json({
        message: 'Protected and rate limited',
        user: user?.email
      });
    }
  ),
  { requests: 5, window: 60 }
);

// Example 8: CSRF Protection for Mutations
export const example8Mutation = withCSRFProtection(
  withAPIAuth(
    async (req: NextRequest, user) => {
      const data = await req.json();
      
      // Safe from CSRF attacks
      return NextResponse.json({
        created: true,
        data
      });
    }
  )
);

// Example 9: Complete API Route File
// apps/web/src/app/api/posts/[id]/route.ts
export async function GET(
  req: NextRequest,
  { params }: { params: { id: string } }
) {
  // Public read
  return NextResponse.json({
    post: { id: params.id, title: 'Example Post' }
  });
}

export const PUT = protectAPI(
  async (req: NextRequest, user) => {
    const data = await req.json();
    // Update post logic
    return NextResponse.json({ updated: true });
  },
  { permission: PERMISSIONS.POST_UPDATE }
);

export const DELETE = protectAPI(
  async (req: NextRequest, user) => {
    // Delete post logic
    return NextResponse.json({ deleted: true });
  },
  { role: 'admin' }
);
```

### Schritt 3: Client Component Examples

Erstelle `apps/web/src/app/examples/client-components.tsx`:

```typescript
// ============================================
// Client Component Examples
// ============================================

'use client';

import { useAuth, useUser } from '@clerk/nextjs';
import { useState, useEffect } from 'react';
import { Button } from '@starter-kit/ui';

// Example 1: Basic Client Auth Check
export function ClientAuthStatus() {
  const { isLoaded, userId, sessionId } = useAuth();
  
  if (!isLoaded) {
    return <div>Loading...</div>;
  }
  
  if (!userId) {
    return <div>Not signed in</div>;
  }
  
  return (
    <div>
      <p>User ID: {userId}</p>
      <p>Session ID: {sessionId}</p>
    </div>
  );
}

// Example 2: User Information
export function ClientUserInfo() {
  const { isLoaded, isSignedIn, user } = useUser();
  
  if (!isLoaded) {
    return <div>Loading...</div>;
  }
  
  if (!isSignedIn || !user) {
    return <div>Not signed in</div>;
  }
  
  return (
    <div>
      <p>Email: {user.primaryEmailAddress?.emailAddress}</p>
      <p>Name: {user.fullName}</p>
      <img src={user.imageUrl} alt="Profile" />
      <p>Role: {user.publicMetadata?.role as string}</p>
    </div>
  );
}

// Example 3: Protected Client Action
export function ClientProtectedAction() {
  const { isSignedIn, getToken } = useAuth();
  const [loading, setLoading] = useState(false);
  
  const handleProtectedAction = async () => {
    if (!isSignedIn) {
      alert('Please sign in first');
      return;
    }
    
    setLoading(true);
    try {
      const token = await getToken();
      
      const response = await fetch('/api/protected', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      const data = await response.json();
      console.log('Protected data:', data);
    } catch (error) {
      console.error('Error:', error);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <Button 
      onClick={handleProtectedAction}
      disabled={loading || !isSignedIn}
    >
      {loading ? 'Loading...' : 'Perform Protected Action'}
    </Button>
  );
}

// Example 4: Role-based Client UI
export function ClientRoleBasedUI() {
  const { user } = useUser();
  const role = user?.publicMetadata?.role as string;
  
  return (
    <div>
      <h2>Dashboard</h2>
      
      {/* Everyone sees this */}
      <section>
        <h3>General Content</h3>
      </section>
      
      {/* Only moderators and admins */}
      {['moderator', 'admin'].includes(role) && (
        <section>
          <h3>Moderation Tools</h3>
        </section>
      )}
      
      {/* Only admins */}
      {role === 'admin' && (
        <section>
          <h3>Admin Settings</h3>
        </section>
      )}
    </div>
  );
}

// Example 5: Client-side Permission Check
export function ClientPermissionCheck() {
  const { user } = useUser();
  const permissions = user?.publicMetadata?.permissions as string[] || [];
  
  const hasPermission = (permission: string) => {
    return permissions.includes(permission) || 
           user?.publicMetadata?.role === 'admin';
  };
  
  return (
    <div>
      {hasPermission('post:create') && (
        <Button>Create Post</Button>
      )}
      
      {hasPermission('post:update') && (
        <Button>Edit Post</Button>
      )}
      
      {hasPermission('post:delete') && (
        <Button variant="destructive">Delete Post</Button>
      )}
    </div>
  );
}
```

### Schritt 4: Integration Examples

Erstelle `apps/web/src/app/examples/integration.md`:

```markdown
# Authentication System Integration Examples

## 1. Dashboard Page with Mixed Protection

\`\`\`typescript
// apps/web/src/app/dashboard/page.tsx
import { ProtectedPage, ShowToAdmin } from '@/components/auth';
import { ClientUserInfo } from './client-components';

export default function Dashboard() {
  return (
    <ProtectedPage>
      {(user) => (
        <div>
          <h1>Dashboard</h1>
          
          {/* Server-side user info */}
          <div>
            <h2>Server Info</h2>
            <p>Email: {user.email}</p>
            <p>Role: {user.role}</p>
          </div>
          
          {/* Client-side user info */}
          <ClientUserInfo />
          
          {/* Conditional server rendering */}
          <ShowToAdmin>
            <a href="/admin">Admin Panel</a>
          </ShowToAdmin>
        </div>
      )}
    </ProtectedPage>
  );
}
\`\`\`

## 2. Form with API Protection

\`\`\`typescript
// Client Component
'use client';
export function CreatePostForm() {
  const { getToken } = useAuth();
  
  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    const token = await getToken();
    
    await fetch('/api/posts', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    });
  };
  
  return <form onSubmit={handleSubmit}>...</form>;
}

// API Route
export const POST = protectAPI(
  async (req, user) => {
    const data = await req.json();
    // Create post in database
    return NextResponse.json({ created: true });
  },
  { permission: PERMISSIONS.POST_CREATE }
);
\`\`\`

## 3. Role-based Navigation

\`\`\`typescript
import { hasRole } from '@starter-kit/auth';

export async function Navigation() {
  const isAdmin = await hasRole('admin');
  const isModerator = await hasRole('moderator');
  
  return (
    <nav>
      <Link href="/">Home</Link>
      <Link href="/dashboard">Dashboard</Link>
      {(isAdmin || isModerator) && (
        <Link href="/moderate">Moderate</Link>
      )}
      {isAdmin && (
        <Link href="/admin">Admin</Link>
      )}
    </nav>
  );
}
\`\`\`
```

## Verifizierung

### Test 1: Server Components
- Erstelle Test Page mit Examples
- Verifiziere Auth Redirects
- Check Role-based Rendering

### Test 2: API Routes
- Teste protected Endpoints
- Verifiziere Role Checks
- Check Permission Validation

### Test 3: Client Components
- Check Client Auth Status
- Test Protected Actions
- Verify Role-based UI

## Erfolgskriterien
- [ ] Server Component Examples funktionieren
- [ ] API Route Examples funktionieren
- [ ] Client Component Examples funktionieren
- [ ] Integration Examples klar dokumentiert
- [ ] TypeScript Types korrekt
- [ ] Alle Patterns abgedeckt

## Nächster Schritt
Nach erfolgreichen Examples → [05.09-admin-role-management.md](./05.09-admin-role-management.md)