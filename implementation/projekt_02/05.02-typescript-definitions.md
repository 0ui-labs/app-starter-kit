# Teilaufgabe 05.02: TypeScript Global Definitions

## Ziel
Erstellung von TypeScript Type Definitions für Roles und Permissions System.

## Zeitschätzung
5 Minuten

## Vorbedingungen
- [ ] 05.01 abgeschlossen (Clerk Dashboard konfiguriert)
- [ ] TypeScript im Projekt konfiguriert

## Implementierung

### Schritt 1: Erstelle Global Types Directory
```bash
mkdir -p apps/web/src/types
```

### Schritt 2: Erstelle globals.d.ts

Erstelle `apps/web/src/types/globals.d.ts`:

```typescript
export {}

// Create types for roles and permissions
export type Roles = 'user' | 'moderator' | 'admin';
export type Permission = string;

declare global {
  interface CustomJwtSessionClaims {
    metadata: {
      role?: Roles;
      permissions?: Permission[];
    }
  }
}
```

### Schritt 3: Update tsconfig.json

Stelle sicher dass die Types inkludiert sind in `apps/web/tsconfig.json`:

```json
{
  "compilerOptions": {
    // ... existing config
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    "src/types/**/*.d.ts"  // Diese Zeile hinzufügen
  ]
}
```

### Schritt 4: Erweitere Clerk Types (Optional)

Erstelle `apps/web/src/types/clerk.d.ts` für erweiterte Clerk Types:

```typescript
import { Roles, Permission } from './globals';

declare module '@clerk/nextjs/server' {
  interface SessionClaims {
    metadata?: {
      role?: Roles;
      permissions?: Permission[];
    };
  }
}

declare module '@clerk/types' {
  interface UserPublicMetadata {
    role?: Roles;
    permissions?: Permission[];
  }
}
```

## Verifizierung

### Test 1: TypeScript Kompilierung
```bash
cd apps/web
npx tsc --noEmit
```
Sollte ohne Fehler durchlaufen.

### Test 2: IntelliSense Test
Erstelle eine Test-Datei `apps/web/src/test-types.ts`:

```typescript
import { auth } from '@clerk/nextjs/server';

async function testTypes() {
  const { sessionClaims } = await auth();
  
  // IntelliSense sollte metadata anzeigen
  const role = sessionClaims?.metadata?.role;
  const permissions = sessionClaims?.metadata?.permissions;
  
  // Type checking sollte funktionieren
  if (role === 'admin') { // OK
    console.log('Admin user');
  }
  
  // if (role === 'invalid') { // TypeScript Error erwünscht
  //   console.log('Invalid role');
  // }
}
```

### Test 3: Auto-Import Test
In einer beliebigen TypeScript Datei:
```typescript
// Tippe: Roles
// IDE sollte auto-import vorschlagen von '@/types/globals'
```

## Erfolgskriterien
- [ ] globals.d.ts erstellt mit Roles und Permission Types
- [ ] TypeScript kompiliert ohne Fehler
- [ ] IntelliSense funktioniert für sessionClaims.metadata
- [ ] Auto-Import funktioniert für custom Types

## Troubleshooting

### Problem: Types werden nicht erkannt
**Lösung:**
1. TypeScript Server neustarten: Cmd+Shift+P → "TypeScript: Restart TS Server"
2. Node modules neu installieren: `npm install`
3. Build cache leeren: `rm -rf .next`

### Problem: Property 'metadata' does not exist
**Lösung:**
1. Prüfe ob globals.d.ts korrekt erstellt wurde
2. Stelle sicher dass `export {}` am Anfang steht
3. Prüfe tsconfig.json include Pfade

### Problem: Duplicate identifier Fehler
**Lösung:**
1. Prüfe ob Types nur einmal definiert sind
2. Nutze `declare global` nur in einer Datei
3. Verwende eindeutige Interface Namen

## Best Practices
- Halte Types minimal und erweiterbar
- Nutze String Literal Types für Roles
- Verwende generische Permission Strings für Flexibilität
- Dokumentiere komplexe Types mit JSDoc Comments

## Nächster Schritt
Nach erfolgreicher Type-Definition → [05.03-middleware-implementation.md](./05.03-middleware-implementation.md)