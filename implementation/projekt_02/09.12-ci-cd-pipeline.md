# Teilaufgabe 09.12: CI/CD Pipeline einrichten

## üéØ Ziel
Einrichtung einer automatisierten CI/CD-Pipeline mit GitHub Actions, die bei jedem Push und Pull Request automatisch Linting, Type-Checks und Tests (Unit, Integration & E2E) ausf√ºhrt, um die Code-Qualit√§t sicherzustellen.

## üõ†Ô∏è Implementierung

### Schritt 1: Workflow-Datei erstellen
Erstellen Sie die folgende Datei in Ihrem Repository:

**Datei**: `.github/workflows/ci.yml`

```yaml
name: CI-Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: "postgresql://testuser:testpassword@localhost:5432/testdb"
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
      CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
      # F√ºgen Sie hier weitere Test-Umgebungsvariablen hinzu

    steps:
      - name: 1. Code auschecken
        uses: actions/checkout@v4

      - name: 2. Node.js Umgebung einrichten
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: 3. Dependencies installieren
        run: npm ci

      - name: 4. Prisma Client generieren
        run: npx prisma generate --schema=./packages/db/prisma/schema.prisma

      - name: 5. Datenbank migrieren
        run: npx prisma migrate deploy --schema=./packages/db/prisma/schema.prisma

      - name: 6. Linting und Type-Checks ausf√ºhren
        run: npm run lint && npm run typecheck

      - name: 7. Unit- & Integrationstests ausf√ºhren
        run: npm run test:coverage

      - name: 8. Playwright Browser installieren
        run: npx playwright install --with-deps

      - name: 9. E2E-Tests ausf√ºhren
        run: npm run test:e2e

      - name: 10. Test-Reports hochladen
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
```

### Schritt 2: GitHub Secrets konfigurieren
Gehen Sie in Ihrem GitHub-Repository zu **Settings > Secrets and variables > Actions** und f√ºgen Sie folgende Secrets hinzu:

- `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`: Ihr Clerk Public Key
- `CLERK_SECRET_KEY`: Ihr Clerk Secret Key
- Weitere API-Keys je nach Bedarf (z.B. `OPENAI_API_KEY`)

### Schritt 3: NPM Scripts f√ºr CI vorbereiten
Stellen Sie sicher, dass folgende Scripts in der root `package.json` vorhanden sind:

```json
{
  "scripts": {
    "lint": "turbo run lint",
    "typecheck": "turbo run typecheck",
    "test": "vitest run",
    "test:coverage": "vitest run --coverage",
    "test:e2e": "playwright test",
    "build": "turbo run build"
  }
}
```

### Schritt 4: TypeCheck Script in Packages hinzuf√ºgen
F√ºgen Sie in jedem Package ein `typecheck` Script hinzu:

```json
{
  "scripts": {
    "typecheck": "tsc --noEmit"
  }
}
```

## ‚úÖ Verifizierung

### Test 1: Lokale Verifizierung
```bash
# Simuliere CI-Pipeline lokal
npm ci
npm run lint
npm run typecheck
npm run test:coverage
npm run test:e2e
```

### Test 2: GitHub Actions
1. Erstellen Sie einen neuen Branch
2. Machen Sie eine kleine √Ñnderung
3. Pushen Sie und erstellen Sie einen Pull Request
4. √úberpr√ºfen Sie, dass die CI-Pipeline l√§uft und gr√ºn ist

## üìä Erfolgskriterien
- [ ] GitHub Actions Workflow erstellt
- [ ] PostgreSQL Service f√ºr Tests konfiguriert
- [ ] Alle CI-Steps laufen erfolgreich durch
- [ ] Test-Reports werden als Artifacts gespeichert
- [ ] Pipeline l√§uft bei jedem Push/PR automatisch
- [ ] Secrets sind sicher in GitHub konfiguriert

## ‚ö†Ô∏è Potentielle Probleme

### Problem: CI-Pipeline schl√§gt bei Playwright fehl
**L√∂sung**: Stellen Sie sicher, dass `--with-deps` Flag verwendet wird:
```yaml
- run: npx playwright install --with-deps
```

### Problem: Prisma Client nicht gefunden
**L√∂sung**: Generieren Sie Prisma Client vor den Tests:
```yaml
- run: npx prisma generate --schema=./packages/db/prisma/schema.prisma
```

### Problem: npm ci schl√§gt fehl
**L√∂sung**: Committen Sie `package-lock.json` ins Repository

## ‚è±Ô∏è Zeitsch√§tzung
- Workflow-Datei erstellen: 10 Minuten
- GitHub Secrets konfigurieren: 5 Minuten
- NPM Scripts anpassen: 10 Minuten
- Testen und Debugging: 15 Minuten
- **Total**: 40 Minuten

## üîÑ Rollback Plan
Falls die CI-Pipeline Probleme verursacht:
1. Deaktivieren Sie die Workflow-Datei tempor√§r durch Umbenennung zu `.github/workflows/ci.yml.disabled`
2. Nutzen Sie lokale Tests bis das Problem behoben ist

## üìù Notizen
- Die Pipeline nutzt Ubuntu Latest als Runner
- PostgreSQL 15 wird als Service f√ºr Datenbanktests bereitgestellt
- Test-Artifacts werden 30 Tage aufbewahrt
- Bei Fehlern werden trotzdem Reports hochgeladen (`if: always()`)