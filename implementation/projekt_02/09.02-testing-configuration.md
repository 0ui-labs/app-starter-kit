# Task 09.02: Testing Configuration - Vitest und Coverage Setup

## Ziel
Konfiguration von Vitest mit Coverage-Reporting, Test-Umgebung und Pfad-Aliasing für alle Packages.

## Voraussetzungen
- Task 09.01 abgeschlossen (Dependencies installiert)
- Vitest und Coverage-Provider verfügbar

## Implementierung

### Schritt 1: Vitest Config erstellen/updaten
Erstelle oder update `vitest.config.ts` im Root-Verzeichnis:

```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./vitest.setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html', 'lcov'],
      include: [
        'packages/*/src/**/*.{ts,tsx}',
        'apps/web/src/**/*.{ts,tsx}',
      ],
      exclude: [
        'node_modules/',
        '.next/',
        '*.config.ts',
        '**/*.d.ts',
        '**/generated/**',
        '**/__tests__/**',
        '**/examples/**',
        '**/*.test.{ts,tsx}',
        '**/*.spec.{ts,tsx}',
      ],
      thresholds: {
        branches: 70,
        functions: 70,
        lines: 70,
        statements: 70,
      },
    },
    include: [
      'packages/**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}',
      'apps/**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}',
    ],
    exclude: [
      'node_modules',
      '.next',
      'dist',
      '.turbo',
      'coverage',
    ],
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './apps/web/src'),
      '@starter-kit/ui': path.resolve(__dirname, './packages/ui'),
      '@starter-kit/db': path.resolve(__dirname, './packages/db'),
      '@starter-kit/auth': path.resolve(__dirname, './packages/auth'),
      '@starter-kit/api': path.resolve(__dirname, './packages/api'),
      '@starter-kit/ai-adapter': path.resolve(__dirname, './packages/ai-adapter'),
      '@starter-kit/agentic-workflows': path.resolve(__dirname, './packages/agentic-workflows'),
    },
  },
});
```

### Schritt 2: TypeScript Config für Tests
Update `tsconfig.json` im Root (falls nötig):

```json
{
  "compilerOptions": {
    "types": ["vitest/globals", "@testing-library/jest-dom"]
  }
}
```

### Schritt 3: Coverage Ordner zu .gitignore hinzufügen
Update `.gitignore`:

```
# Test Coverage
coverage/
*.lcov
.nyc_output/

# Test Reports
test-results/
playwright-report/
playwright/.cache/
```

### Schritt 4: Verzeichnisstruktur vorbereiten
```bash
# Test-Verzeichnisse erstellen
mkdir -p test/mocks
mkdir -p test/utils
mkdir -p test/factories
mkdir -p e2e
```

## Verifizierung

### Test 1: Config Syntax prüfen
```bash
npx vitest --version
# Sollte ohne Fehler die Version ausgeben
```

### Test 2: Config laden
```bash
npx vitest list
# Sollte nach Tests suchen (auch wenn noch keine existieren)
```

### Test 3: Coverage Provider
```bash
npx vitest run --coverage --run
# Sollte Coverage-Provider v8 verwenden (Fehler wegen fehlender Tests ist OK)
```

### Test 4: Alias Resolution
```typescript
// Temporäre Test-Datei erstellen zum Prüfen
// test-alias.test.ts
import { describe, it, expect } from 'vitest';

describe('Alias Resolution', () => {
  it('should resolve package aliases', () => {
    expect(true).toBe(true);
  });
});
```

## Erfolgskriterien
- [ ] vitest.config.ts erstellt und syntaktisch korrekt
- [ ] Coverage Provider v8 konfiguriert
- [ ] Coverage Reporter konfiguriert (text, json, html, lcov)
- [ ] Coverage Thresholds auf 70% gesetzt
- [ ] Test Include/Exclude Patterns definiert
- [ ] Path Aliases für alle Packages konfiguriert
- [ ] Setup Files Pfad konfiguriert
- [ ] jsdom als Test Environment gesetzt
- [ ] Test-Verzeichnisse erstellt

## Wichtige Hinweise

### Coverage Provider
- Wir nutzen `v8` statt dem veralteten `c8` Provider
- v8 ist schneller und genauer für moderne JavaScript/TypeScript

### Path Aliases
- Die Aliases müssen mit den tatsächlichen Package-Pfaden übereinstimmen
- Bei Import-Problemen die Pfade in tsconfig.json prüfen

### Coverage Thresholds
- Initial auf 70% gesetzt
- Kann später erhöht werden wenn mehr Tests existieren
- CI/CD kann bei Unterschreitung fehlschlagen

## Potentielle Probleme

### Problem: "Cannot find module 'react'"
**Lösung**: React Plugin installieren
```bash
npm install -D @vitejs/plugin-react
```

### Problem: Coverage Provider nicht gefunden
**Lösung**: Provider explizit installieren
```bash
npm install -D @vitest/coverage-v8
```

### Problem: jsdom nicht gefunden
**Lösung**: jsdom installieren
```bash
npm install -D jsdom
```

### Problem: Path Aliases funktionieren nicht
**Lösung**: tsconfig.json paths synchronisieren
```json
{
  "compilerOptions": {
    "paths": {
      "@/*": ["./apps/web/src/*"],
      "@starter-kit/*": ["./packages/*/src"]
    }
  }
}
```

## Rollback Plan
Falls Config Probleme verursacht:
```bash
mv vitest.config.ts vitest.config.ts.bak
# Zurück zur minimalen Config
```

## Zeitschätzung
- Config-Datei erstellen: 5 Minuten
- Verzeichnisse anlegen: 2 Minuten
- .gitignore updaten: 1 Minute
- Verifizierung: 3 Minuten
- **Total: 11 Minuten**

## Nächster Schritt
Nach erfolgreicher Konfiguration → [09.03 Setup Files](./09.03-setup-files.md)