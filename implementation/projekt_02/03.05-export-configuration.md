# Arbeitspaket 03.05: Export Configuration

## Ziel
Einrichtung der zentralen Export-Konfiguration für das `@starter-kit/db` Package mit allen Typen und Utilities.

## Kontext
- **Package**: `@starter-kit/db`
- **Main Entry**: `packages/db/src/index.ts`
- **Purpose**: Zentrale API für Database Package

## Implementierung

### Main Export File
Erstelle `packages/db/src/index.ts`:

```typescript
// ============================================
// Prisma Client & Types Export
// ============================================

// Re-export all Prisma generated types and enums
export * from '../generated/prisma';
export type {
  User,
  Profile,
  Session,
  Post,
  Comment,
  Tag,
  AuditLog,
  ApiKey,
  WebhookEvent,
  UserRole,
  UserStatus,
  AuditAction,
  Prisma,
  PrismaClient as PrismaClientBase,
} from '../generated/prisma';

// ============================================
// Extended Client Export
// ============================================

// Export the extended Prisma client with soft delete
export { 
  createPrismaClient,
  getPrismaClient,
  type ExtendedPrismaClient 
} from './client';

// ============================================
// Database Utilities Export
// ============================================

// Pagination utilities
export {
  getPaginationParams,
  paginate,
  type PaginationParams,
  type PaginationResult,
} from './utils';

// Audit logging utilities
export {
  createAuditLog,
  withAudit,
  type AuditLogData,
} from './utils';

// Search and filter utilities
export {
  buildSearchConditions,
  buildDateRangeFilter,
  type SearchParams,
} from './utils';

// Batch operations
export {
  processBatch,
  upsertMany,
} from './utils';

// Transaction utilities
export {
  withTransaction,
  type TransactionOptions,
} from './utils';

// Permission utilities
export {
  hasPermission,
  isOwner,
} from './utils';

// Cache utilities
export {
  getCacheKey,
} from './utils';

// ============================================
// Database Connection Helper
// ============================================

/**
 * Global database connection instance
 * Singleton pattern for Next.js compatibility
 */
let globalDb: ExtendedPrismaClient;

/**
 * Get or create database connection
 * @returns Extended Prisma Client instance
 */
export function getDb(): ExtendedPrismaClient {
  if (!globalDb) {
    globalDb = getPrismaClient();
  }
  return globalDb;
}

/**
 * Disconnect from database
 * Useful for cleanup in scripts and tests
 */
export async function disconnectDb(): Promise<void> {
  if (globalDb) {
    await globalDb.$disconnect();
  }
}

// ============================================
// Type Helpers
// ============================================

/**
 * Extract model type from Prisma namespace
 */
export type ModelName = Prisma.ModelName;

/**
 * Get model delegate type
 */
export type ModelDelegate<T extends ModelName> = 
  T extends 'User' ? Prisma.UserDelegate :
  T extends 'Profile' ? Prisma.ProfileDelegate :
  T extends 'Session' ? Prisma.SessionDelegate :
  T extends 'Post' ? Prisma.PostDelegate :
  T extends 'Comment' ? Prisma.CommentDelegate :
  T extends 'Tag' ? Prisma.TagDelegate :
  T extends 'AuditLog' ? Prisma.AuditLogDelegate :
  T extends 'ApiKey' ? Prisma.ApiKeyDelegate :
  T extends 'WebhookEvent' ? Prisma.WebhookEventDelegate :
  never;

/**
 * Input types for create operations
 */
export type CreateInput<T extends ModelName> = 
  T extends 'User' ? Prisma.UserCreateInput :
  T extends 'Profile' ? Prisma.ProfileCreateInput :
  T extends 'Session' ? Prisma.SessionCreateInput :
  T extends 'Post' ? Prisma.PostCreateInput :
  T extends 'Comment' ? Prisma.CommentCreateInput :
  T extends 'Tag' ? Prisma.TagCreateInput :
  T extends 'AuditLog' ? Prisma.AuditLogCreateInput :
  T extends 'ApiKey' ? Prisma.ApiKeyCreateInput :
  T extends 'WebhookEvent' ? Prisma.WebhookEventCreateInput :
  never;

/**
 * Input types for update operations
 */
export type UpdateInput<T extends ModelName> = 
  T extends 'User' ? Prisma.UserUpdateInput :
  T extends 'Profile' ? Prisma.ProfileUpdateInput :
  T extends 'Session' ? Prisma.SessionUpdateInput :
  T extends 'Post' ? Prisma.PostUpdateInput :
  T extends 'Comment' ? Prisma.CommentUpdateInput :
  T extends 'Tag' ? Prisma.TagUpdateInput :
  T extends 'AuditLog' ? Prisma.AuditLogUpdateInput :
  T extends 'ApiKey' ? Prisma.ApiKeyUpdateInput :
  T extends 'WebhookEvent' ? Prisma.WebhookEventUpdateInput :
  never;

/**
 * Where conditions for queries
 */
export type WhereInput<T extends ModelName> = 
  T extends 'User' ? Prisma.UserWhereInput :
  T extends 'Profile' ? Prisma.ProfileWhereInput :
  T extends 'Session' ? Prisma.SessionWhereInput :
  T extends 'Post' ? Prisma.PostWhereInput :
  T extends 'Comment' ? Prisma.CommentWhereInput :
  T extends 'Tag' ? Prisma.TagWhereInput :
  T extends 'AuditLog' ? Prisma.AuditLogWhereInput :
  T extends 'ApiKey' ? Prisma.ApiKeyWhereInput :
  T extends 'WebhookEvent' ? Prisma.WebhookEventWhereInput :
  never;

/**
 * Select fields for queries
 */
export type SelectInput<T extends ModelName> = 
  T extends 'User' ? Prisma.UserSelect :
  T extends 'Profile' ? Prisma.ProfileSelect :
  T extends 'Session' ? Prisma.SessionSelect :
  T extends 'Post' ? Prisma.PostSelect :
  T extends 'Comment' ? Prisma.CommentSelect :
  T extends 'Tag' ? Prisma.TagSelect :
  T extends 'AuditLog' ? Prisma.AuditLogSelect :
  T extends 'ApiKey' ? Prisma.ApiKeySelect :
  T extends 'WebhookEvent' ? Prisma.WebhookEventSelect :
  never;

/**
 * Include relations for queries
 */
export type IncludeInput<T extends ModelName> = 
  T extends 'User' ? Prisma.UserInclude :
  T extends 'Profile' ? Prisma.ProfileInclude :
  T extends 'Session' ? Prisma.SessionInclude :
  T extends 'Post' ? Prisma.PostInclude :
  T extends 'Comment' ? Prisma.CommentInclude :
  T extends 'Tag' ? Prisma.TagInclude :
  T extends 'AuditLog' ? Prisma.AuditLogInclude :
  T extends 'ApiKey' ? Prisma.ApiKeyInclude :
  T extends 'WebhookEvent' ? Prisma.WebhookEventInclude :
  never;

// ============================================
// Constants Export
// ============================================

/**
 * Database table names
 */
export const TABLE_NAMES = {
  USERS: 'users',
  PROFILES: 'profiles',
  SESSIONS: 'sessions',
  POSTS: 'posts',
  COMMENTS: 'comments',
  TAGS: 'tags',
  AUDIT_LOGS: 'audit_logs',
  API_KEYS: 'api_keys',
  WEBHOOK_EVENTS: 'webhook_events',
} as const;

/**
 * Default pagination settings
 */
export const PAGINATION_DEFAULTS = {
  PAGE: 1,
  LIMIT: 10,
  MAX_LIMIT: 100,
} as const;

/**
 * Session settings
 */
export const SESSION_DEFAULTS = {
  EXPIRY_DAYS: 7,
  MAX_AGE: 7 * 24 * 60 * 60 * 1000, // 7 days in ms
} as const;

/**
 * API Key settings
 */
export const API_KEY_DEFAULTS = {
  RATE_LIMIT: 1000,
  EXPIRY_DAYS: 365,
} as const;

// ============================================
// Re-export everything from utils for convenience
// ============================================

export * from './utils';
```

### TypeScript Declaration File
Erstelle `packages/db/index.d.ts`:

```typescript
// Type declarations for @starter-kit/db package
export * from './src';
```

### Package.json Main Entry
Update `packages/db/package.json`:

```json
{
  "name": "@starter-kit/db",
  "version": "1.0.0",
  "main": "./src/index.ts",
  "types": "./index.d.ts",
  "exports": {
    ".": {
      "types": "./index.d.ts",
      "import": "./src/index.ts",
      "require": "./src/index.ts"
    },
    "./client": "./src/client.ts",
    "./utils": "./src/utils.ts",
    "./generated": "./generated/prisma/index.d.ts"
  },
  "files": [
    "src",
    "generated",
    "prisma",
    "index.d.ts"
  ]
}
```

## Features

### Clean API Surface
- Alle Prisma Types re-exportiert
- Extended Client verfügbar
- Utilities organisiert exportiert
- Type Helpers für generische Operationen

### Singleton Pattern
- `getDb()` für globale Instanz
- `disconnectDb()` für Cleanup
- Next.js Hot Reload kompatibel

### Type Safety Helpers
- Generic Type Extractors
- Model-spezifische Input Types
- Where, Select, Include Types

### Constants
- Table Names
- Default Settings
- Configuration Values

## Verwendung

```typescript
// Import everything needed from one place
import {
  getDb,
  User,
  Post,
  UserRole,
  paginate,
  withAudit,
  hasPermission,
  type PaginationResult,
  type ExtendedPrismaClient,
} from '@starter-kit/db';

// Get database instance
const db = getDb();

// Use with type safety
const users: PaginationResult<User> = await paginate(db.user, {
  page: 1,
  limit: 20,
});

// Use utilities
const canEdit = hasPermission(currentUser, 'update', 'post');

// Use extended client features
const deletedUser = await db.user.findWithDeleted('123');
await db.user.restore('123');
```

## Module Resolution

```typescript
// Multiple import styles supported
import { getDb } from '@starter-kit/db';
import { ExtendedPrismaClient } from '@starter-kit/db/client';
import { paginate } from '@starter-kit/db/utils';
import { Prisma } from '@starter-kit/db/generated';
```

## Erfolgskriterien
- [ ] Clean Export API
- [ ] Alle Types verfügbar
- [ ] Utilities exportiert
- [ ] Singleton Database Instance
- [ ] Type Helpers funktionieren
- [ ] Constants verfügbar