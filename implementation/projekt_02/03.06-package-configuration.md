# Arbeitspaket 03.06: Package.json Configuration

## Ziel
Aktualisierung der package.json mit allen notwendigen Scripts, Dependencies und Konfigurationen f√ºr das Database Package.

## Kontext
- **Package**: `@starter-kit/db`
- **Location**: `packages/db/package.json`
- **Purpose**: NPM Scripts und Dependencies Setup

## Implementierung

### Complete Package.json
Update `packages/db/package.json`:

```json
{
  "name": "@starter-kit/db",
  "version": "1.0.0",
  "private": true,
  "description": "Database package with Prisma ORM for starter-kit",
  "author": "Starter Kit Team",
  "license": "MIT",
  "main": "./src/index.ts",
  "types": "./index.d.ts",
  "exports": {
    ".": {
      "types": "./index.d.ts",
      "import": "./src/index.ts",
      "require": "./src/index.ts"
    },
    "./client": {
      "types": "./src/client.ts",
      "import": "./src/client.ts",
      "require": "./src/client.ts"
    },
    "./utils": {
      "types": "./src/utils.ts",
      "import": "./src/utils.ts",
      "require": "./src/utils.ts"
    },
    "./generated": {
      "types": "./generated/prisma/index.d.ts",
      "import": "./generated/prisma/index.js",
      "require": "./generated/prisma/index.js"
    }
  },
  "files": [
    "src",
    "generated",
    "prisma",
    "index.d.ts",
    "README.md"
  ],
  "scripts": {
    "// Database Operations": "",
    "db:generate": "prisma generate",
    "db:migrate": "prisma migrate dev",
    "db:migrate:create": "prisma migrate dev --create-only",
    "db:migrate:deploy": "prisma migrate deploy",
    "db:migrate:reset": "prisma migrate reset --force",
    "db:migrate:status": "prisma migrate status",
    "db:push": "prisma db push",
    "db:pull": "prisma db pull",
    "db:seed": "tsx prisma/seed.ts",
    "db:seed:prod": "NODE_ENV=production tsx prisma/seed.ts",
    "db:studio": "prisma studio --browser none --port 5555",
    
    "// Schema Operations": "",
    "schema:format": "prisma format",
    "schema:validate": "prisma validate",
    
    "// Development": "",
    "dev": "prisma generate --watch",
    "build": "prisma generate",
    "clean": "rm -rf generated node_modules .turbo",
    
    "// Testing": "",
    "test": "vitest",
    "test:watch": "vitest --watch",
    "test:coverage": "vitest --coverage",
    "test:db": "tsx scripts/test-connection.ts",
    
    "// Linting": "",
    "lint": "eslint src --ext ts,tsx",
    "lint:fix": "eslint src --ext ts,tsx --fix",
    "typecheck": "tsc --noEmit",
    
    "// Utilities": "",
    "postinstall": "prisma generate",
    "predev": "prisma generate",
    "prebuild": "prisma generate"
  },
  "prisma": {
    "seed": "tsx prisma/seed.ts",
    "schema": "prisma/schema.prisma"
  },
  "dependencies": {
    "@prisma/client": "^5.21.0"
  },
  "devDependencies": {
    "@types/node": "^20.11.0",
    "@typescript-eslint/eslint-plugin": "^6.19.0",
    "@typescript-eslint/parser": "^6.19.0",
    "@vitest/coverage-v8": "^1.2.1",
    "dotenv": "^16.3.1",
    "dotenv-cli": "^7.3.0",
    "eslint": "^8.56.0",
    "eslint-config-prettier": "^9.1.0",
    "eslint-plugin-prettier": "^5.1.3",
    "prettier": "^3.2.4",
    "prisma": "^5.21.0",
    "tsx": "^4.7.0",
    "typescript": "^5.3.3",
    "vite": "^5.0.11",
    "vitest": "^1.2.1"
  },
  "peerDependencies": {
    "typescript": ">=5.0.0"
  },
  "engines": {
    "node": ">=18.0.0",
    "npm": ">=9.0.0"
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/your-org/starter-kit",
    "directory": "packages/db"
  },
  "keywords": [
    "database",
    "prisma",
    "postgresql",
    "orm",
    "typescript",
    "starter-kit"
  ]
}
```

### Environment Configuration
Erstelle `packages/db/.env.example`:

```env
# Database Configuration
# PostgreSQL connection string
DATABASE_URL="postgresql://user:password@localhost:5432/starter_kit_dev?schema=public"

# For production (Neon)
# DATABASE_URL="postgresql://user:password@your-neon-host.neon.tech/starter_kit?sslmode=require"

# Prisma Configuration
# Enable query logging in development
PRISMA_QUERY_LOG="query,info,warn,error"

# Shadow database for migrations (optional)
# SHADOW_DATABASE_URL="postgresql://user:password@localhost:5432/starter_kit_shadow"

# Direct URL for migrations (Neon specific)
# DIRECT_URL="postgresql://user:password@your-neon-host.neon.tech/starter_kit?sslmode=require"
```

### Test Connection Script
Erstelle `packages/db/scripts/test-connection.ts`:

```typescript
#!/usr/bin/env tsx

import { getPrismaClient } from '../src/client';
import { config } from 'dotenv';
import { resolve } from 'path';

// Load environment variables
config({ path: resolve(__dirname, '../.env') });

async function testConnection() {
  console.log('üîç Testing database connection...\n');
  
  const prisma = getPrismaClient();
  
  try {
    // Test basic connection
    await prisma.$connect();
    console.log('‚úÖ Database connection successful');
    
    // Get database version
    const result = await prisma.$queryRaw<[{ version: string }]>`
      SELECT version() as version
    `;
    console.log('üìä Database:', result[0].version.split(' ')[0]);
    
    // Count tables
    const tables = await prisma.$queryRaw<[{ count: bigint }]>`
      SELECT COUNT(*) as count 
      FROM information_schema.tables 
      WHERE table_schema = 'public'
    `;
    console.log('üìÅ Tables found:', Number(tables[0].count));
    
    // Test each model
    console.log('\nüìã Testing models:');
    
    const models = [
      { name: 'User', count: await prisma.user.count() },
      { name: 'Profile', count: await prisma.profile.count() },
      { name: 'Post', count: await prisma.post.count() },
      { name: 'Comment', count: await prisma.comment.count() },
      { name: 'Tag', count: await prisma.tag.count() },
      { name: 'Session', count: await prisma.session.count() },
      { name: 'AuditLog', count: await prisma.auditLog.count() },
      { name: 'ApiKey', count: await prisma.apiKey.count() },
      { name: 'WebhookEvent', count: await prisma.webhookEvent.count() },
    ];
    
    for (const model of models) {
      console.log(`   ${model.name}: ${model.count} records`);
    }
    
    console.log('\n‚úÖ All models accessible');
    console.log('üéâ Database connection test completed successfully!\n');
    
  } catch (error) {
    console.error('‚ùå Database connection failed:', error);
    process.exit(1);
  } finally {
    await prisma.$disconnect();
  }
}

testConnection().catch(console.error);
```

### README.md
Erstelle `packages/db/README.md`:

```markdown
# @starter-kit/db

Database package using Prisma ORM with PostgreSQL.

## Setup

1. **Install dependencies**:
   ```bash
   npm install
   ```

2. **Configure database**:
   ```bash
   cp .env.example .env
   # Edit .env with your database credentials
   ```

3. **Run migrations**:
   ```bash
   npm run db:migrate
   ```

4. **Seed database**:
   ```bash
   npm run db:seed
   ```

## Scripts

### Database Operations
- `npm run db:generate` - Generate Prisma Client
- `npm run db:migrate` - Run migrations
- `npm run db:seed` - Seed database
- `npm run db:studio` - Open Prisma Studio

### Development
- `npm run dev` - Watch mode for schema changes
- `npm run build` - Generate production client
- `npm run test:db` - Test database connection

## Usage

```typescript
import { getDb, User, paginate } from '@starter-kit/db';

const db = getDb();

// Simple query
const users = await db.user.findMany();

// With pagination
const result = await paginate(db.user, {
  page: 1,
  limit: 20,
});

// Soft delete
await db.user.delete({ where: { id: '123' } });

// Restore
await db.user.restore('123');
```

## Models

- **User** - User accounts with roles and status
- **Profile** - User profiles with settings
- **Session** - Active user sessions
- **Post** - Blog posts with tags
- **Comment** - Nested comments
- **Tag** - Content categorization
- **AuditLog** - Activity tracking
- **ApiKey** - API authentication
- **WebhookEvent** - Webhook delivery tracking

## Features

- ‚úÖ Soft delete support
- ‚úÖ Audit logging
- ‚úÖ Pagination utilities
- ‚úÖ Permission helpers
- ‚úÖ Batch operations
- ‚úÖ Transaction support
- ‚úÖ Type-safe queries

## Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| DATABASE_URL | PostgreSQL connection string | postgresql://user:pass@localhost:5432/db |
| PRISMA_QUERY_LOG | Query logging level | query,info,warn,error |
| SHADOW_DATABASE_URL | Shadow DB for migrations | postgresql://... |
| DIRECT_URL | Direct URL for Neon | postgresql://... |
```

### GitIgnore
Erstelle `packages/db/.gitignore`:

```gitignore
# Dependencies
node_modules
.pnp
.pnp.js

# Testing
coverage
.nyc_output

# Production
dist
build
generated

# Environment
.env
.env.local
.env.production
.env.*.local

# Prisma
prisma/migrations/migration_lock.toml
prisma/*.db
prisma/*.db-journal

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# OS
.DS_Store
Thumbs.db

# IDE
.vscode
.idea
*.swp
*.swo

# Turbo
.turbo

# Temporary
tmp
temp
.tmp
```

## Scripts √úbersicht

### Database Operations
- `db:generate` - Prisma Client generieren
- `db:migrate` - Migrations ausf√ºhren
- `db:migrate:create` - Migration erstellen ohne auszuf√ºhren
- `db:migrate:deploy` - Production Migrations
- `db:migrate:reset` - Datenbank zur√ºcksetzen
- `db:seed` - Test-Daten einf√ºgen
- `db:studio` - Prisma Studio √∂ffnen

### Development
- `dev` - Watch Mode f√ºr Schema √Ñnderungen
- `build` - Production Build
- `clean` - Cleanup Generated Files
- `test:db` - Verbindung testen

### Testing
- `test` - Tests ausf√ºhren
- `test:watch` - Tests im Watch Mode
- `test:coverage` - Test Coverage

## Erfolgskriterien
- [ ] Alle NPM Scripts definiert
- [ ] Dependencies vollst√§ndig
- [ ] Prisma Configuration
- [ ] Test Scripts vorhanden
- [ ] Environment Example
- [ ] Documentation (README)