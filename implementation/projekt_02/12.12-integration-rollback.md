# Sub-Task 12.12: Integration und Rollback Plan

## Ziel
Integration des AI Adapters in die bestehende Architektur und Rollback-Strategie.

## Integration Points

### 1. oRPC API Integration
```typescript
// packages/api/src/procedures/ai.ts
import { createAIAdapter } from '@starter-kit/ai-adapter';
import { z } from 'zod';
import { publicProcedure } from '../trpc';

const ai = createAIAdapter(); // Singleton

export const chatProcedure = publicProcedure
  .input(z.object({
    message: z.string(),
    model: z.enum(['gpt-4o', 'claude-3-5-sonnet', 'gemini-1.5-flash']).optional(),
    stream: z.boolean().optional()
  }))
  .mutation(async ({ input }) => {
    if (input.model) {
      ai.setProvider(getProviderForModel(input.model));
    }
    
    const response = await ai.complete({
      messages: [
        { role: 'system', content: 'You are a helpful assistant.' },
        { role: 'user', content: input.message }
      ],
      model: input.model
    });
    
    return response.choices[0].message.content;
  });
```

### 2. Next.js App Integration
```typescript
// apps/web/app/api/ai/route.ts
import { createAIAdapter } from '@starter-kit/ai-adapter';
import { NextResponse } from 'next/server';

const ai = createAIAdapter();

export async function POST(req: Request) {
  const { messages } = await req.json();
  
  const stream = ai.stream({ messages });
  
  return new Response(
    new ReadableStream({
      async start(controller) {
        for await (const chunk of stream) {
          controller.enqueue(
            new TextEncoder().encode(
              JSON.stringify(chunk) + '\n'
            )
          );
        }
        controller.close();
      }
    }),
    { headers: { 'Content-Type': 'text/event-stream' } }
  );
}
```

### 3. Environment Variables Setup
```bash
# .env
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
GOOGLE_GEMINI_API_KEY=AI...

# Fallback Priority
AI_PRIMARY_PROVIDER=openai
AI_FALLBACK_PROVIDERS=anthropic,google
```

### 4. Package.json Updates
```json
{
  "dependencies": {
    "@starter-kit/ai-adapter": "workspace:*"
  }
}
```

## Migration Path

### Phase 1: Parallel Running
```typescript
// Keep old implementation
const oldAICall = async (prompt: string) => {
  // Direct OpenAI SDK call
};

// New implementation
const newAICall = async (prompt: string) => {
  const ai = createAIAdapter();
  return ai.complete({ messages: [...] });
};

// Feature flag
const useNewAI = process.env.USE_NEW_AI_ADAPTER === 'true';
const result = useNewAI ? 
  await newAICall(prompt) : 
  await oldAICall(prompt);
```

### Phase 2: Gradual Migration
1. Start with non-critical features
2. Monitor error rates
3. Compare response quality
4. Migrate critical features
5. Remove old implementation

## Rollback Plan

### Immediate Rollback (< 5 min)
```typescript
// Environment Variable Toggle
USE_NEW_AI_ADAPTER=false

// Or Feature Flag Service
if (featureFlags.useAIAdapter) {
  // New implementation
} else {
  // Old implementation  
}
```

### Code Rollback (< 30 min)
```bash
# Git Revert
git revert HEAD
npm run build
npm run deploy

# Or specific commit
git checkout <last-stable-commit>
```

### Partial Rollback
```typescript
// Disable specific providers
const ai = createAIAdapter([
  // { provider: 'anthropic' }, // Disabled
  { provider: 'openai' },
  { provider: 'google' }
]);

// Or fallback to direct SDK
catch (error) {
  console.error('AI Adapter failed, using direct SDK');
  const openai = new OpenAI();
  return openai.chat.completions.create(...);
}
```

## Monitoring & Alerts

### Key Metrics
```typescript
// Track in your monitoring service
const metrics = {
  'ai.request.count': counter,
  'ai.request.duration': histogram,
  'ai.request.error': counter,
  'ai.provider.used': gauge,
  'ai.tokens.used': counter,
  'ai.cache.hit.rate': gauge
};
```

### Alert Conditions
- Error rate > 5%
- Latency p95 > 10s
- All providers failing
- Token budget exceeded
- Rate limit hits > threshold

## Testing Checklist

### Pre-Deployment
- [ ] Unit tests passing
- [ ] Integration tests passing
- [ ] Load test completed
- [ ] Security review done
- [ ] API keys validated

### Post-Deployment
- [ ] Health checks passing
- [ ] Metrics being collected
- [ ] Logs without errors
- [ ] Response quality verified
- [ ] Fallback working

## Rollback Triggers

### Automatic Rollback
- Error rate > 10%
- All providers down
- Response time > 30s
- Out of memory errors

### Manual Rollback Decision
- User complaints
- Response quality issues
- Cost overruns
- Security concerns

## Recovery Plan

### After Rollback
1. Analyze root cause
2. Fix identified issues
3. Add missing tests
4. Update monitoring
5. Plan re-deployment

### Communication
```typescript
// Status page update
const updateStatus = (status: 'operational' | 'degraded' | 'outage') => {
  statusPage.update({
    component: 'AI Services',
    status,
    message: status === 'degraded' ? 
      'Using fallback AI provider' : 
      undefined
  });
};
```

## Documentation Updates

### README.md
```markdown
## AI Adapter

The application uses a unified AI adapter supporting multiple providers.

### Configuration
Set your API keys in `.env`:
- OPENAI_API_KEY
- ANTHROPIC_API_KEY  
- GOOGLE_GEMINI_API_KEY

### Usage
```typescript
import { createAIAdapter } from '@starter-kit/ai-adapter';
const ai = createAIAdapter();
```
```

### API Documentation
- Endpoint changes
- New parameters
- Response format updates
- Error codes

## Verifizierung
- [ ] Integration points identified
- [ ] Migration path clear
- [ ] Rollback plan tested
- [ ] Monitoring configured
- [ ] Documentation updated

## Zeitsch√§tzung
- Integration: 20 Minuten
- Testing: 15 Minuten
- Documentation: 10 Minuten
- Total: 45 Minuten