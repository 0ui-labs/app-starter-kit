# Teilaufgabe 05.10: Verification Tests

## Ziel
Umfassende Verifizierung aller implementierten Authentication & Authorization Features.

## Zeitschätzung
20 Minuten

## Vorbedingungen
- [ ] 05.01-05.09 abgeschlossen
- [ ] Development Server läuft
- [ ] Test User Accounts erstellt

## Test Setup

### Schritt 1: Test User Accounts
Erstelle folgende Test Accounts im Clerk Dashboard:

1. **Admin User**
   - Email: admin@test.com
   - Metadata: `{ "role": "admin", "permissions": [] }`

2. **Moderator User**
   - Email: mod@test.com
   - Metadata: `{ "role": "moderator", "permissions": ["comment:moderate"] }`

3. **Regular User**
   - Email: user@test.com
   - Metadata: `{ "role": "user", "permissions": ["post:view"] }`

### Schritt 2: Test Routes Setup
Erstelle `apps/web/src/app/test-auth/page.tsx`:

```typescript
import { 
  getAuthUser, 
  getSession,
  hasRole,
  hasPermission,
  PERMISSIONS 
} from '@starter-kit/auth';

export default async function TestAuthPage() {
  const user = await getAuthUser();
  const session = await getSession();
  const isAdmin = await hasRole('admin');
  const isModerator = await hasRole('moderator');
  const canCreatePost = await hasPermission(PERMISSIONS.POST_CREATE);
  
  return (
    <div className="p-8">
      <h1 className="text-2xl font-bold mb-4">Auth System Test</h1>
      
      <section className="mb-6">
        <h2 className="text-xl font-semibold mb-2">User Info</h2>
        <pre className="bg-gray-100 p-4 rounded">
          {JSON.stringify(user, null, 2)}
        </pre>
      </section>
      
      <section className="mb-6">
        <h2 className="text-xl font-semibold mb-2">Session Info</h2>
        <pre className="bg-gray-100 p-4 rounded">
          {JSON.stringify(session, null, 2)}
        </pre>
      </section>
      
      <section className="mb-6">
        <h2 className="text-xl font-semibold mb-2">Role Checks</h2>
        <ul className="list-disc pl-5">
          <li>Is Admin: {isAdmin ? '✅' : '❌'}</li>
          <li>Is Moderator: {isModerator ? '✅' : '❌'}</li>
        </ul>
      </section>
      
      <section className="mb-6">
        <h2 className="text-xl font-semibold mb-2">Permission Checks</h2>
        <ul className="list-disc pl-5">
          <li>Can Create Post: {canCreatePost ? '✅' : '❌'}</li>
        </ul>
      </section>
    </div>
  );
}
```

## Verification Tests

### Test 1: Clerk Dashboard Configuration
- [ ] Session Token Claims konfiguriert
- [ ] User Metadata für alle Test User gesetzt
- [ ] Token enthält Metadata nach Login

**Verification:**
1. Login als admin@test.com
2. Öffne Browser DevTools > Application > Cookies
3. Dekodiere __session Cookie auf jwt.io
4. Verifiziere `metadata` Field vorhanden

### Test 2: TypeScript Definitions
- [ ] Types kompilieren ohne Fehler
- [ ] IntelliSense funktioniert
- [ ] Auto-Import verfügbar

**Verification:**
```bash
cd apps/web
npx tsc --noEmit
# Sollte ohne Fehler durchlaufen
```

### Test 3: Middleware Protection
- [ ] Public Routes zugänglich ohne Auth
- [ ] Protected Routes redirecten zu /sign-in
- [ ] Admin Routes nur für Admins
- [ ] Security Headers gesetzt

**Verification:**
```bash
# Ohne Auth
curl -I http://localhost:3004/dashboard
# Should: 307 Redirect to /sign-in

# Public Route
curl -I http://localhost:3004/api/health
# Should: 200 OK

# Security Headers
curl -I http://localhost:3004
# Should include: X-Frame-Options, X-Content-Type-Options, etc.
```

### Test 4: Auth Package Functions
- [ ] getAuthUser returns user data
- [ ] requireAuth redirects wenn nicht authenticated
- [ ] hasRole funktioniert korrekt
- [ ] hasPermission checks arbeiten

**Verification:**
1. Navigiere zu http://localhost:3004/test-auth
2. Login als verschiedene User
3. Verifiziere korrekte Daten und Checks

### Test 5: Protected Page Components
- [ ] ProtectedPage redirects ohne Auth
- [ ] AdminOnly zeigt nur für Admins
- [ ] ConditionalRender funktioniert
- [ ] Function children erhalten user data

**Verification:**
```typescript
// Test Page erstellen mit allen Components
// Testen mit verschiedenen User Roles
```

### Test 6: API Route Protection
- [ ] Unprotected Routes return 401
- [ ] Role-based Protection funktioniert
- [ ] Permission-based Protection arbeitet
- [ ] CSRF Protection aktiv

**Verification:**
```bash
# Without auth
curl http://localhost:3004/api/protected
# Should: 401 Unauthorized

# With wrong role
# Login als user@test.com, dann:
curl -X POST http://localhost:3004/api/admin/test
# Should: 403 Forbidden
```

### Test 7: Unauthorized Page
- [ ] Zeigt bei Access Denial
- [ ] User Info wird angezeigt
- [ ] Navigation Links funktionieren

**Verification:**
1. Login als user@test.com
2. Navigiere zu http://localhost:3004/admin
3. Sollte zu /unauthorized redirecten
4. Sollte User Info und Links zeigen

### Test 8: Admin Role Management
- [ ] User List lädt
- [ ] Role Updates funktionieren
- [ ] Permission Updates arbeiten
- [ ] Delete User bestätigt

**Verification:**
1. Login als admin@test.com
2. Navigiere zu /admin/users
3. Teste alle CRUD Operations

### Test 9: End-to-End User Journey

**Regular User Flow:**
1. Sign up als neuer User
2. Automatisch role: "user" zugewiesen
3. Kann auf /dashboard zugreifen
4. Kann nicht auf /admin zugreifen
5. Wird zu /unauthorized geleitet

**Admin Flow:**
1. Login als admin@test.com
2. Kann alle Routes zugreifen
3. Kann User Roles ändern
4. Kann Permissions vergeben
5. Änderungen werden nach Re-login aktiv

### Test 10: Performance & Security

**Performance:**
- [ ] Middleware adds < 50ms latency
- [ ] Auth checks cached properly
- [ ] No unnecessary re-renders

**Security:**
- [ ] CSRF Protection verhindert Cross-Site Requests
- [ ] Rate Limiting funktioniert
- [ ] Security Headers vorhanden
- [ ] Session Timeout arbeitet

## Test Checklist Summary

### Core Features ✅
- [ ] Clerk Integration funktioniert
- [ ] TypeScript Types korrekt
- [ ] Middleware Protection aktiv
- [ ] Role-based Access Control
- [ ] Permission System arbeitet
- [ ] API Protection implementiert
- [ ] UI Components funktionieren

### Advanced Features ✅
- [ ] Admin Management arbeitet
- [ ] Session Management aktiv
- [ ] CSRF Protection funktioniert
- [ ] Rate Limiting implementiert
- [ ] Security Headers gesetzt

### User Experience ✅
- [ ] Login/Logout Flow smooth
- [ ] Unauthorized Feedback klar
- [ ] Navigation angepasst an Role
- [ ] Error Messages hilfreich

## Common Issues & Fixes

### Issue: Session Claims undefined
```bash
# Fix: Logout und Login
# Clear Cookies
# Check Clerk Dashboard Config
```

### Issue: Middleware Loop
```bash
# Fix: Check publicRoutes includes /sign-in
# Verify matcher config
```

### Issue: Permission not working
```bash
# Fix: User needs re-login for token refresh
# Check publicMetadata in Clerk Dashboard
```

## Success Metrics
- Alle Tests grün ✅
- Keine TypeScript Errors
- Security Headers vorhanden
- Performance < 100ms für Auth Checks
- User können ihre zugewiesenen Bereiche nutzen

## Rollback Plan
Falls kritische Issues:
1. Entferne middleware.ts → Basic Auth only
2. Deaktiviere Advanced Features
3. Nutze Clerk Default Auth
4. Dokumentiere Issues für Fix

## Abschluss
Nach erfolgreicher Verifizierung:
- [ ] Commit alle Änderungen
- [ ] Dokumentiere Setup in README
- [ ] Erstelle Admin User Guide
- [ ] Deploy zu Staging für weitere Tests

## Nächste Schritte
- Implementiere Audit Logging
- Füge 2FA Support hinzu
- Erweitere Permission System
- Integriere mit Database für User Profiles