# Task 09.09.2: E2E Tests - Authentication Flow

## Ziel
Implementierung von End-to-End Tests für den vollständigen Authentifizierungs-Flow mit Playwright. Testen von Registrierung, Login, Logout und Passwort-Reset.

## Voraussetzungen
- Task 09.08 abgeschlossen (Playwright konfiguriert)
- Task 09.09.1 abgeschlossen (Homepage Tests)
- Clerk Authentication konfiguriert
- Test Helpers verfügbar

## Implementierung

### Schritt 1: Sign Up Flow Tests
Erstelle `e2e/auth-signup.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { TestHelpers } from './helpers/test-helpers';

test.describe('Sign Up Flow', () => {
  let helpers: TestHelpers;

  test.beforeEach(async ({ page }) => {
    helpers = new TestHelpers(page);
    await page.goto('/sign-up');
  });

  test('successful registration with email', async ({ page }) => {
    // Generate unique email
    const email = `test+${Date.now()}@example.com`;
    
    // Fill registration form
    await page.fill('[name="email"], input[type="email"]', email);
    await page.fill('[name="password"], input[type="password"]', 'TestPassword123!');
    await page.fill('[name="confirmPassword"], input[type="password"]:last-of-type', 'TestPassword123!');
    
    // Optional: Fill additional fields
    const nameField = page.locator('[name="firstName"], [name="name"]');
    if (await nameField.isVisible()) {
      await nameField.fill('Test User');
    }
    
    // Accept terms if present
    const termsCheckbox = page.locator('[name="terms"], input[type="checkbox"]');
    if (await termsCheckbox.isVisible()) {
      await termsCheckbox.check();
    }
    
    // Submit form
    await page.click('button[type="submit"], button:has-text("Sign Up")');
    
    // Should redirect to verification or dashboard
    await expect(page).toHaveURL(/\/(dashboard|verify-email|onboarding)/);
    
    // Success message should appear
    await helpers.expectToast(/Welcome|Successfully|Registered/i);
  });

  test('validation errors on invalid input', async ({ page }) => {
    // Try to submit empty form
    await page.click('button[type="submit"]');
    
    // Should show validation errors
    await expect(page.locator('text=/required|enter/i')).toBeVisible();
    
    // Test invalid email
    await page.fill('[name="email"], input[type="email"]', 'invalid-email');
    await page.click('button[type="submit"]');
    await expect(page.locator('text=/valid email|invalid/i')).toBeVisible();
    
    // Test weak password
    await page.fill('[name="email"], input[type="email"]', 'test@example.com');
    await page.fill('[name="password"], input[type="password"]', '123');
    await page.click('button[type="submit"]');
    await expect(page.locator('text=/at least|minimum|weak/i')).toBeVisible();
    
    // Test password mismatch
    await page.fill('[name="password"], input[type="password"]', 'TestPassword123!');
    await page.fill('[name="confirmPassword"], input[type="password"]:last-of-type', 'DifferentPassword123!');
    await page.click('button[type="submit"]');
    await expect(page.locator('text=/match|same/i')).toBeVisible();
  });

  test('duplicate email prevention', async ({ page }) => {
    // Use an existing email
    await page.fill('[name="email"], input[type="email"]', 'existing@example.com');
    await page.fill('[name="password"], input[type="password"]', 'TestPassword123!');
    await page.fill('[name="confirmPassword"], input[type="password"]:last-of-type', 'TestPassword123!');
    
    // Accept terms if present
    const termsCheckbox = page.locator('[name="terms"], input[type="checkbox"]');
    if (await termsCheckbox.isVisible()) {
      await termsCheckbox.check();
    }
    
    await page.click('button[type="submit"]');
    
    // Should show error
    await expect(page.locator('text=/already|exists|taken/i')).toBeVisible();
  });

  test('OAuth signup options', async ({ page }) => {
    // Check for OAuth providers
    const googleButton = page.locator('button:has-text("Google"), button[aria-label*="Google"]');
    const githubButton = page.locator('button:has-text("GitHub"), button[aria-label*="GitHub"]');
    
    // At least one OAuth provider should be available
    const hasOAuth = await googleButton.isVisible() || await githubButton.isVisible();
    expect(hasOAuth).toBeTruthy();
    
    if (await googleButton.isVisible()) {
      // Click Google button
      await googleButton.click();
      // Should redirect to Google OAuth
      await page.waitForURL(/accounts\.google\.com|clerk\..*\.com/);
    }
  });

  test('navigate to sign in', async ({ page }) => {
    // Find and click sign in link
    const signInLink = page.locator('a:has-text("Sign In"), a:has-text("Already have an account")');
    await signInLink.click();
    
    // Should navigate to sign in page
    await expect(page).toHaveURL('/sign-in');
  });
});
```

### Schritt 2: Sign In Flow Tests
Erstelle `e2e/auth-signin.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { LoginPage, TestHelpers } from './helpers/test-helpers';

test.describe('Sign In Flow', () => {
  let loginPage: LoginPage;
  let helpers: TestHelpers;

  test.beforeEach(async ({ page }) => {
    loginPage = new LoginPage(page);
    helpers = new TestHelpers(page);
    await page.goto('/sign-in');
  });

  test('successful login with valid credentials', async ({ page }) => {
    // Use test credentials
    await loginPage.login('test@example.com', 'TestPassword123!');
    
    // Should redirect to dashboard
    await expect(page).toHaveURL('/dashboard');
    
    // User menu should be visible
    await expect(page.locator('[data-testid="user-menu"], [aria-label="User menu"]')).toBeVisible();
    
    // Welcome message might appear
    await helpers.expectToast(/Welcome back|Signed in/i, { optional: true });
  });

  test('invalid credentials error', async ({ page }) => {
    // Try invalid email
    await page.fill('[name="email"], input[type="email"]', 'wrong@example.com');
    await page.fill('[name="password"], input[type="password"]', 'WrongPassword');
    await page.click('button[type="submit"]');
    
    // Should show error
    await expect(page.locator('text=/Invalid|Incorrect|Wrong/i')).toBeVisible();
    
    // Should stay on sign-in page
    await expect(page).toHaveURL('/sign-in');
  });

  test('remember me functionality', async ({ page, context }) => {
    // Check remember me checkbox
    const rememberMe = page.locator('[name="rememberMe"], input[type="checkbox"]');
    if (await rememberMe.isVisible()) {
      await rememberMe.check();
    }
    
    // Login
    await loginPage.login('test@example.com', 'TestPassword123!');
    
    // Get cookies
    const cookies = await context.cookies();
    const sessionCookie = cookies.find(c => 
      c.name.includes('session') || 
      c.name.includes('__session') || 
      c.name.includes('__client')
    );
    
    // If remember me is available, session should have longer expiry
    if (await rememberMe.isVisible()) {
      expect(sessionCookie?.expires).toBeGreaterThan(Date.now() / 1000 + 24 * 60 * 60);
    }
  });

  test('redirect to original page after login', async ({ page }) => {
    // Try to access protected page
    await page.goto('/dashboard/settings');
    
    // Should redirect to sign-in
    await expect(page).toHaveURL(/sign-in/);
    
    // URL should contain redirect parameter
    const url = new URL(page.url());
    expect(url.searchParams.get('redirect_url') || url.searchParams.get('return_to')).toBeTruthy();
    
    // Login
    await loginPage.login('test@example.com', 'TestPassword123!');
    
    // Should redirect back to original page
    await expect(page).toHaveURL('/dashboard/settings');
  });

  test('OAuth signin options', async ({ page }) => {
    // Check for OAuth providers
    const googleButton = page.locator('button:has-text("Google"), button[aria-label*="Google"]');
    const githubButton = page.locator('button:has-text("GitHub"), button[aria-label*="GitHub"]');
    
    // OAuth providers should match signup page
    const hasOAuth = await googleButton.isVisible() || await githubButton.isVisible();
    expect(hasOAuth).toBeTruthy();
  });

  test('navigate to sign up', async ({ page }) => {
    // Find and click sign up link
    const signUpLink = page.locator('a:has-text("Sign Up"), a:has-text("Create account")');
    await signUpLink.click();
    
    // Should navigate to sign up page
    await expect(page).toHaveURL('/sign-up');
  });
});
```

### Schritt 3: Password Reset Flow Tests
Erstelle `e2e/auth-password-reset.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { TestHelpers } from './helpers/test-helpers';

test.describe('Password Reset Flow', () => {
  let helpers: TestHelpers;

  test.beforeEach(async ({ page }) => {
    helpers = new TestHelpers(page);
    await page.goto('/sign-in');
  });

  test('request password reset', async ({ page }) => {
    // Click forgot password link
    await page.click('a:has-text("Forgot"), a:has-text("Reset password")');
    
    // Should navigate to password reset page
    await expect(page).toHaveURL(/forgot|reset/);
    
    // Enter email
    await page.fill('[name="email"], input[type="email"]', 'test@example.com');
    await page.click('button:has-text("Send"), button:has-text("Reset")');
    
    // Should show success message
    await expect(page.locator('text=/sent|check|email/i')).toBeVisible();
  });

  test('invalid email for reset', async ({ page }) => {
    await page.goto('/forgot-password');
    
    // Try non-existent email
    await page.fill('[name="email"], input[type="email"]', 'nonexistent@example.com');
    await page.click('button[type="submit"]');
    
    // Should still show success (security best practice)
    // or show error depending on implementation
    const success = page.locator('text=/sent|check/i');
    const error = page.locator('text=/not found|exist/i');
    
    const hasMessage = await success.isVisible() || await error.isVisible();
    expect(hasMessage).toBeTruthy();
  });

  test('reset password with token', async ({ page }) => {
    // Simulate clicking reset link with token
    const resetToken = 'test-reset-token';
    await page.goto(`/reset-password?token=${resetToken}`);
    
    // Should show password reset form
    await expect(page.locator('input[type="password"]')).toBeVisible();
    
    // Enter new password
    await page.fill('[name="password"], input[type="password"]:first-of-type', 'NewPassword123!');
    await page.fill('[name="confirmPassword"], input[type="password"]:last-of-type', 'NewPassword123!');
    
    // Submit
    await page.click('button:has-text("Reset"), button:has-text("Update")');
    
    // Should redirect to sign-in or show success
    await expect(page).toHaveURL(/sign-in|success/);
  });
});
```

### Schritt 4: Sign Out Flow Tests
Erstelle `e2e/auth-signout.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { LoginPage, TestHelpers } from './helpers/test-helpers';

test.describe('Sign Out Flow', () => {
  test.use({ storageState: 'playwright/.auth/user.json' });
  
  let helpers: TestHelpers;

  test.beforeEach(async ({ page }) => {
    helpers = new TestHelpers(page);
    await page.goto('/dashboard');
  });

  test('successful logout from user menu', async ({ page }) => {
    // Open user menu
    await page.click('[data-testid="user-menu"], [aria-label="User menu"]');
    
    // Click sign out
    await page.click('button:has-text("Sign Out"), button:has-text("Logout")');
    
    // Should redirect to homepage or sign-in
    await expect(page).toHaveURL(/^\/$|\/sign-in/);
    
    // User menu should not be visible
    await expect(page.locator('[data-testid="user-menu"]')).not.toBeVisible();
    
    // Sign in button should be visible
    await expect(page.locator('a:has-text("Sign In")')).toBeVisible();
  });

  test('session cleanup after logout', async ({ page, context }) => {
    // Get initial session cookies
    const initialCookies = await context.cookies();
    const hasSession = initialCookies.some(c => 
      c.name.includes('session') || 
      c.name.includes('__session')
    );
    expect(hasSession).toBeTruthy();
    
    // Logout
    await page.click('[data-testid="user-menu"]');
    await page.click('button:has-text("Sign Out")');
    
    // Wait for redirect
    await page.waitForURL(/^\/$|\/sign-in/);
    
    // Check cookies are cleared
    const afterCookies = await context.cookies();
    const sessionRemoved = !afterCookies.some(c => 
      c.name.includes('session') && c.value
    );
    expect(sessionRemoved).toBeTruthy();
  });

  test('cannot access protected routes after logout', async ({ page }) => {
    // Logout
    await page.click('[data-testid="user-menu"]');
    await page.click('button:has-text("Sign Out")');
    
    // Try to access dashboard
    await page.goto('/dashboard');
    
    // Should redirect to sign-in
    await expect(page).toHaveURL(/sign-in/);
  });

  test('logout from all devices option', async ({ page }) => {
    // Open user menu
    await page.click('[data-testid="user-menu"]');
    
    // Check if "Sign out all devices" option exists
    const signOutAll = page.locator('button:has-text("all devices")');
    
    if (await signOutAll.isVisible()) {
      await signOutAll.click();
      
      // Might show confirmation dialog
      const confirmButton = page.locator('button:has-text("Confirm"), button:has-text("Yes")');
      if (await confirmButton.isVisible()) {
        await confirmButton.click();
      }
      
      // Should logout and redirect
      await expect(page).toHaveURL(/^\/$|\/sign-in/);
    }
  });
});
```

## Verifizierung

### Test 1: Run Authentication Tests
```bash
npx playwright test auth-*.spec.ts
# Alle Auth Tests sollten grün sein
```

### Test 2: Test with Different Browsers
```bash
npx playwright test auth-signin.spec.ts --project=chromium
npx playwright test auth-signin.spec.ts --project=firefox
npx playwright test auth-signin.spec.ts --project=webkit
```

### Test 3: Debug Specific Test
```bash
npx playwright test auth-signup.spec.ts --debug
# Öffnet Playwright Inspector
```

## Erfolgskriterien
- [ ] Registrierung mit Email funktioniert
- [ ] Validierung zeigt korrekte Fehlermeldungen
- [ ] Duplicate Email Prevention funktioniert
- [ ] Login mit korrekten Credentials funktioniert
- [ ] Login mit falschen Credentials zeigt Fehler
- [ ] Password Reset Flow funktioniert
- [ ] Logout bereinigt Session korrekt
- [ ] OAuth Integration funktioniert (falls konfiguriert)
- [ ] Remember Me Funktion funktioniert
- [ ] Redirect nach Login funktioniert

## Wichtige Hinweise

### Clerk-spezifische Anpassungen
- Clerk verwendet eigene UI Components
- Session Management über Clerk SDK
- Multi-Factor Authentication berücksichtigen

### Test Isolation
```typescript
test.describe.serial('Auth Flow', () => {
  // Tests die aufeinander aufbauen
});

test.describe.parallel('Independent Tests', () => {
  // Tests die parallel laufen können
});
```

### Security Considerations
- Keine echten Credentials in Tests
- Test-Accounts automatisch bereinigen
- Rate Limiting berücksichtigen

## Potentielle Probleme

### Problem: Clerk Dev Instance Limits
**Lösung**: Mock Authentication für Tests
```typescript
if (process.env.CI) {
  await page.route('**/clerk.*.com/**', route => 
    route.fulfill({ status: 200, body: '{}' })
  );
}
```

### Problem: OAuth Redirects in Tests
**Lösung**: OAuth Flows mocken
```typescript
await page.route('**/accounts.google.com/**', route => {
  return route.fulfill({
    status: 302,
    headers: { Location: '/dashboard' }
  });
});
```

### Problem: Email Verification Required
**Lösung**: Test Mode in Clerk aktivieren
```typescript
// In Clerk Dashboard: Test mode aktivieren
// Oder: Email Verification für Test-Umgebung deaktivieren
```

## Zeitschätzung
- Sign Up Tests: 5 Minuten
- Sign In Tests: 5 Minuten  
- Password Reset Tests: 3 Minuten
- Sign Out Tests: 3 Minuten
- Verifizierung: 2 Minuten
- **Total: 18 Minuten**

## Nächster Schritt
Nach erfolgreichen Auth Tests → [09.09.3 Dashboard und Navigation E2E Tests](./09.09.3-e2e-dashboard-and-navigation.md)