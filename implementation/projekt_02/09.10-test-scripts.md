# Task 09.10: Test Scripts - NPM Scripts Setup

## Ziel
Konfiguration aller Test-Scripts in package.json für einfache Test-Ausführung.

## Voraussetzungen
- Task 09.01-09.09 abgeschlossen
- Vitest, Playwright und alle Test-Tools installiert

## Implementierung

### Schritt 1: Root package.json Scripts
Update `package.json` im Root:

```json
{
  "scripts": {
    // Existing scripts...
    
    // === Testing Scripts ===
    
    // Unit & Integration Tests
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:run": "vitest run",
    "test:watch": "vitest watch",
    "test:coverage": "vitest run --coverage",
    "test:coverage:ui": "vitest run --coverage && npx vite preview --outDir coverage",
    
    // E2E Tests
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:debug": "playwright test --debug",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:chrome": "playwright test --project=chromium",
    "test:e2e:firefox": "playwright test --project=firefox",
    "test:e2e:safari": "playwright test --project=webkit",
    "test:e2e:mobile": "playwright test --project='Mobile Chrome' --project='Mobile Safari'",
    
    // Test Suites
    "test:unit": "vitest run --dir packages --dir apps",
    "test:integration": "vitest run --grep integration",
    "test:components": "vitest run --dir packages/ui",
    "test:api": "vitest run --dir packages/api",
    "test:accessibility": "playwright test accessibility.spec.ts",
    
    // Combined Testing
    "test:all": "npm run test:run && npm run test:e2e",
    "test:ci": "npm run lint && npm run typecheck && npm run test:coverage && npm run test:e2e",
    
    // Test Utilities
    "test:update-snapshots": "vitest run -u",
    "test:clear-cache": "rm -rf node_modules/.vitest && rm -rf .turbo",
    "test:install-browsers": "npx playwright install --with-deps",
    
    // Test Database
    "test:db:setup": "dotenv -e .env.test -- npx prisma migrate reset --force",
    "test:db:seed": "dotenv -e .env.test -- npx prisma db seed",
    "test:db:reset": "npm run test:db:setup && npm run test:db:seed",
    
    // Reports
    "test:report": "playwright show-report",
    "test:coverage:report": "open coverage/index.html",
    
    // Type checking (if not already present)
    "typecheck": "turbo run typecheck",
    "typecheck:watch": "turbo run typecheck:watch"
  }
}
```

### Schritt 2: Turbo Configuration for Tests
Update `turbo.json`:

```json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["**/.env.*local"],
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "!.next/cache/**", "dist/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {
      "dependsOn": ["^lint"]
    },
    "test": {
      "dependsOn": ["^build"],
      "outputs": ["coverage/**"],
      "cache": false,
      "env": ["NODE_ENV", "CI"]
    },
    "test:run": {
      "dependsOn": ["^build"],
      "outputs": ["coverage/**"],
      "env": ["NODE_ENV", "CI"]
    },
    "test:coverage": {
      "dependsOn": ["^build"],
      "outputs": ["coverage/**"],
      "env": ["NODE_ENV", "CI"]
    },
    "test:e2e": {
      "dependsOn": ["build"],
      "outputs": ["test-results/**", "playwright-report/**"],
      "cache": false,
      "env": ["NODE_ENV", "CI", "PLAYWRIGHT_TEST_URL"]
    },
    "typecheck": {
      "dependsOn": ["^typecheck"]
    }
  }
}
```

### Schritt 3: Package-Level Test Scripts
Update `packages/ui/package.json`:

```json
{
  "scripts": {
    "test": "vitest",
    "test:run": "vitest run",
    "test:watch": "vitest watch",
    "test:coverage": "vitest run --coverage",
    "test:ui": "vitest --ui"
  }
}
```

Update `packages/api/package.json`:

```json
{
  "scripts": {
    "test": "vitest",
    "test:run": "vitest run",
    "test:watch": "vitest watch",
    "test:coverage": "vitest run --coverage",
    "test:integration": "vitest run --grep integration"
  }
}
```

Update `packages/db/package.json`:

```json
{
  "scripts": {
    "test": "vitest",
    "test:run": "vitest run",
    "test:migrations": "dotenv -e ../../.env.test -- npx prisma migrate dev",
    "test:seed": "dotenv -e ../../.env.test -- npx prisma db seed",
    "test:reset": "dotenv -e ../../.env.test -- npx prisma migrate reset --force"
  }
}
```

### Schritt 4: CI/CD Scripts
Erstelle `.github/workflows/test.yml`:

```yaml
name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  DATABASE_URL: postgresql://test:test@localhost:5432/test_db
  NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: pk_test_testing
  CLERK_SECRET_KEY: sk_test_testing

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
      
      - name: Run linting
        run: npm run lint
      
      - name: Run type checking
        run: npm run typecheck
      
      - name: Run unit tests
        run: npm run test:coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  e2e-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Setup database
        run: |
          npx prisma generate
          npx prisma migrate deploy
          npm run test:db:seed
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      
      - name: Build application
        run: npm run build
      
      - name: Run E2E tests
        run: npm run test:e2e
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
```

### Schritt 5: Pre-commit Hooks
Erstelle `.husky/pre-commit`:

```bash
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Run tests before commit
npm run lint
npm run typecheck
npm run test:run
```

Erstelle `.husky/pre-push`:

```bash
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Run all tests before push
npm run test:ci
```

### Schritt 6: Test Configuration Files
Erstelle `test.config.json`:

```json
{
  "testEnvironments": {
    "development": {
      "baseUrl": "http://localhost:3004",
      "database": "postgresql://dev:dev@localhost:5432/dev_db"
    },
    "test": {
      "baseUrl": "http://localhost:3004",
      "database": "postgresql://test:test@localhost:5432/test_db"
    },
    "ci": {
      "baseUrl": "http://localhost:3004",
      "database": "postgresql://test:test@localhost:5432/test_db"
    }
  },
  "coverage": {
    "threshold": {
      "global": {
        "branches": 70,
        "functions": 70,
        "lines": 70,
        "statements": 70
      }
    }
  },
  "retries": {
    "unit": 0,
    "integration": 1,
    "e2e": 2
  }
}
```

### Schritt 7: VSCode Launch Config
Update `.vscode/launch.json`:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Debug Vitest Tests",
      "runtimeExecutable": "npx",
      "runtimeArgs": [
        "vitest",
        "--run",
        "${file}"
      ],
      "console": "integratedTerminal",
      "internalConsoleOptions": "neverOpen"
    },
    {
      "type": "node",
      "request": "launch",
      "name": "Debug Playwright Test",
      "program": "${workspaceFolder}/node_modules/.bin/playwright",
      "args": ["test", "${file}", "--debug"],
      "console": "integratedTerminal",
      "internalConsoleOptions": "neverOpen"
    }
  ]
}
```

## Verifizierung

### Test 1: Unit Tests
```bash
npm run test
# Vitest sollte im Watch Mode starten
```

### Test 2: Coverage
```bash
npm run test:coverage
# Coverage Report sollte generiert werden
```

### Test 3: E2E Tests
```bash
npm run test:e2e
# Playwright Tests sollten laufen
```

### Test 4: CI Tests
```bash
npm run test:ci
# Alle Tests sollten nacheinander laufen
```

### Test 5: Test einzelner Packages
```bash
npm run test:components
npm run test:api
# Package-spezifische Tests sollten laufen
```

## Erfolgskriterien
- [ ] Alle Test-Scripts in package.json definiert
- [ ] Turbo Pipeline für Tests konfiguriert
- [ ] Package-level Test Scripts
- [ ] CI/CD Workflow erstellt
- [ ] Pre-commit/Pre-push Hooks
- [ ] Test Config Files
- [ ] VSCode Debug Config
- [ ] Scripts funktionieren korrekt
- [ ] Coverage Reports generiert
- [ ] E2E Reports verfügbar

## Wichtige Hinweise

### Script Naming Convention
- `test` - Default Test Runner (Watch Mode)
- `test:run` - Single Run
- `test:coverage` - Mit Coverage
- `test:e2e` - E2E Tests
- `test:*` - Spezifische Test Suites

### Turbo Cache
- Tests sollten nicht gecacht werden für Reliability
- Coverage Output sollte gecacht werden

### CI Optimization
- Parallel Test Execution wo möglich
- Cache Dependencies
- Fail Fast bei Errors

## Potentielle Probleme

### Problem: Scripts nicht gefunden
**Lösung**: PATH prüfen
```bash
npm run test -- --version
```

### Problem: Turbo Cache Issues
**Lösung**: Cache leeren
```bash
npm run test:clear-cache
```

### Problem: Coverage Thresholds nicht erreicht
**Lösung**: Thresholds anpassen oder mehr Tests schreiben
```json
"thresholds": {
  "branches": 60, // Temporarily lower
}
```

## Rollback Plan
Falls Scripts Probleme machen:
```bash
# Zurück zu direkten Commands
npx vitest
npx playwright test
```

## Zeitschätzung
- Root Scripts: 8 Minuten
- Turbo Config: 5 Minuten
- Package Scripts: 5 Minuten
- CI/CD Setup: 8 Minuten
- Hooks & Config: 5 Minuten
- Verifizierung: 4 Minuten
- **Total: 35 Minuten**

## Nächster Schritt
Nach erfolgreicher Script-Konfiguration → [09.11 Verifizierung](./09.11-verifizierung.md)