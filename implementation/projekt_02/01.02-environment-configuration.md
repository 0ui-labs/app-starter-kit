# Teilaufgabe 01.02: Environment Configuration

## Ziel
Erstellung der zentralen Environment Configuration Datei `env.ts` mit vollständiger Type Safety und Validation Rules für alle Environment Variables.

## Zeitschätzung
⏱️ **15 Minuten**

## Voraussetzungen
- Dependencies aus [01.01](./01.01-dependencies-installation.md) installiert
- TypeScript Kenntnisse für Schema Definition
- Verständnis von Client/Server Environment Separation in Next.js

## File Location
```
apps/web/src/env.ts
```

## Implementation Steps

### Schritt 1: Create Directory Structure
```bash
# Ensure src directory exists
mkdir -p apps/web/src
```

### Schritt 2: Create env.ts File

```typescript
import { createEnv } from "@t3-oss/env-nextjs";
import { z } from "zod";

export const env = createEnv({
  /**
   * Server-side Environment Variables
   * These are only available on the server and will never be exposed to the client
   */
  server: {
    // Database
    DATABASE_URL: z
      .string()
      .url()
      .describe("PostgreSQL connection string from Neon or local DB"),
    
    // Clerk Authentication (Server)
    CLERK_SECRET_KEY: z
      .string()
      .min(1)
      .describe("Clerk secret key for server-side authentication"),
    CLERK_WEBHOOK_SECRET: z
      .string()
      .optional()
      .describe("Webhook secret for Clerk events"),
    
    // OpenAI (Optional)
    OPENAI_API_KEY: z
      .string()
      .optional()
      .describe("OpenAI API key for AI features"),
    
    // App Configuration
    NODE_ENV: z
      .enum(["development", "production", "test"])
      .default("development"),
    PORT: z.coerce.number().default(3004),
    
    // Monitoring (Optional)
    SENTRY_DSN: z
      .string()
      .url()
      .optional()
      .describe("Sentry DSN for error tracking"),
    SENTRY_AUTH_TOKEN: z
      .string()
      .optional()
      .describe("Sentry auth token for source maps"),
    
    // Rate Limiting (Optional)
    UPSTASH_REDIS_REST_URL: z
      .string()
      .url()
      .optional()
      .describe("Upstash Redis URL for rate limiting"),
    UPSTASH_REDIS_REST_TOKEN: z
      .string()
      .optional()
      .describe("Upstash Redis token"),
  },

  /**
   * Client-side Environment Variables
   * These will be exposed to the browser - must be prefixed with NEXT_PUBLIC_
   */
  client: {
    // Clerk Authentication (Client)
    NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: z
      .string()
      .min(1)
      .describe("Clerk publishable key for client-side"),
    NEXT_PUBLIC_CLERK_SIGN_IN_URL: z
      .string()
      .default("/sign-in"),
    NEXT_PUBLIC_CLERK_SIGN_UP_URL: z
      .string()
      .default("/sign-up"),
    NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL: z
      .string()
      .default("/dashboard"),
    NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL: z
      .string()
      .default("/dashboard"),
    
    // App URL
    NEXT_PUBLIC_APP_URL: z
      .string()
      .url()
      .optional()
      .default("http://localhost:3004")
      .describe("Public app URL for meta tags and redirects"),
    
    // Feature Flags (Optional)
    NEXT_PUBLIC_ENABLE_ANALYTICS: z
      .string()
      .transform(s => s === "true")
      .default("false")
      .optional(),
  },

  /**
   * Runtime Environment
   * For Next.js >= 13.4.4, only client variables need to be destructured
   */
  experimental__runtimeEnv: {
    // Client variables must be explicitly listed
    NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY,
    NEXT_PUBLIC_CLERK_SIGN_IN_URL: process.env.NEXT_PUBLIC_CLERK_SIGN_IN_URL,
    NEXT_PUBLIC_CLERK_SIGN_UP_URL: process.env.NEXT_PUBLIC_CLERK_SIGN_UP_URL,
    NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL: process.env.NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL,
    NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL: process.env.NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL,
    NEXT_PUBLIC_APP_URL: process.env.NEXT_PUBLIC_APP_URL,
    NEXT_PUBLIC_ENABLE_ANALYTICS: process.env.NEXT_PUBLIC_ENABLE_ANALYTICS,
  },

  /**
   * Runtime validation for Docker deployments
   */
  runtimeEnv: process.env.VALIDATE_ENV_AT_RUNTIME === 'true' 
    ? process.env 
    : undefined,
    
  /**
   * Skip validation in specific environments (Docker builds, etc.)
   */
  skipValidation: 
    !!process.env.SKIP_ENV_VALIDATION || 
    process.env.DOCKER_BUILD === 'true',
  
  /**
   * Empty string handling - treat empty strings as undefined
   */
  emptyStringAsUndefined: true,
  
  /**
   * Validation error handling for different environments
   */
  onValidationError: (error: unknown) => {
    if (process.env.NODE_ENV === 'production') {
      // Log but don't crash in production (optional)
      console.error('Environment validation failed:', error);
      if (process.env.STRICT_ENV === 'true') {
        throw error;
      }
    } else {
      throw error;
    }
  },
});
```

## Schema Details

### Server Variables (Never exposed to client)
| Variable | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| DATABASE_URL | URL string | ✅ | - | PostgreSQL connection |
| CLERK_SECRET_KEY | string | ✅ | - | Clerk server auth |
| CLERK_WEBHOOK_SECRET | string | ❌ | - | Webhook validation |
| OPENAI_API_KEY | string | ❌ | - | AI features |
| NODE_ENV | enum | ✅ | development | Environment mode |
| PORT | number | ✅ | 3004 | Server port |
| SENTRY_DSN | URL string | ❌ | - | Error tracking |
| SENTRY_AUTH_TOKEN | string | ❌ | - | Source maps |
| UPSTASH_REDIS_REST_URL | URL string | ❌ | - | Rate limiting |
| UPSTASH_REDIS_REST_TOKEN | string | ❌ | - | Redis auth |

### Client Variables (Exposed to browser)
| Variable | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY | string | ✅ | - | Clerk client auth |
| NEXT_PUBLIC_CLERK_SIGN_IN_URL | string | ✅ | /sign-in | Sign in route |
| NEXT_PUBLIC_CLERK_SIGN_UP_URL | string | ✅ | /sign-up | Sign up route |
| NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL | string | ✅ | /dashboard | Post-login redirect |
| NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL | string | ✅ | /dashboard | Post-signup redirect |
| NEXT_PUBLIC_APP_URL | URL string | ❌ | http://localhost:3004 | Public app URL |
| NEXT_PUBLIC_ENABLE_ANALYTICS | boolean | ❌ | false | Analytics flag |

## Validation Features

### 1. Type Coercion
```typescript
// Automatic type coercion
PORT: z.coerce.number().default(3004),
// Converts "3004" string to 3004 number

// Boolean transformation
NEXT_PUBLIC_ENABLE_ANALYTICS: z
  .string()
  .transform(s => s === "true")
// Converts "true"/"false" strings to boolean
```

### 2. URL Validation
```typescript
DATABASE_URL: z.string().url()
// Ensures valid URL format
```

### 3. Enum Validation
```typescript
NODE_ENV: z.enum(["development", "production", "test"])
// Only allows specific values
```

### 4. Optional with Defaults
```typescript
NEXT_PUBLIC_APP_URL: z
  .string()
  .url()
  .optional()
  .default("http://localhost:3004")
// Optional but has default value
```

## TypeScript Integration

Nach der Erstellung von `env.ts` hast du vollständige Type Safety:

```typescript
import { env } from "~/env";

// AutoComplete funktioniert
env.DATABASE_URL // string
env.OPENAI_API_KEY // string | undefined
env.PORT // number

// Type Errors werden erkannt
const wrongType: number = env.DATABASE_URL; // ❌ Type Error
const notExist = env.NON_EXISTENT; // ❌ Property doesn't exist
```

## Path Alias Setup

Falls `~/env` Import nicht funktioniert, update `tsconfig.json`:

```json
{
  "compilerOptions": {
    "paths": {
      "~/*": ["./src/*"]
    }
  }
}
```

## Verification

### Test TypeScript Types
```bash
# Create test file
echo 'import { env } from "./env"; console.log(env);' > apps/web/src/test-env.ts

# Check for type errors
npx tsc --noEmit apps/web/src/test-env.ts

# Clean up
rm apps/web/src/test-env.ts
```

### Test Import
```typescript
// apps/web/src/app/page.tsx
import { env } from "~/env";

export default function Page() {
  console.log("Port:", env.PORT);
  return <div>Test</div>;
}
```

## Common Issues

### Issue: Import Path Not Found
```typescript
// If ~/env doesn't work, use relative import
import { env } from "../env";
// Or absolute from src
import { env } from "@/env";
```

### Issue: process.env is undefined
```typescript
// Ensure you're not importing in browser-only context
// Server Components: ✅ Works
// Client Components: ❌ Server vars not accessible
```

### Issue: TypeScript Errors
```bash
# Restart TypeScript server in VS Code
# Cmd+Shift+P → "TypeScript: Restart TS Server"
```

## Success Criteria
- ✅ `env.ts` File erstellt in `apps/web/src/`
- ✅ Alle Required Variables definiert
- ✅ Client/Server Separation korrekt
- ✅ TypeScript Types funktionieren
- ✅ Validation Rules implementiert

## Next Steps
Nach erfolgreicher Configuration → [01.03 Build-Time Validation](./01.03-build-time-validation.md)