# Sub-Task 12.09: Testing und Verifizierung

## Ziel
Umfassende Tests für alle Provider und Features.

## Umfang
- Provider Tests
- Fallback Tests
- Streaming Tests
- Error Handling Tests
- Integration Tests

## Test-Szenarien

### 1. Basic Completion Tests
```typescript
// Test für jeden Provider
const providers = ['openai', 'anthropic', 'google'];
for (const provider of providers) {
  const ai = createAIAdapter([{ provider }]);
  const response = await ai.complete({ messages });
  assert(response.choices[0].message.content);
}
```

### 2. Streaming Tests
```typescript
// Stream Response Collection
const chunks = [];
for await (const chunk of ai.stream(options)) {
  chunks.push(chunk);
}
assert(chunks.length > 0);
```

### 3. Fallback Tests
```typescript
// Simulate Primary Failure
const ai = createAIAdapter([
  { provider: 'invalid', apiKey: 'fake' },
  { provider: 'openai' }
]);
// Should fallback to OpenAI
```

### 4. Multi-modal Tests
```typescript
// Image Input Test
const response = await ai.complete({
  messages: [{
    role: 'user',
    content: [
      { type: 'text', text: 'Describe' },
      { type: 'image', image: { url: base64Image } }
    ]
  }]
});
```

### 5. Rate Limiting Tests
```typescript
// Parallel Requests
const promises = Array(10).fill(0).map(() => 
  ai.complete({ messages })
);
// Should handle rate limits
```

### 6. Error Handling Tests
```typescript
// Invalid API Key
try {
  const ai = createAIAdapter([{ 
    provider: 'openai', 
    apiKey: 'invalid' 
  }]);
  await ai.complete({ messages });
} catch (error) {
  assert(error.type === 'authentication');
}
```

### 7. Token Management Tests
```typescript
// Token Counting
const tokens = AIAdapter.countTokens('Hello world');
assert(tokens > 0);

// Message Truncation
const truncated = AIAdapter.truncateMessages(longMessages, 100);
assert(truncated.length < longMessages.length);
```

### 8. Embeddings Tests
```typescript
const embeddings = await ai.embed({
  input: ['test'],
  model: 'text-embedding-3-small'
});
assert(embeddings.data[0].embedding.length === 1536);
```

## Integration Tests

### Mit oRPC API
```typescript
// packages/api/src/procedures/ai.ts
import { createAIAdapter } from '@starter-kit/ai-adapter';

export const aiProcedure = publicProcedure
  .input(z.object({ message: z.string() }))
  .mutation(async ({ input }) => {
    const ai = createAIAdapter();
    const response = await ai.complete({
      messages: [{ role: 'user', content: input.message }]
    });
    return response.choices[0].message.content;
  });
```

## Verifizierung Checklist
- [ ] Alle Provider getestet
- [ ] Streaming funktioniert
- [ ] Fallback greift bei Errors
- [ ] Rate Limiting aktiv
- [ ] Multi-modal Support verifiziert
- [ ] Token Utilities arbeiten
- [ ] Error Types korrekt
- [ ] Integration mit API funktioniert

## Zeitschätzung
- 20 Minuten